# 实盘交易记录Excel组织方案

本文档提供实盘交易记录的Excel组织结构建议，帮助系统化地跟踪交易操作、持仓状态和账户表现。

## 目录

- [Excel结构概览](#excel结构概览)
- [详细表结构](#详细表结构)
  - [Sheet 1: 交易流水（Trades）](#sheet-1-交易流水trades)
  - [Sheet 2: 持仓记录（Positions）](#sheet-2-持仓记录positions)
  - [Sheet 3: 每日账户（Daily）](#sheet-3-每日账户daily)
  - [Sheet 4: 策略参数（Strategy）](#sheet-4-策略参数strategy)
  - [Sheet 5: 信号记录（Signals）](#sheet-5-信号记录signals)
- [关键字段说明](#关键字段说明)
- [Excel使用技巧](#excel使用技巧)
- [简化版本](#简化版本)

## Excel结构概览

建议使用多个工作表（sheet）来组织不同类型的数据，主要包括：

1. **交易流水**：记录每一笔买卖操作的明细
2. **持仓记录**：记录每日收盘后的持仓状态
3. **每日账户**：记录每日账户状态（类似回测的权益曲线）
4. **策略参数**：记录策略配置和调整历史
5. **信号记录**：记录策略生成的所有信号（包括未执行的）

## 详细表结构

### Sheet 1: 交易流水（Trades）

**用途**：记录每一笔买卖操作，这是最基础和重要的记录。

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| 日期 | Date | 交易日期 | 2025-11-10 |
| 时间 | Time | 交易时间 | 09:35 |
| 代码 | Text | 证券代码 | 510300 |
| 名称 | Text | 证券名称 | 沪深300ETF |
| 操作 | Text | 买入/卖出 | 买入 |
| 价格 | Number | 成交价格 | 4.256 |
| 数量 | Number | 成交数量（股） | 10000 |
| 金额 | Number | 交易金额 | 42560 |
| 手续费 | Number | 交易手续费 | 5.00 |
| 净金额 | Number | 实际资金变动 | 42565 |
| 信号来源 | Text | 触发交易的原因 | SMA金叉 |
| 备注 | Text | 特殊情况说明 | - |

**示例数据**：

| 日期 | 时间 | 代码 | 名称 | 操作 | 价格 | 数量 | 金额 | 手续费 | 净金额 | 信号来源 | 备注 |
|------|------|------|------|------|------|------|------|--------|--------|----------|------|
| 2025-11-10 | 09:35 | 510300 | 沪深300ETF | 买入 | 4.256 | 10000 | 42560 | 5.00 | 42565 | SMA金叉 | |
| 2025-11-10 | 14:55 | 159915 | 创业板ETF | 卖出 | 2.134 | 5000 | 10670 | 10.67 | 10659.33 | 止损 | 触发3连亏 |
| 2025-11-11 | 10:20 | 510500 | 中证500ETF | 买入 | 6.125 | 8000 | 49000 | 5.00 | 49005 | SMA金叉 | |

### Sheet 2: 持仓记录（Positions）

**用途**：记录每日收盘后的持仓状态，用于跟踪每只股票的盈亏情况。

| 字段 | 类型 | 说明 | 计算公式 |
|------|------|------|----------|
| 日期 | Date | 记录日期 | - |
| 代码 | Text | 证券代码 | - |
| 名称 | Text | 证券名称 | - |
| 持仓数量 | Number | 持有股数 | - |
| 成本价 | Number | 平均成本价（含手续费） | 净金额/数量 |
| 当前价 | Number | 收盘价 | - |
| 市值 | Number | 持仓市值 | 持仓数量×当前价 |
| 持仓成本 | Number | 总成本 | 成本价×持仓数量 |
| 浮动盈亏 | Number | 未实现盈亏 | 市值-持仓成本 |
| 盈亏% | Percent | 盈亏百分比 | 浮动盈亏/持仓成本 |
| 持仓天数 | Number | 持有天数 | 当前日期-买入日期 |

**示例数据**：

| 日期 | 代码 | 名称 | 持仓数量 | 成本价 | 当前价 | 市值 | 持仓成本 | 浮动盈亏 | 盈亏% | 持仓天数 |
|------|------|------|----------|--------|--------|------|----------|----------|-------|----------|
| 2025-11-10 | 510300 | 沪深300ETF | 10000 | 4.256 | 4.280 | 42800 | 42565 | 235 | 0.55% | 1 |
| 2025-11-10 | 510500 | 中证500ETF | 8000 | 6.125 | 6.150 | 49200 | 49005 | 195 | 0.40% | 5 |
| 2025-11-10 | 512690 | 酒ETF | 12000 | 1.245 | 1.260 | 15120 | 14940 | 180 | 1.20% | 3 |

### Sheet 3: 每日账户（Daily）

**用途**：记录每日账户状态，类似回测中的权益曲线，用于计算整体收益率和绘制曲线。

| 字段 | 类型 | 说明 | 计算公式 |
|------|------|------|----------|
| 日期 | Date | 记录日期 | - |
| 总资产 | Number | 总资产 | 现金+持仓市值 |
| 现金 | Number | 可用现金 | - |
| 持仓市值 | Number | 所有持仓总市值 | SUM(持仓记录.市值) |
| 当日盈亏 | Number | 当日资产变动 | 今日总资产-昨日总资产 |
| 累计盈亏 | Number | 累计盈亏金额 | 总资产-初始资金 |
| 累计收益率 | Percent | 累计收益率 | 累计盈亏/初始资金 |
| 当日操作数 | Number | 当日交易笔数 | COUNTIF(交易流水.日期,当日) |
| 备注 | Text | 重要事件记录 | - |

**示例数据**：

| 日期 | 总资产 | 现金 | 持仓市值 | 当日盈亏 | 累计盈亏 | 累计收益率 | 当日操作数 | 备注 |
|------|--------|------|----------|----------|----------|-----------|-----------|------|
| 2025-11-08 | 485600 | 235400 | 250200 | -1200 | -14400 | -2.88% | 0 | |
| 2025-11-09 | 488300 | 235400 | 252900 | 2700 | -11700 | -2.34% | 1 | 买入510300 |
| 2025-11-10 | 503650 | 203750 | 299900 | 15350 | 3650 | 0.73% | 3 | 止损159915 |
| 2025-11-11 | 508200 | 154750 | 353450 | 4550 | 8200 | 1.64% | 1 | 买入510500 |

### Sheet 4: 策略参数（Strategy）

**用途**：记录策略配置和调整历史，便于事后分析不同参数设置的效果。

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| 生效日期 | Date | 参数生效日期 | 2025-11-01 |
| 策略名称 | Text | 使用的策略 | SMA交叉 |
| 参数配置 | Text | 策略参数 | n1=10, n2=30 |
| 标的池 | Text | 交易标的范围 | 趋势ETF池 |
| 调仓频率 | Text | 检查信号频率 | 每日 |
| 单只仓位% | Percent | 单只股票最大仓位 | 20% |
| 最大持仓数 | Number | 最多持有几只 | 5 |
| 备注 | Text | 其他配置说明 | 启用连续止损保护 |

**示例数据**：

| 生效日期 | 策略名称 | 参数配置 | 标的池 | 调仓频率 | 单只仓位% | 最大持仓数 | 备注 |
|---------|----------|----------|--------|----------|-----------|-----------|------|
| 2025-11-01 | SMA交叉 | n1=10, n2=30 | 趋势ETF池 | 每日 | 20% | 5 | 启用连续止损保护(3,10) |
| 2025-11-08 | SMA交叉 | n1=10, n2=30 | 趋势ETF池 | 每日 | 25% | 4 | 提高单只仓位 |
| 2025-11-15 | MACD交叉 | fast=12, slow=26, signal=9 | 全ETF池 | 每日 | 20% | 5 | 更换策略测试 |

### Sheet 5: 信号记录（Signals）

**用途**：记录策略生成的所有信号（包括未执行的），用于分析信号质量和执行效率。

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| 日期 | Date | 信号生成日期 | 2025-11-10 |
| 代码 | Text | 证券代码 | 159915 |
| 名称 | Text | 证券名称 | 创业板ETF |
| 信号类型 | Text | 买入/卖出 | 卖出 |
| 信号价格 | Number | 信号触发时的价格 | 2.134 |
| 是否执行 | Boolean | 是/否 | 是 |
| 未执行原因 | Text | 如果未执行，原因是什么 | - |
| 备注 | Text | 其他说明 | 止损信号 |

**示例数据**：

| 日期 | 代码 | 名称 | 信号类型 | 信号价格 | 是否执行 | 未执行原因 | 备注 |
|------|------|------|----------|----------|----------|-----------|------|
| 2025-11-10 | 159915 | 创业板ETF | 卖出 | 2.134 | 是 | - | 止损信号 |
| 2025-11-10 | 512690 | 酒ETF | 买入 | 1.256 | 否 | 仓位已满 | |
| 2025-11-10 | 516160 | 新能源车 | 买入 | 0.875 | 否 | 成交量不足 | ADX<25 |
| 2025-11-11 | 510500 | 中证500ETF | 买入 | 6.125 | 是 | - | SMA金叉 |

## 关键字段说明

### 交易流水（Trades）重点

- **信号来源**：记录是什么触发了这次交易
  - 常见值：SMA金叉、SMA死叉、MACD金叉、MACD死叉、止损、手动调整、技术性卖出等
  - 这个字段对于事后分析哪种信号更有效很重要

- **净金额**：包含手续费的实际资金变动
  - 买入：净金额 = 金额 + 手续费（资金流出）
  - 卖出：净金额 = 金额 - 手续费（资金流入）

- **备注**：特殊情况说明
  - 如：触发连续止损保护、滑点较大、部分成交等

### 每日账户（Daily）重点

- **记录频率**：建议每天收盘后记录一次
- **当日操作数**：方便统计交易频率，分析过度交易问题
- **用途**：这个表可以用来绘制权益曲线，计算夏普比率、最大回撤等指标

### 信号记录（Signals）的作用

- **未执行信号分析**：记录未执行的信号，帮助分析策略改进空间
  - 如果很多好信号因为"仓位已满"而错过，可能需要调整仓位管理
  - 如果很多信号因为过滤器而被过滤，可以分析过滤器是否过严

- **执行质量评估**：对比信号价格和实际成交价格，评估执行滑点
- **信号有效性统计**：可以统计不同类型信号的胜率

## Excel使用技巧

### 1. 使用表格功能
将数据区域转换为Excel表格（Ctrl+T）：
- 自动扩展行
- 内置筛选功能
- 公式自动填充
- 结构化引用（如 `Trades[金额]` 代替 `A2:A100`）

### 2. 数据验证
为常用字段设置数据验证：
- **操作**列：下拉列表（买入、卖出）
- **信号来源**列：下拉列表（SMA金叉、SMA死叉、MACD金叉、止损、手动等）
- **是否执行**列：下拉列表（是、否）

设置方法：选中单元格 → 数据 → 数据验证 → 序列

### 3. 条件格式
使用条件格式增强可读性：
- **盈亏列**：正数绿色，负数红色
- **盈亏%列**：色阶，一目了然地看到表现好坏
- **是否执行列**："是"标绿色，"否"标黄色

### 4. 公式联动
使用公式自动计算，减少手工输入：

```excel
# 每日账户表
总资产 = 现金 + SUMIF(持仓记录[日期], 当日, 持仓记录[市值])
当日盈亏 = 总资产 - 前一日总资产
累计收益率 = (总资产 - 初始资金) / 初始资金
当日操作数 = COUNTIF(交易流水[日期], 当日)

# 持仓记录表
市值 = 持仓数量 * 当前价
浮动盈亏 = 市值 - 持仓成本
盈亏% = 浮动盈亏 / 持仓成本
```

### 5. 数据透视表
使用数据透视表进行深度分析：
- 按标的统计总收益
- 按月份统计收益
- 按信号来源统计胜率
- 按策略参数统计表现

### 6. 图表可视化
建议创建的图表：
- **权益曲线**：基于"每日账户"表的总资产列
- **月度收益柱状图**：按月汇总收益
- **持仓分布饼图**：各持仓占比
- **信号执行率**：执行vs未执行信号比例

## 简化版本

如果觉得5个表太复杂，可以只保留核心的3个表：

### 最小化配置（推荐新手）

1. **交易流水（Trades）**：必需，记录每笔交易
2. **持仓记录（Positions）**：必需，跟踪当前持仓
3. **每日账户（Daily）**：必需，计算整体收益

这3个表是核心必需的记录，能满足基本的交易跟踪和分析需求。

### 进阶配置

有经验后可以添加：
4. **策略参数（Strategy）**：记录策略调整历史
5. **信号记录（Signals）**：分析信号质量

## 实际使用流程

### 每日操作流程

1. **开盘前**：
   - 运行策略脚本生成今日信号
   - 将信号记录到"信号记录"表

2. **盘中**：
   - 根据信号执行交易
   - 每笔交易立即记录到"交易流水"表

3. **收盘后**：
   - 更新"持仓记录"表的当前价、市值、盈亏
   - 记录"每日账户"表的当日状态
   - 标注"信号记录"表中哪些执行了，哪些没执行

4. **周末或月末**：
   - 使用数据透视表分析本周/本月表现
   - 检查是否需要调整策略参数
   - 如有参数调整，记录到"策略参数"表

## 与回测系统的对应关系

| Excel表 | 回测系统对应 | 用途 |
|---------|-------------|------|
| 交易流水 | `stats['_trades']` | 每笔交易明细 |
| 持仓记录 | `broker.positions` | 当前持仓状态 |
| 每日账户 | `stats['_equity_curve']` | 权益曲线 |
| 策略参数 | `Backtest(..., params)` | 策略配置 |
| 信号记录 | 策略日志 | 信号生成记录 |

这样组织的好处是，实盘记录的结构与回测结果一致，便于对比分析：
- 回测预期 vs 实盘实际
- 找出执行差异的原因
- 验证策略在实盘中的有效性

## 进阶：Python脚本自动化

如果每日手工记录太繁琐，可以考虑编写Python脚本自动化部分流程：

```python
import pandas as pd
from datetime import datetime

# 读取信号文件
signals = pd.read_json('positions/etf_sma_cross_portfolio.json')

# 读取Excel
excel_file = 'trading_record.xlsx'
trades = pd.read_excel(excel_file, sheet_name='Trades')
positions = pd.read_excel(excel_file, sheet_name='Positions')
daily = pd.read_excel(excel_file, sheet_name='Daily')

# 自动记录信号到Signals表
# 自动更新持仓的当前价（从tushare获取）
# 自动计算每日账户状态
# ...

# 保存回Excel
with pd.ExcelWriter(excel_file, mode='a', if_sheet_exists='replace') as writer:
    trades.to_excel(writer, sheet_name='Trades', index=False)
    positions.to_excel(writer, sheet_name='Positions', index=False)
    daily.to_excel(writer, sheet_name='Daily', index=False)
```

## 附录：字段完整清单

### 交易流水（Trades）字段
- 日期、时间、代码、名称、操作、价格、数量、金额、手续费、净金额、信号来源、备注

### 持仓记录（Positions）字段
- 日期、代码、名称、持仓数量、成本价、当前价、市值、持仓成本、浮动盈亏、盈亏%、持仓天数

### 每日账户（Daily）字段
- 日期、总资产、现金、持仓市值、当日盈亏、累计盈亏、累计收益率、当日操作数、备注

### 策略参数（Strategy）字段
- 生效日期、策略名称、参数配置、标的池、调仓频率、单只仓位%、最大持仓数、备注

### 信号记录（Signals）字段
- 日期、代码、名称、信号类型、信号价格、是否执行、未执行原因、备注

---

**最后更新**：2025-11-11
**版本**：1.0
**作者**：Backtesting System
