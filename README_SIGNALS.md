# 每日交易信号生成系统

## 功能概述

每日交易信号生成系统帮助您在每天收盘后，根据策略自动分析股票池中的所有标的，生成买入/卖出信号和资金分配建议。支持持仓管理和无状态两种模式。

## 核心文件

- `generate_signals.py` - Python信号生成脚本
- `generate_daily_signals.sh` - Shell启动脚本（推荐使用）

---

## 🚀 持仓管理模式（推荐）

### 系统工作流

1. **读取持仓** → 获取当前持仓和现金
2. **生成信号** → 分析股票池（使用复权价格计算指标）
3. **增量决策** → 优先卖出（释放资金），再买入（使用释放资金）
4. **确认执行** → 用户确认后更新持仓
5. **记录交易** → 保存交易历史

### 快速开始

**1. 初始化（第一次使用）**

```bash
./generate_daily_signals.sh \
  --init 100000 \
  --portfolio-file positions/etf_sma_cross_portfolio.json
```

**2. 每日分析（推荐）**

```bash
./generate_daily_signals.sh \
  --analyze \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/etf_sma_cross_portfolio.json \
  --strategy sma_cross_enhanced \
  --load-params config/sma_strategy_params.json \
  --data-dir data/chinese_etf/daily
```

**3. 执行交易（确认后）**

```bash
./generate_daily_signals.sh \
  --execute \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/etf_sma_cross_portfolio.json \
  --strategy sma_cross_enhanced \
  --load-params config/sma_strategy_params.json \
  --data-dir data/chinese_etf/daily
```

**4. 查看持仓状态**

```bash
./generate_daily_signals.sh \
  --status \
  --portfolio-file positions/etf_sma_cross_portfolio.json \
  --data-dir data/chinese_etf/daily
```

### 交易历史文件（新增）

- 保存位置：`positions/history/`
- 文件命名：`trades_{portfolio_name}_{YYYYMMDD}.json`
  - `portfolio_name` 为 `--portfolio-file` 的文件名（去掉扩展名）
  - `YYYYMMDD` 使用 `--end-date`；若未指定则为当天日期
- 示例：`positions/history/trades_etf_macd_cross_portfolio_20251113.json`
- 目的：区分不同策略/组合的历史记录，便于长期留存与对账

读取方式（可选）：
- 代码读取：`TradeLogger(history_dir).get_trades('20251113', 'etf_macd_cross_portfolio')`
- 手工查看：直接打开对应 JSON 文件

### 持仓状态文件格式

**`positions/etf_sma_cross_portfolio.json`** - 核心状态文件

```json
{
  "cash": 35000.00,
  "positions": [
    {
      "ts_code": "159001.SZ",
      "shares": 10000,
      "entry_price": 3.25,
      "entry_date": "2025-11-06",
      "cost": 32512.50
    }
  ],
  "last_update": "2025-11-07 15:35:20"
}
```

### 输出示例

```
================================================================================
当前持仓状态
================================================================================

💰 资金信息
--------------------------------------------------------------------------------
  可用现金: ¥35,000.00
  持仓市值: ¥65,000.00
  总资产:   ¥100,000.00
  持仓盈亏: +¥2,500.00 (+4.00%)

📊 持仓明细 (2/10)
--------------------------------------------------------------------------------
  159001.SZ
    持仓数量: 10000 股
    买入价格: ¥3.25 (2025-11-06)
    当前价格: ¥3.35
    持仓成本: ¥32,512.50
    当前市值: ¥33,500.00
    盈亏:     +¥987.50 (+3.04%)

================================================================================
交易建议
================================================================================

📉 卖出操作 (1)
--------------------------------------------------------------------------------
  [1] 159001.SZ
      操作: 卖出
      价格: ¥3.35
      数量: 10000 股
      预计收入: ¥33,466.50
      原因: 死叉卖出信号！

📈 买入操作 (1)
--------------------------------------------------------------------------------
  [1] 588170.SH
      操作: 买入
      价格: ¥1.469
      数量: 3400 股
      预计成本: ¥4,995.60
      原因: 金叉买入信号！
```

---

## 参数说明

### 工作模式

| 参数 | 说明 |
|------|------|
| `--init <资金>` | 初始化持仓文件（指定初始资金） |
| `--status` | 查看当前持仓状态 |
| `--analyze` | 分析模式（生成交易建议但不执行）⭐ 推荐日常使用 |
| `--execute` | 执行模式（执行交易并更新持仓） |

### 基本参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--stock-list` | 股票列表CSV文件 ⭐ 必需 | - |
| `--portfolio-file` | 持仓文件路径（持仓管理模式必需） | - |
| `--strategy` | 策略名称 | sma_cross |
| `--positions` | 目标持仓数量 | 10 |
| `--cost-model` | 费用模型 | cn_etf |
| `--data-dir` | 数据目录 | data/csv/daily |
| `--load-params` | 从配置文件加载策略参数 | - |
| `--n1`, `--n2` | 短期和长期均线周期（覆盖配置文件） | - |

### 日期范围参数 ⭐ 重要

| 参数 | 说明 |
|------|------|
| `--start-date` | 起始日期（格式: YYYYMMDD） |
| `--end-date` | 截止日期（格式: YYYYMMDD） |
| `--lookback-days` | 回看天数（默认: 250） |

**⚠️ 关键特性：严格日期过滤（2025-11-12修复）**

系统确保严格遵守 `--end-date` 参数，**不会使用未来数据**，避免前瞻性偏差（look-ahead bias）：

- ✅ **所有价格严格截止到指定日期**：持仓当前价格、买入价格、卖出价格均使用 `end-date` 当天的收盘价
- ✅ **复权因子正确匹配**：从CSV中查找对应日期的复权因子，而非最后一行
- ✅ **信号计算准确**：均线等技术指标只使用截止日期前的历史数据
- ✅ **适用于历史回溯分析**：可用于验证过去某日的信号是否准确
- ✅ **执行模式日期对齐**：新建仓位的 `entry_date`、交易记录的 `date` 字段、交易历史文件名中的日期，均使用 `--end-date`

**使用示例**：
```bash
# 分析2024年11月11日的信号（不使用11月12日及以后的数据）
./generate_daily_signals.sh \
  --analyze \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/portfolio.json \
  --end-date 20241111 \
  --data-dir data/chinese_etf/daily
```

**技术实现**：
- 在 `load_dual_price_data()` 中，日期过滤在构建 `price_mapping` 之前执行
- 对于复权因子，通过日期匹配从原始CSV中查找对应行
- 确保 `latest_adj_price`、`latest_real_price` 都从过滤后的 DataFrame 提取

**日期范围使用规则**：
1. **同时指定start-date和end-date**：使用指定的日期范围
2. **只指定end-date**：使用指定的截止日期，起始日期由`--lookback-days`计算
3. **都不指定**：end-date为当前日期，start-date由`--lookback-days`计算（默认行为）

### 仓位管理参数 ⭐ 风险控制

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--max-position-pct` | 单仓位上限（占总资金百分比） | 0.05 (5%) |
| `--min-buy-signals` | 最小买入信号数（少于此数不买入） | 1 |

**仓位管理示例**：
- 10万资金，1个买入信号 → 买入5000元（5%），保留95%现金
- 10万资金，3个买入信号 → 每个5000元（共15%），保留85%现金
- 10万资金，10个买入信号 → 每个5000元（共50%），保留50%现金

**配置建议**：
- **积极策略（推荐）**：`--max-position-pct 0.05 --min-buy-signals 1`
- **稳健策略**：`--max-position-pct 0.08 --min-buy-signals 3`
- **保守策略**：`--max-position-pct 0.05 --min-buy-signals 5`

### 费用模型

| 模型 | 佣金 | 滑点 | 用途 |
|------|------|------|------|
| `default` | 0% | 0% | 无费用 |
| `cn_etf` | 0.01% | 0.01% | 中国ETF ⭐ 推荐 |
| `cn_stock` | 0.03% | 0.1% | 中国A股（含印花税） |
| `us_stock` | 0.1% | 0.05% | 美股 |

---

## 信号类型说明

- **BUY（买入）** - 金叉信号，短期均线上穿长期均线
- **SELL（卖出）** - 死叉信号，短期均线下穿长期均线
- **HOLD_LONG（持有多头）** - 短期均线在长期均线上方，继续持有
- **HOLD_SHORT（持有空头）** - 短期均线在长期均线下方，不建议买入

---

## 技术特性

### 双价格模式（自动处理）

- **信号计算**：使用复权价格（确保技术指标准确）
- **交易执行**：使用原始价格（符合实盘交易）
- **自动映射**：系统自动处理复权价格和原始价格的映射
- **价格差异示例**：588170.SH在2025-11-03 复权价格¥2.10，原始价格¥1.39（差异51%）

### 增量决策逻辑

系统按以下顺序执行：

1. **卖出处理**：遍历持仓，SELL信号的标的卖出，释放资金
2. **买入筛选**：从股票池中筛选BUY信号且未持有的标的，按信号强度排序
3. **可用资金计算**：当前现金 + 卖出收入 = 可用资金
4. **买入执行**：等权分配给筛选出的标的（受单仓位上限和最大持仓数约束）
5. **持仓维护**：HOLD信号的标的继续持有，不操作

### 数据要求

- **最少数据量**：至少30天（用于计算均线）
- **默认回看期**：250个交易日（约1年）
- **数据格式**：Date, Open, High, Low, Close, Volume

---

## 高级用法

### 定时任务

使用cron每天15:30自动运行（仅分析模式，发送通知）：

```bash
# 编辑crontab
crontab -e

# 添加定时任务
30 15 * * 1-5 cd /path/to/backtesting && \
  ./generate_daily_signals.sh \
    --analyze \
    --stock-list results/trend_etf_pool.csv \
    --portfolio-file positions/portfolio.json \
    --output /tmp/signals.txt && \
  mail -s "今日交易信号" your@email.com < /tmp/signals.txt
```

### 无状态模式（原有功能保留）

不使用 `--portfolio-file` 时，系统以无状态模式运行（每次独立分析）：

```bash
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool.csv \
  --cash 100000 \
  --positions 10
```

---

## 常见问题

| 问题 | 答案 |
|------|------|
| **为什么没有买入信号？** | 所有标的处于下降趋势或无金叉发生。检查数据是否已更新到最新交易日。 |
| **信号强度是什么？** | (短期均线 - 长期均线) / 长期均线 × 100%。绝对值越大，乖离越大。 |
| **为什么买入数量不是整数？** | 系统根据：资金 ÷ 持仓数 - 手续费 ÷ 价格，向下取整到100股倍数。 |
| **策略参数怎么选？** | 用 `./run_backtest.sh --optimize` 优化股票池，取收益最高的参数组合。 |
| **可以自动交易吗？** | 本系统仅生成建议，需人工审核后在券商软件中下单。 |
| **如何减少风险？** | 从小资金开始测试（1-2万），定期核对持仓与账户，监控实际表现。 |
| **指定end-date后价格为什么不对？** | ✅ 已在2025-11-12修复，系统现在严格使用指定日期的价格，不会泄露未来数据。 |

---

## ⚠️ 注意事项

1. **持仓文件与账户同步** - 每次真实交易后核对并更新，如果实际成交价格或数量不同
2. **100%成交假设** - 系统默认订单完全成交，实际需手动核对
3. **限制场景** - 不支持T+0日内交易、多账户、融资融券
4. **定期备份** - 建议用git管理 `positions/` 目录，每周备份一次
5. **从小资金开始** - 建议初始投入1-2万进行测试，监控实际表现
6. **日期参数验证** - 使用 `--end-date` 时，确保数据文件包含该日期的数据

---

## 🎯 功能验收状态

### 持仓管理系统（2025-11-08）

| 功能 | 状态 | 说明 |
|------|------|------|
| 初始化模式 (`--init`) | ✅ | 创建初始持仓文件 |
| 状态查看 (`--status`) | ✅ | 实时查看持仓和盈亏 |
| 分析模式 (`--analyze`) | ✅ | 生成交易建议（推荐用于实盘） |
| 执行模式 (`--execute`) | ✅ | 执行交易并更新持仓 |
| 盈亏计算 | ✅ | 自动计算持仓市值和盈亏百分比 |
| 增量决策 | ✅ | 基于当前持仓智能生成交易计划 |
| 向后兼容 | ✅ | 无状态模式完全保留 |
| 费用一致性 | ✅ | 与backtesting框架完全一致 |

### 方案A单仓位上限（2025-11-08）

**测试结果**: ✅ 全部通过

| 测试场景 | 预期行为 | 实际结果 | 状态 |
|---------|---------|----------|------|
| 单信号场景 | 分配≤5%资金 | 分配4.00%（受100股限制） | ✅ 通过 |
| 10信号场景 | 每个≤5%，总计≤50% | 每个≤5%，总计42.76% | ✅ 通过 |
| 最小信号数检查 | 1个信号<3个最小要求，不买入 | 正确拒绝买入 | ✅ 通过 |
| 30信号场景 | 前10个各≤5% | 前10个各4.00% | ✅ 通过 |

**关键发现**:
1. ✅ 单仓位上限功能工作正常，有效防止资金过度集中
2. ✅ 最小信号数检查正常，可控制分散程度
3. ✅ A股100股最小交易单位导致实际仓位略低于上限（正常现象）

### 日期过滤修复（2025-11-12）✨ 新增

**问题**: 使用 `--end-date` 参数时，系统仍使用CSV文件最后一行数据（未来数据），导致前瞻性偏差

**根本原因**: `load_dual_price_data()` 在日期过滤**之前**构建 `price_mapping`

**修复内容**:
1. ✅ 将日期过滤逻辑提前到价格映射构建之前
2. ✅ 从过滤后的 DataFrame 提取最新价格
3. ✅ 复权因子通过日期匹配从原始CSV查找
4. ✅ 同时修复双价格模式和单价格模式

**验证测试**:
- 测试标的：588170.SH
- 指定日期：2025-11-11
- 11月11日收盘价：¥1.469
- 11月12日收盘价：¥1.458
- **修复前**：使用 ¥1.458（错误，泄露未来数据）
- **修复后**：使用 ¥1.469（正确） ✅

**影响范围**: 所有使用 `--end-date` 参数的场景

---

## 支持与反馈

如有问题或建议，请查看：
- 项目文档：`README_BACKTESTING.md`
- ETF筛选文档：`etf_selector/README.md`
- 需求文档：`requirement_docs/`
