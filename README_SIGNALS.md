# æ¯æ—¥äº¤æ˜“ä¿¡å·ç”Ÿæˆç³»ç»Ÿ

## åŠŸèƒ½æ¦‚è¿°

æ¯æ—¥äº¤æ˜“ä¿¡å·ç”Ÿæˆç³»ç»Ÿå¸®åŠ©æ‚¨åœ¨æ¯å¤©æ”¶ç›˜åï¼Œæ ¹æ®åŒå‡çº¿ç­–ç•¥ï¼ˆæˆ–å…¶ä»–ç­–ç•¥ï¼‰è‡ªåŠ¨åˆ†æè‚¡ç¥¨æ± ä¸­çš„æ‰€æœ‰æ ‡çš„ï¼Œç”Ÿæˆä¹°å…¥/å–å‡ºä¿¡å·å’Œèµ„é‡‘åˆ†é…å»ºè®®ã€‚

## æ ¸å¿ƒæ–‡ä»¶

- `generate_signals.py` - Pythonä¿¡å·ç”Ÿæˆè„šæœ¬
- `generate_daily_signals.sh` - Shellå¯åŠ¨è„šæœ¬ï¼ˆæ¨èä½¿ç”¨ï¼‰

## å¿«é€Ÿå¼€å§‹

### 1. æ¯å¤©æ”¶ç›˜åç”Ÿæˆäº¤æ˜“ä¿¡å·

```bash
# åŸºç¡€ç”¨æ³•
./generate_daily_signals.sh --stock-list results/trend_etf_pool_20251107.csv

# æŒ‡å®šå¯ç”¨èµ„é‡‘å’Œç›®æ ‡æŒä»“æ•°
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool_20251107.csv \
  --cash 200000 \
  --positions 10

# ä¿å­˜æŠ¥å‘Šåˆ°æ–‡ä»¶
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool_20251107.csv \
  --output signals/daily_$(date +%Y%m%d).txt \
  --csv signals/signals_$(date +%Y%m%d).csv
```

### 2. ä½¿ç”¨è‡ªå®šä¹‰ç­–ç•¥å‚æ•°

```bash
# ä½¿ç”¨çŸ­æœŸ5æ—¥å‡çº¿å’Œé•¿æœŸ20æ—¥å‡çº¿
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool_20251107.csv \
  --n1 5 \
  --n2 20

# æ³¨æ„ï¼šç­–ç•¥å‚æ•°å¿…é¡»ä¸å›æµ‹æ—¶ä½¿ç”¨çš„å‚æ•°ä¸€è‡´ï¼
```

## ä¿¡å·ç±»å‹è¯´æ˜

- **BUYï¼ˆä¹°å…¥ï¼‰** - é‡‘å‰ä¿¡å·ï¼ŒçŸ­æœŸå‡çº¿ä¸Šç©¿é•¿æœŸå‡çº¿
- **SELLï¼ˆå–å‡ºï¼‰** - æ­»å‰ä¿¡å·ï¼ŒçŸ­æœŸå‡çº¿ä¸‹ç©¿é•¿æœŸå‡çº¿
- **HOLD_LONGï¼ˆæŒæœ‰å¤šå¤´ï¼‰** - çŸ­æœŸå‡çº¿åœ¨é•¿æœŸå‡çº¿ä¸Šæ–¹ï¼Œç»§ç»­æŒæœ‰
- **HOLD_SHORTï¼ˆæŒæœ‰ç©ºå¤´ï¼‰** - çŸ­æœŸå‡çº¿åœ¨é•¿æœŸå‡çº¿ä¸‹æ–¹ï¼Œä¸å»ºè®®ä¹°å…¥

## è¾“å‡ºç¤ºä¾‹

```
================================================================================
äº¤æ˜“ä¿¡å·æŠ¥å‘Š - 2025-11-07 15:35:20
================================================================================

ğŸ“Š ä¿¡å·ç»Ÿè®¡
--------------------------------------------------------------------------------
  BUY: 3 åª
  HOLD_LONG: 15 åª
  HOLD_SHORT: 82 åª

ğŸ”” ä¹°å…¥ä¿¡å·ï¼ˆé‡‘å‰ï¼‰
--------------------------------------------------------------------------------
  588170.SH
    å½“å‰ä»·æ ¼: Â¥1.234
    çŸ­æœŸå‡çº¿: 1.235
    é•¿æœŸå‡çº¿: 1.220
    ä¿¡å·å¼ºåº¦: 1.23%
    è¯´æ˜: é‡‘å‰ä¹°å…¥ä¿¡å·ï¼çŸ­æœŸå‡çº¿(10æ—¥)ä¸Šç©¿é•¿æœŸå‡çº¿(20æ—¥)

  589010.SH
    å½“å‰ä»·æ ¼: Â¥2.567
    çŸ­æœŸå‡çº¿: 2.570
    é•¿æœŸå‡çº¿: 2.550
    ä¿¡å·å¼ºåº¦: 0.78%
    è¯´æ˜: é‡‘å‰ä¹°å…¥ä¿¡å·ï¼çŸ­æœŸå‡çº¿(10æ—¥)ä¸Šç©¿é•¿æœŸå‡çº¿(20æ—¥)

ğŸ’° èµ„é‡‘åˆ†é…å»ºè®®
--------------------------------------------------------------------------------
  æ€»èµ„é‡‘: Â¥100,000.00
  åˆ†é…èµ„é‡‘: Â¥98,500.00
  å‰©ä½™èµ„é‡‘: Â¥1,500.00
  å»ºè®®æŒä»“æ•°: 3

  å…·ä½“ä¹°å…¥å»ºè®®:

  [1] 588170.SH
      ä¹°å…¥ä»·æ ¼: Â¥1.23
      ä¹°å…¥æ•°é‡: 26500 è‚¡
      é¢„è®¡æˆæœ¬: Â¥32,595.00
      ä»“ä½å æ¯”: 32.60%
      ä¿¡å·å¼ºåº¦: 1.23%

  [2] 589010.SH
      ä¹°å…¥ä»·æ ¼: Â¥2.57
      ä¹°å…¥æ•°é‡: 12800 è‚¡
      é¢„è®¡æˆæœ¬: Â¥32,896.00
      ä»“ä½å æ¯”: 32.90%
      ä¿¡å·å¼ºåº¦: 0.78%

  [3] 159366.SZ
      ä¹°å…¥ä»·æ ¼: Â¥3.45
      ä¹°å…¥æ•°é‡: 9500 è‚¡
      é¢„è®¡æˆæœ¬: Â¥32,775.00
      ä»“ä½å æ¯”: 32.78%
      ä¿¡å·å¼ºåº¦: 0.56%
```

## å‚æ•°è¯´æ˜

### åŸºæœ¬å‚æ•°ï¼ˆæ— çŠ¶æ€æ¨¡å¼ï¼‰

- `--stock-list` - è‚¡ç¥¨åˆ—è¡¨CSVæ–‡ä»¶ â­ å¿…éœ€
- `--strategy` - ç­–ç•¥åç§°ï¼ˆé»˜è®¤: sma_crossï¼‰
- `--cash` - å¯ç”¨èµ„é‡‘ï¼ˆé»˜è®¤: 100000ï¼‰
- `--positions` - ç›®æ ‡æŒä»“æ•°é‡ï¼ˆé»˜è®¤: 10ï¼‰
- `--n1`, `--n2` - çŸ­æœŸå’Œé•¿æœŸå‡çº¿å‘¨æœŸ
- `--cost-model` - è´¹ç”¨æ¨¡å‹ï¼ˆé»˜è®¤: cn_etfï¼‰
- `--data-dir` - æ•°æ®ç›®å½•ï¼ˆé»˜è®¤: data/csv/dailyï¼‰
- `--output` - æŠ¥å‘Šè¾“å‡ºæ–‡ä»¶ï¼›`--csv` - CSVè¾“å‡ºè·¯å¾„

### è´¹ç”¨æ¨¡å‹ï¼ˆç”¨äºèµ„é‡‘åˆ†é…è®¡ç®—ï¼‰

| æ¨¡å‹ | ä½£é‡‘ | æ»‘ç‚¹ | ç”¨é€” |
|------|------|------|------|
| `default` | 0% | 0% | æ— è´¹ç”¨ |
| `cn_etf` | 0.01% | 0.01% | ä¸­å›½ETF â­ æ¨è |
| `cn_stock` | 0.03% | 0.1% | ä¸­å›½Aè‚¡ï¼ˆå«å°èŠ±ç¨ï¼‰ |
| `us_stock` | 0.1% | 0.05% | ç¾è‚¡ |

## èµ„é‡‘åˆ†é…ä¸è®¡ç®—

### åˆ†é…ç­–ç•¥

ç³»ç»Ÿé‡‡ç”¨**ç­‰æƒé‡åˆ†é…**ï¼š
1. ç­›é€‰æ‰€æœ‰"BUY"ä¿¡å·çš„æ ‡çš„
2. æŒ‰ä¿¡å·å¼ºåº¦æ’åºï¼ˆå‡çº¿ä¹–ç¦»%ï¼‰
3. å–å‰ N ä¸ªæ ‡çš„ï¼ˆN = `--positions`ï¼‰
4. å¹³å‡åˆ†é…èµ„é‡‘ç»™è¿™ N ä¸ªæ ‡çš„
5. è®¡ç®—ä¹°å…¥è‚¡æ•°ï¼ˆå‘ä¸‹å–æ•´åˆ°100è‚¡å€æ•°ï¼‰

### ä¹°å…¥æ•°é‡å…¬å¼

```python
cash_per_position = total_cash / n_positions
effective_cash = cash_per_position * (1 - commission - spread)
shares = int(effective_cash / price / 100) * 100
```

### é‡è¦æ³¨æ„

- **Aè‚¡æœ€å°äº¤æ˜“å•ä½æ˜¯100è‚¡**ï¼Œç³»ç»Ÿè‡ªåŠ¨å‘ä¸‹å–æ•´
- **äº¤æ˜“æˆæœ¬å·²è®¡å…¥**ï¼Œå®é™…ä¹°å…¥é‡‘é¢ç•¥å°äºåˆ†é…èµ„é‡‘
- **ä¿¡å·å¼ºåº¦**è¶Šå¤§è¡¨ç¤ºå‡çº¿ä¹–ç¦»è¶Šå¤§ï¼ˆå‚è€ƒæŒ‡æ ‡ï¼‰

## é«˜çº§ç”¨æ³•

### å®šæ—¶ä»»åŠ¡

ä½¿ç”¨cronæ¯å¤©15:30è‡ªåŠ¨è¿è¡Œï¼š

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆæ¯ä¸ªäº¤æ˜“æ—¥15:30ï¼‰
30 15 * * 1-5 cd /path/to/backtesting && ./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool_20251107.csv \
  --output signals/daily_$(date +\%Y\%m\%d).txt \
  --csv signals/signals_$(date +\%Y\%m\%d).csv
```

### Pythonè„šæœ¬ç›´æ¥è°ƒç”¨

å¦‚æœéœ€è¦æ›´å¤šè‡ªå®šä¹‰ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨Pythonè„šæœ¬ï¼š

```bash
/home/zijunliu/miniforge3/condabin/conda run -n backtesting \
  python generate_signals.py \
  --stock-list results/trend_etf_pool_20251107.csv \
  --cash 100000 \
  --positions 10 \
  --n1 15 \
  --n2 50 \
  --data-dir data/csv/daily
```

### ç»“åˆå…¶ä»–å·¥å…·

```bash
# ç”Ÿæˆä¿¡å·å¹¶å‘é€é‚®ä»¶é€šçŸ¥
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool_20251107.csv \
  --output /tmp/signals.txt && \
  mail -s "ä»Šæ—¥äº¤æ˜“ä¿¡å·" your@email.com < /tmp/signals.txt

# ç”Ÿæˆä¿¡å·å¹¶ä¿å­˜åˆ°å†å²è®°å½•
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool_20251107.csv \
  --output signals/history/$(date +%Y%m%d).txt
```

## å¸¸è§é—®é¢˜

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| **ä¸ºä»€ä¹ˆæ²¡æœ‰ä¹°å…¥ä¿¡å·ï¼Ÿ** | æ‰€æœ‰æ ‡çš„å¤„äºä¸‹é™è¶‹åŠ¿æˆ–æ— é‡‘å‰å‘ç”Ÿã€‚æ£€æŸ¥æ•°æ®æ˜¯å¦å·²æ›´æ–°åˆ°æœ€æ–°äº¤æ˜“æ—¥ã€‚ |
| **ä¿¡å·å¼ºåº¦æ˜¯ä»€ä¹ˆï¼Ÿ** | (çŸ­æœŸå‡çº¿ - é•¿æœŸå‡çº¿) / é•¿æœŸå‡çº¿ Ã— 100%ã€‚ç»å¯¹å€¼è¶Šå¤§ï¼Œä¹–ç¦»è¶Šå¤§ã€‚ |
| **ä¸ºä»€ä¹ˆä¹°å…¥æ•°é‡ä¸æ•´æ•°ï¼Ÿ** | ç³»ç»Ÿæ ¹æ®ï¼šèµ„é‡‘ Ã· æŒä»“æ•° - æ‰‹ç»­è´¹ Ã· ä»·æ ¼ï¼Œå‘ä¸‹å–æ•´åˆ°100è‚¡å€æ•°ã€‚ |
| **ç­–ç•¥å‚æ•°æ€ä¹ˆé€‰ï¼Ÿ** | ç”¨ `./run_backtest.sh --optimize` ä¼˜åŒ–è‚¡ç¥¨æ± ï¼Œå–æ”¶ç›Šæœ€é«˜çš„å‚æ•°ç»„åˆã€‚ |
| **å¯ä»¥è‡ªåŠ¨äº¤æ˜“å—ï¼Ÿ** | æœ¬ç³»ç»Ÿä»…ç”Ÿæˆå»ºè®®ï¼Œéœ€äººå·¥å®¡æ ¸ååœ¨åˆ¸å•†è½¯ä»¶ä¸­ä¸‹å•ã€‚ |
| **å¦‚ä½•å‡å°‘é£é™©ï¼Ÿ** | ä»å°èµ„é‡‘å¼€å§‹æµ‹è¯•ï¼ˆ1-2ä¸‡ï¼‰ï¼Œå®šæœŸæ ¸å¯¹æŒä»“ä¸è´¦æˆ·ï¼Œç›‘æ§å®é™…è¡¨ç°ã€‚ |

## æŠ€æœ¯ç»†èŠ‚

### ä¿¡å·æ£€æµ‹é€»è¾‘

```python
if sma_short_prev <= sma_long_prev and sma_short > sma_long:
    signal = 'BUY'      # é‡‘å‰
elif sma_short_prev >= sma_long_prev and sma_short < sma_long:
    signal = 'SELL'     # æ­»å‰
elif sma_short > sma_long:
    signal = 'HOLD_LONG'    # å¤šå¤´æŒæœ‰
else:
    signal = 'HOLD_SHORT'   # ç©ºå¤´
```

### æ•°æ®è¦æ±‚

- **æœ€å°‘æ•°æ®é‡**ï¼šè‡³å°‘30å¤©ï¼ˆç”¨äºè®¡ç®—å‡çº¿ï¼‰
- **é»˜è®¤å›çœ‹æœŸ**ï¼š250ä¸ªäº¤æ˜“æ—¥ï¼ˆçº¦1å¹´ï¼‰
- **æ•°æ®æ ¼å¼**ï¼šDate, Open, High, Low, Close, Volume

## ğŸš€ æŒç»­äº¤æ˜“ç³»ç»Ÿï¼ˆPortfolio Managementï¼‰

### é—®é¢˜åˆ†æ

æ— çŠ¶æ€ç³»ç»Ÿæ¯æ¬¡è¿è¡Œéƒ½å‡è®¾ä»é›¶å¼€å§‹å»ºä»“ã€‚å®é™…é—®é¢˜ï¼š
- ç¬¬1å¤©ï¼šå»ºè®®ä¹°Aã€Bã€Cï¼ˆå„3.3ä¸‡ï¼‰
- ç¬¬2å¤©ï¼šAå‡ºç°å–å‡ºä¿¡å·ï¼Œä½†ç³»ç»Ÿä»å»ºè®®ä¹°Dã€Eã€Fï¼ˆå‡è®¾è¿˜æœ‰10ä¸‡ï¼‰
- âŒ **é”™è¯¯**ï¼šç³»ç»Ÿä¸çŸ¥é“å·²æŒæœ‰Aæˆ–å‰©ä½™ç°é‡‘

**è§£å†³**ï¼šå¼•å…¥æŒä»“çŠ¶æ€æ–‡ä»¶è®°å½•å½“å‰çœŸå®çŠ¶å†µï¼Œæ”¯æŒå¢é‡å†³ç­–ã€‚

### ç³»ç»Ÿå·¥ä½œæµ

1. **è¯»å–æŒä»“** â†’ è·å–å½“å‰æŒä»“å’Œç°é‡‘
2. **ç”Ÿæˆä¿¡å·** â†’ åˆ†æè‚¡ç¥¨æ± ï¼ˆä½¿ç”¨å¤æƒä»·æ ¼è®¡ç®—æŒ‡æ ‡ï¼‰
3. **å¢é‡å†³ç­–** â†’ ä¼˜å…ˆå–å‡ºï¼ˆé‡Šæ”¾èµ„é‡‘ï¼‰ï¼Œå†ä¹°å…¥ï¼ˆä½¿ç”¨é‡Šæ”¾èµ„é‡‘ï¼‰
4. **ç¡®è®¤æ‰§è¡Œ** â†’ ç”¨æˆ·ç¡®è®¤åæ›´æ–°æŒä»“
5. **è®°å½•äº¤æ˜“** â†’ ä¿å­˜äº¤æ˜“å†å²å’Œæ›´æ–°åçš„æŒä»“

#### æŒä»“çŠ¶æ€æ–‡ä»¶æ ¼å¼

**`positions/portfolio.json`** - æ ¸å¿ƒçŠ¶æ€æ–‡ä»¶

```json
{
  "cash": 35000.00,
  "positions": [
    {
      "ts_code": "159001.SZ",
      "shares": 10000,
      "entry_price": 3.25,
      "entry_date": "2025-11-06",
      "cost": 32512.50
    },
    {
      "ts_code": "510300.SH",
      "shares": 5000,
      "entry_price": 4.15,
      "entry_date": "2025-11-07",
      "cost": 20770.00
    }
  ],
  "last_update": "2025-11-07 15:35:20"
}
```

**å­—æ®µè¯´æ˜ï¼š**
- `cash`: å½“å‰å¯ç”¨ç°é‡‘
- `positions`: æŒä»“åˆ—è¡¨
  - `ts_code`: è‚¡ç¥¨ä»£ç 
  - `shares`: æŒæœ‰è‚¡æ•°
  - `entry_price`: ä¹°å…¥å‡ä»·
  - `entry_date`: å»ºä»“æ—¥æœŸ
  - `cost`: æŒä»“æˆæœ¬ï¼ˆå«æ‰‹ç»­è´¹ï¼‰
- `last_update`: æœ€åæ›´æ–°æ—¶é—´

#### å¢é‡å†³ç­–é€»è¾‘

ç³»ç»ŸæŒ‰ä»¥ä¸‹é¡ºåºæ‰§è¡Œï¼š

1. **å–å‡ºå¤„ç†**ï¼šéå†æŒä»“ï¼ŒSELLä¿¡å·çš„æ ‡çš„å–å‡ºï¼Œé‡Šæ”¾èµ„é‡‘
2. **ä¹°å…¥ç­›é€‰**ï¼šä»è‚¡ç¥¨æ± ä¸­ç­›é€‰BUYä¿¡å·ä¸”æœªæŒæœ‰çš„æ ‡çš„ï¼ŒæŒ‰ä¿¡å·å¼ºåº¦æ’åº
3. **å¯ç”¨èµ„é‡‘è®¡ç®—**ï¼šå½“å‰ç°é‡‘ + å–å‡ºæ”¶å…¥ = å¯ç”¨èµ„é‡‘
4. **ä¹°å…¥æ‰§è¡Œ**ï¼šç­‰æƒåˆ†é…ç»™ç­›é€‰å‡ºçš„æ ‡çš„ï¼ˆæœ€å¤šä¸è¶…è¿‡max_positions - å½“å‰æŒä»“æ•°ï¼‰
5. **æŒä»“ç»´æŠ¤**ï¼šHOLDä¿¡å·çš„æ ‡çš„ç»§ç»­æŒæœ‰ï¼Œä¸æ“ä½œ

#### ä½¿ç”¨æŒ‡å—

**1. åˆå§‹åŒ–ï¼ˆç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼‰**

```bash
# åˆ›å»ºåˆå§‹æŒä»“çŠ¶æ€æ–‡ä»¶
./generate_daily_signals.sh \
  --init 100000 \
  --portfolio-file positions/portfolio.json
```

è¾“å‡ºï¼š
```
âœ“ æŒä»“çŠ¶æ€å·²åˆå§‹åŒ–
  åˆå§‹èµ„é‡‘: Â¥100,000.00
  æŒä»“æ–‡ä»¶: positions/portfolio.json
```

**2. æ¯æ—¥åˆ†æï¼ˆæŸ¥çœ‹æ¨¡å¼ï¼‰**

```bash
# åˆ†æå½“å‰ä¿¡å·ï¼Œä½†ä¸æ‰§è¡Œäº¤æ˜“
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool_20251107.csv \
  --portfolio-file positions/portfolio.json \
  --analyze
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
================================================================================
å½“å‰æŒä»“çŠ¶æ€
================================================================================

ğŸ’° èµ„é‡‘ä¿¡æ¯
--------------------------------------------------------------------------------
  å¯ç”¨ç°é‡‘: Â¥35,000.00
  æŒä»“å¸‚å€¼: Â¥65,000.00
  æ€»èµ„äº§:   Â¥100,000.00
  æŒä»“ç›ˆäº: +Â¥2,500.00 (+4.00%)

ğŸ“Š æŒä»“æ˜ç»† (2/10)
--------------------------------------------------------------------------------
  159001.SZ
    æŒä»“æ•°é‡: 10000 è‚¡
    ä¹°å…¥ä»·æ ¼: Â¥3.25 (2025-11-06)
    å½“å‰ä»·æ ¼: Â¥3.35
    æŒä»“æˆæœ¬: Â¥32,512.50
    å½“å‰å¸‚å€¼: Â¥33,500.00
    ç›ˆäº:     +Â¥987.50 (+3.04%)

  510300.SH
    æŒä»“æ•°é‡: 5000 è‚¡
    ä¹°å…¥ä»·æ ¼: Â¥4.15 (2025-11-07)
    å½“å‰ä»·æ ¼: Â¥4.30
    æŒä»“æˆæœ¬: Â¥20,770.00
    å½“å‰å¸‚å€¼: Â¥21,500.00
    ç›ˆäº:     +Â¥730.00 (+3.51%)

================================================================================
äº¤æ˜“å»ºè®®
================================================================================

ğŸ“‰ å–å‡ºæ“ä½œ (1)
--------------------------------------------------------------------------------
  [1] 159001.SZ
      æ“ä½œ: å–å‡º
      ä»·æ ¼: Â¥3.35
      æ•°é‡: 10000 è‚¡
      é¢„è®¡æ”¶å…¥: Â¥33,466.50
      åŸå› : æ­»å‰å–å‡ºä¿¡å·ï¼çŸ­æœŸå‡çº¿(10æ—¥)ä¸‹ç©¿é•¿æœŸå‡çº¿(20æ—¥)

ğŸ“ˆ ä¹°å…¥æ“ä½œ (1)
--------------------------------------------------------------------------------
  [1] 588170.SH
      æ“ä½œ: ä¹°å…¥
      ä»·æ ¼: Â¥1.23
      æ•°é‡: 55600 è‚¡
      é¢„è®¡æˆæœ¬: Â¥68,388.00
      ä¿¡å·å¼ºåº¦: 1.23%
      åŸå› : é‡‘å‰ä¹°å…¥ä¿¡å·ï¼çŸ­æœŸå‡çº¿(10æ—¥)ä¸Šç©¿é•¿æœŸå‡çº¿(20æ—¥)

================================================================================
```

**3. æ‰§è¡Œäº¤æ˜“ï¼ˆæ‰§è¡Œæ¨¡å¼ï¼‰**

```bash
# ç¡®è®¤æ— è¯¯åï¼Œæ‰§è¡Œäº¤æ˜“å¹¶æ›´æ–°æŒä»“
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool_20251107.csv \
  --portfolio-file positions/portfolio.json \
  --execute
```

äº¤äº’å¼ç¡®è®¤ï¼š
```
âš ï¸  å³å°†æ‰§è¡Œäº¤æ˜“æ“ä½œï¼Œè¯·ç¡®è®¤ï¼š
  - å–å‡º 1 åªæ ‡çš„
  - ä¹°å…¥ 1 åªæ ‡çš„

æ˜¯å¦ç¡®è®¤æ‰§è¡Œï¼Ÿ(yes/no): yes

å¼€å§‹æ‰§è¡Œäº¤æ˜“...
âœ“ å–å‡º: 159001.SZ 10000è‚¡ @Â¥3.35 æ”¶å…¥Â¥33,466.50
âœ“ ä¹°å…¥: 588170.SH 55600è‚¡ @Â¥1.23 æˆæœ¬Â¥68,388.00

âœ“ æŒä»“å·²æ›´æ–°: positions/portfolio.json
âœ“ äº¤æ˜“è®°å½•å·²ä¿å­˜: positions/history/trades_20251107.json
```

**4. æŸ¥çœ‹æŒä»“ï¼ˆçŠ¶æ€æ¨¡å¼ï¼‰**

```bash
# éšæ—¶æŸ¥çœ‹å½“å‰æŒä»“çŠ¶æ€
./generate_daily_signals.sh \
  --portfolio-file positions/portfolio.json \
  --status
```

#### å®Œæ•´å‘½ä»¤å‚æ•°

```bash
./generate_daily_signals.sh \
  --stock-list <è‚¡ç¥¨æ± CSV> \              # å¿…éœ€
  --portfolio-file <æŒä»“JSON> \           # æŒä»“çŠ¶æ€æ–‡ä»¶è·¯å¾„
  --strategy <ç­–ç•¥å> \                    # é»˜è®¤sma_cross
  --n1 <çŸ­æœŸ> --n2 <é•¿æœŸ> \                # ç­–ç•¥å‚æ•°
  --max-positions <æ•°é‡> \                 # æœ€å¤§æŒä»“æ•°ï¼ˆé»˜è®¤10ï¼‰
  --cost-model <æ¨¡å‹> \                    # è´¹ç”¨æ¨¡å‹ï¼ˆé»˜è®¤cn_etfï¼‰
  [--init <åˆå§‹èµ„é‡‘>] \                    # åˆå§‹åŒ–æ¨¡å¼
  [--analyze] \                           # åˆ†ææ¨¡å¼ï¼ˆä¸æ‰§è¡Œï¼‰
  [--execute] \                           # æ‰§è¡Œæ¨¡å¼ï¼ˆæ›´æ–°æŒä»“ï¼‰
  [--status]                              # æŸ¥çœ‹æŒä»“çŠ¶æ€
```

#### å…¸å‹ä½¿ç”¨åœºæ™¯

**åœºæ™¯1ï¼šå®Œå…¨æ–°æ‰‹ç¬¬ä¸€æ¬¡ä½¿ç”¨**

```bash
# Day 0: åˆå§‹åŒ–æŒä»“ï¼ŒæŠ•å…¥10ä¸‡
./generate_daily_signals.sh --init 100000 --portfolio-file positions/portfolio.json

# Day 1: ç¬¬ä¸€å¤©æ”¶ç›˜ååˆ†æ
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/portfolio.json \
  --analyze

# ç¡®è®¤åæ‰§è¡Œ
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/portfolio.json \
  --execute
```

**åœºæ™¯2ï¼šå·²æœ‰æŒä»“ï¼Œå¯¼å…¥ç°æœ‰ä»“ä½**

```bash
# æ‰‹åŠ¨ç¼–è¾‘ positions/portfolio.jsonï¼Œå½•å…¥å½“å‰çœŸå®æŒä»“
vim positions/portfolio.json

# ç„¶åæ­£å¸¸ä½¿ç”¨
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/portfolio.json \
  --analyze
```

**åœºæ™¯3ï¼šæ¯æ—¥æ“ä½œæµç¨‹ï¼ˆæœ€å¸¸ç”¨ï¼‰**

```bash
# æ¯å¤©15:30åï¼Œä¸€é”®åˆ†æ+æ‰§è¡Œ
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/portfolio.json \
  --analyze && \
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/portfolio.json \
  --execute
```

**åœºæ™¯4ï¼šå®šæ—¶ä»»åŠ¡è‡ªåŠ¨åŒ–**

```bash
# crontabå®šæ—¶ä»»åŠ¡ï¼ˆä»…åˆ†ææ¨¡å¼ï¼Œå‘é€é€šçŸ¥ï¼‰
30 15 * * 1-5 cd /path/to/backtesting && \
  ./generate_daily_signals.sh \
    --stock-list results/trend_etf_pool.csv \
    --portfolio-file positions/portfolio.json \
    --analyze \
    --output /tmp/signals.txt && \
  mail -s "ä»Šæ—¥äº¤æ˜“ä¿¡å·" your@email.com < /tmp/signals.txt
```

#### æ–‡ä»¶ç»“æ„

```
backtesting/
â”œâ”€â”€ generate_signals.py              # ä¿¡å·ç”Ÿæˆè„šæœ¬ï¼ˆå¢å¼ºç‰ˆï¼‰
â”œâ”€â”€ generate_daily_signals.sh        # ç»Ÿä¸€å…¥å£è„šæœ¬ï¼ˆç«¯åˆ°ç«¯ï¼‰
â”œâ”€â”€ README_SIGNALS.md               # æœ¬æ–‡æ¡£
â”œâ”€â”€ positions/                       # æŒä»“ç®¡ç†ç›®å½• â­ NEW
â”‚   â”œâ”€â”€ portfolio.json              # å½“å‰æŒä»“çŠ¶æ€æ–‡ä»¶
â”‚   â””â”€â”€ history/                    # äº¤æ˜“å†å²è®°å½•
â”‚       â”œâ”€â”€ trades_20251106.json    # æ¯æ—¥äº¤æ˜“è®°å½•
â”‚       â”œâ”€â”€ trades_20251107.json
â”‚       â””â”€â”€ portfolio_backup/       # æŒä»“å¤‡ä»½ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ signals/                        # ä¿¡å·è¾“å‡ºç›®å½•
â”‚   â”œâ”€â”€ daily_20251107.txt
â”‚   â””â”€â”€ signals_20251107.csv
â””â”€â”€ data/                           # æ•°æ®ç›®å½•
    â””â”€â”€ csv/daily/
```

#### æŠ€æœ¯å®ç°è¦ç‚¹

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **æŒä»“çŠ¶æ€** | JSONæ ¼å¼å­˜å‚¨ï¼Œäººå·¥å¯è¯»ï¼Œæ¯æ¬¡äº¤æ˜“åè‡ªåŠ¨æ›´æ–° |
| **å¢é‡å†³ç­–** | ä¼˜å…ˆå–å‡ºâ†’å†ä¹°å…¥â†’è€ƒè™‘æŒä»“ä¸Šé™å’Œèµ„é‡‘çº¦æŸ |
| **äº¤æ˜“å†å²** | æ¯æ—¥è®°å½•åˆ° `positions/history/trades_YYYYMMDD.json`ï¼Œä¾¿äºå¤ç›˜ |
| **å®‰å…¨æœºåˆ¶** | æ‰§è¡Œæ¨¡å¼éœ€ç”¨æˆ·ç¡®è®¤ï¼›åˆ†ææ¨¡å¼åªè¯»ä¸å†™ï¼›çŠ¶æ€æ¨¡å¼åªæŸ¥çœ‹ |
| **é”™è¯¯å¤„ç†** | æŒä»“æ–‡ä»¶ä¸å­˜åœ¨â†’æç¤ºåˆå§‹åŒ–ï¼›ç°é‡‘ä¸è¶³â†’æ‹’ç»ä¹°å…¥ï¼›å–å‡ºä¸å­˜åœ¨æŒä»“â†’è­¦å‘Š |
| **å‘åå…¼å®¹** | ä¸ç”¨ `--portfolio-file` æ—¶è¡Œä¸ºä¸åŸç³»ç»Ÿä¸€è‡´ï¼›å¯æ¸è¿›å¼å‡çº§ |

#### åŒä»·æ ¼æ¨¡å¼ï¼ˆè‡ªåŠ¨å¤„ç†ï¼‰

- **ä¿¡å·è®¡ç®—**ï¼šä½¿ç”¨å¤æƒä»·æ ¼ï¼ˆç¡®ä¿æŠ€æœ¯æŒ‡æ ‡å‡†ç¡®ï¼‰
- **äº¤æ˜“æ‰§è¡Œ**ï¼šä½¿ç”¨åŸå§‹ä»·æ ¼ï¼ˆç¬¦åˆå®ç›˜äº¤æ˜“ï¼‰
- **è‡ªåŠ¨æ˜ å°„**ï¼šç³»ç»Ÿè‡ªåŠ¨å¤„ç†å¤æƒä»·æ ¼å’ŒåŸå§‹ä»·æ ¼çš„æ˜ å°„
- **ä»·æ ¼å·®å¼‚ç¤ºä¾‹**ï¼š588170.SHåœ¨2025-11-03 å¤æƒä»·æ ¼Â¥2.10ï¼ŒåŸå§‹ä»·æ ¼Â¥1.39ï¼ˆå·®å¼‚51%ï¼‰

---

## ğŸ¯ ç³»ç»ŸéªŒæ”¶çŠ¶æ€

**éªŒæ”¶æ—¥æœŸ**: 2025-11-08

### åŠŸèƒ½éªŒè¯

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| åˆå§‹åŒ–æ¨¡å¼ (`--init`) | âœ… | åˆ›å»ºåˆå§‹æŒä»“æ–‡ä»¶ |
| çŠ¶æ€æŸ¥çœ‹ (`--status`) | âœ… | å®æ—¶æŸ¥çœ‹æŒä»“å’Œç›ˆäº |
| åˆ†ææ¨¡å¼ (`--analyze`) | âœ… | ç”Ÿæˆäº¤æ˜“å»ºè®®ï¼ˆæ¨èç”¨äºå®ç›˜ï¼‰ |
| æ‰§è¡Œæ¨¡å¼ (`--execute`) | âœ… | æ‰§è¡Œäº¤æ˜“å¹¶æ›´æ–°æŒä»“ï¼ˆåŒä»·æ ¼æ¨¡å¼å·²ä¿®å¤ï¼‰ |
| ç›ˆäºè®¡ç®— | âœ… | è‡ªåŠ¨è®¡ç®—æŒä»“å¸‚å€¼å’Œç›ˆäºç™¾åˆ†æ¯” |
| å¢é‡å†³ç­– | âœ… | åŸºäºå½“å‰æŒä»“æ™ºèƒ½ç”Ÿæˆäº¤æ˜“è®¡åˆ’ |
| å‘åå…¼å®¹ | âœ… | æ— çŠ¶æ€æ¨¡å¼å®Œå…¨ä¿ç•™ |
| è´¹ç”¨ä¸€è‡´æ€§ | âœ… | ä¸backtestingæ¡†æ¶å®Œå…¨ä¸€è‡´ |

### æ¨èä½¿ç”¨æ–¹å¼

**æ–¹å¼1: åˆ†ææ¨¡å¼ï¼ˆæ¨èï¼‰**
```bash
./generate_daily_signals.sh --analyze \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/portfolio.json
```

**æ–¹å¼2: åˆ†æ+æ‰§è¡Œï¼ˆè‡ªåŠ¨åŒ–ï¼‰**
```bash
./generate_daily_signals.sh --analyze ... && \
./generate_daily_signals.sh --execute ...
```

**æ–¹å¼3: æ— çŠ¶æ€æ¨¡å¼ï¼ˆåŸæœ‰åŠŸèƒ½ä¿ç•™ï¼‰**
```bash
./generate_daily_signals.sh --stock-list pool.csv --cash 100000
```

### æ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦æé†’ï¼š**

1. **æŒä»“æ–‡ä»¶ä¸è´¦æˆ·åŒæ­¥** - æ¯æ¬¡çœŸå®äº¤æ˜“åæ ¸å¯¹å¹¶æ›´æ–°ï¼Œå¦‚æœå®é™…æˆäº¤ä»·æ ¼æˆ–æ•°é‡ä¸åŒ
2. **100%æˆäº¤å‡è®¾** - ç³»ç»Ÿé»˜è®¤è®¢å•å®Œå…¨æˆäº¤ï¼Œå®é™…éœ€æ‰‹åŠ¨æ ¸å¯¹
3. **é™åˆ¶åœºæ™¯** - ä¸æ”¯æŒT+0æ—¥å†…äº¤æ˜“ã€å¤šè´¦æˆ·ã€èèµ„èåˆ¸
4. **å®šæœŸå¤‡ä»½** - å»ºè®®ç”¨gitç®¡ç† `positions/` ç›®å½•ï¼Œæ¯å‘¨å¤‡ä»½ä¸€æ¬¡
5. **ä»å°èµ„é‡‘å¼€å§‹** - å»ºè®®åˆå§‹æŠ•å…¥1-2ä¸‡è¿›è¡Œæµ‹è¯•ï¼Œç›‘æ§å®é™…è¡¨ç°

## æ”¯æŒä¸åé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æŸ¥çœ‹ï¼š
- é¡¹ç›®æ–‡æ¡£ï¼š`README_BACKTESTING.md`
- å›æµ‹æ–‡æ¡£ï¼š`README_BACKTESTING.md`
- ETFç­›é€‰æ–‡æ¡£ï¼š`etf_selector/README.md`


---

## ä¼˜åŒ–ç‚¹ï¼šæœªå¹³ä»“äº¤æ˜“è­¦å‘Šçš„å¤„ç†

### é—®é¢˜ç°è±¡
æ‰§è¡Œè„šæœ¬æ—¶å‡ºç°å¤§é‡æ—¥å¿—è¾“å‡ºï¼š
- è¿›åº¦æ¡: `Backtest.run:   0%|          | 0/120 [00:00<?, ?bar/s]`
- è­¦å‘Š: `UserWarning: Some trades remain open at the end of backtest. Use Backtest(..., finalize_trades=True)...`

### è°ƒæŸ¥ç»“è®º

#### 1. æœªå¹³ä»“äº¤æ˜“äº§ç”ŸåŸå› 
- å›æµ‹ç»“æŸæ—¶ï¼Œç­–ç•¥ä»æŒæœ‰ä»“ä½ï¼ˆæœ€åä¸€å¤©æ²¡æœ‰è§¦å‘å¹³ä»“ä¿¡å·ï¼‰
- æœªè®¾ç½® `finalize_trades=True` å‚æ•°
- **è¿™æ˜¯æ­£å¸¸ç°è±¡**ï¼Œå°¤å…¶åœ¨åŒå‡çº¿ç­–ç•¥ä¸­ï¼ˆæœ€åæŒæœ‰å¤šå¤´/ç©ºå¤´ï¼‰

#### 2. å¯¹å®ç›˜ä¿¡å·çš„å½±å“
**ç»“è®ºï¼šâœ… ä¸å½±å“å®ç›˜ä¿¡å·ç”Ÿæˆçš„å‡†ç¡®æ€§**

åŸå› ï¼š
- `generate_signals.py` ä¿¡å·ç”Ÿæˆå®Œå…¨åŸºäºæŒ‡æ ‡å€¼ï¼ˆå‡çº¿äº¤å‰ï¼‰
- ä¸ä¾èµ–äº `position` çŠ¶æ€æˆ– `trades` æŒä»“
- éªŒè¯æµ‹è¯•æ˜¾ç¤ºï¼šfinalize_trades=False/True ä¸‹ä¿¡å·100%ä¸€è‡´

å…³é”®ä»£ç ï¼ˆgenerate_signals.py:196-227ï¼‰ï¼š
```python
# åªä½¿ç”¨æŒ‡æ ‡å€¼åˆ¤æ–­ä¿¡å·
sma_short = strategy.sma1[-1]
sma_long = strategy.sma2[-1]

if sma_short_prev <= sma_long_prev and sma_short > sma_long:
    result['signal'] = 'BUY'  # é‡‘å‰
elif sma_short_prev >= sma_long_prev and sma_short < sma_long:
    result['signal'] = 'SELL'  # æ­»å‰
```

#### 3. finalize_trades å‚æ•°è¯´æ˜

| å‚æ•°å€¼ | è¡Œä¸º | é€‚ç”¨åœºæ™¯ |
|--------|------|----------|
| Falseï¼ˆé»˜è®¤ï¼‰ | ä¸å¼ºåˆ¶å¹³ä»“ï¼Œæœªå¹³ä»“äº¤æ˜“ä¸è®¡å…¥ç»Ÿè®¡ | å®ç›˜ä¿¡å·ç”Ÿæˆ |
| True | è‡ªåŠ¨å¹³ä»“æ‰€æœ‰æœªå¹³ä»“äº¤æ˜“ï¼Œå®Œæ•´ç»Ÿè®¡ | å›æµ‹åˆ†æã€å‚æ•°ä¼˜åŒ– |

#### 4. å®æ–½çš„è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šå®ç›˜ä¿¡å·ç”Ÿæˆï¼ˆgenerate_signals.pyï¼‰**
```python
import os
import warnings

# ç¦ç”¨è¿›åº¦æ¡ï¼ˆåœ¨å¯¼å…¥backtestingä¹‹å‰ï¼‰
os.environ['BACKTESTING_DISABLE_PROGRESS'] = 'true'

# è¿‡æ»¤æœªå¹³ä»“è­¦å‘Š
warnings.filterwarnings('ignore', message='.*Some trades remain open.*')
warnings.filterwarnings('ignore', category=UserWarning, module='backtesting')
```

- âœ… å‡å°‘æ—¥å¿—å™ªéŸ³ï¼Œä¸å½±å“ä¿¡å·å‡†ç¡®æ€§
- âœ… å‡å°‘è®¡ç®—å¼€é”€ï¼ˆä¸éœ€è¦å¼ºåˆ¶å¹³ä»“ï¼‰

**æ–¹æ¡ˆBï¼šå›æµ‹ç»Ÿè®¡åˆ†æï¼ˆbacktest_runner.pyï¼‰**
```python
bt = Backtest(
    data,
    strategy_class,
    cash=cash,
    commission=cost_calculator,
    finalize_trades=True,  # âœ… ç¡®ä¿ç»Ÿè®¡å‡†ç¡®
)
```

- âœ… è·å¾—å®Œæ•´çš„äº¤æ˜“ç»Ÿè®¡ï¼ˆåŒ…å«æœ€åä¸€ç¬”äº¤æ˜“ï¼‰
- âœ… ç¡®ä¿å‚æ•°ä¼˜åŒ–åŸºäºå‡†ç¡®æ•°æ®

#### 5. éªŒè¯æµ‹è¯•
åˆ›å»ºäº†æµ‹è¯•è„šæœ¬éªŒè¯æ–¹æ¡ˆï¼š
```bash
# æµ‹è¯•æ—¥å¿—æŠ‘åˆ¶
python test_quiet_backtest.py

# éªŒè¯ä¿¡å·ä¸€è‡´æ€§ï¼ˆGOOGæ•°æ® + åˆæˆæ•°æ®ï¼‰
python investigate_open_trades.py
```

ç»“æœï¼š
- âœ… æ— è¿›åº¦æ¡å’Œè­¦å‘Šè¾“å‡º
- âœ… ä¿¡å·åœ¨ finalize_trades=False/True ä¸‹å®Œå…¨ä¸€è‡´
- âœ… æœªå¹³ä»“äº¤æ˜“ä¸å½±å“æŒ‡æ ‡è®¡ç®—

#### 6. æœ€ä½³å®è·µ

| ç”¨é€” | finalize_trades | æŠ‘åˆ¶æ—¥å¿— | åŸå›  |
|------|----------------|---------|------|
| å®ç›˜ä¿¡å·ç”Ÿæˆ | False | âœ… æ˜¯ | ä¿¡å·åŸºäºæŒ‡æ ‡ï¼Œä¸éœ€è¦å®Œæ•´ç»Ÿè®¡ |
| å›æµ‹ç»Ÿè®¡åˆ†æ | True | âŒ å¦ | éœ€è¦å‡†ç¡®çš„æ€§èƒ½æŒ‡æ ‡ |
| å‚æ•°ä¼˜åŒ– | True | âŒ å¦ | é¿å…ä¼˜åŒ–ç»“æœåå·® |

#### 7. é£é™©è¯„ä¼°
- **å®ç›˜é£é™©**ï¼šâœ… æ— é£é™©ï¼ˆä¿¡å·å‡†ç¡®æ€§éªŒè¯é€šè¿‡ï¼‰
- **å›æµ‹é£é™©**ï¼šâœ… å·²ç¼“è§£ï¼ˆbacktest_runner.py æ­£ç¡®ä½¿ç”¨ finalize_trades=Trueï¼‰

å‚è€ƒæµ‹è¯•è„šæœ¬ï¼š`test_quiet_backtest.py`ã€`investigate_open_trades.py`