# æ¯æ—¥äº¤æ˜“ä¿¡å·ç”Ÿæˆç³»ç»Ÿ

## åŠŸèƒ½æ¦‚è¿°

æ¯æ—¥äº¤æ˜“ä¿¡å·ç”Ÿæˆç³»ç»Ÿå¸®åŠ©æ‚¨åœ¨æ¯å¤©æ”¶ç›˜åï¼Œæ ¹æ®åŒå‡çº¿ç­–ç•¥ï¼ˆæˆ–å…¶ä»–ç­–ç•¥ï¼‰è‡ªåŠ¨åˆ†æè‚¡ç¥¨æ± ä¸­çš„æ‰€æœ‰æ ‡çš„ï¼Œç”Ÿæˆä¹°å…¥/å–å‡ºä¿¡å·å’Œèµ„é‡‘åˆ†é…å»ºè®®ã€‚

## æ ¸å¿ƒæ–‡ä»¶

- `generate_signals.py` - Pythonä¿¡å·ç”Ÿæˆè„šæœ¬
- `generate_daily_signals.sh` - Shellå¯åŠ¨è„šæœ¬ï¼ˆæ¨èä½¿ç”¨ï¼‰

## å¿«é€Ÿå¼€å§‹

### 1. æ¯å¤©æ”¶ç›˜åç”Ÿæˆäº¤æ˜“ä¿¡å·

```bash
# åŸºç¡€ç”¨æ³•
./generate_daily_signals.sh --stock-list results/trend_etf_pool_20251107.csv

# æŒ‡å®šå¯ç”¨èµ„é‡‘å’Œç›®æ ‡æŒä»“æ•°
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool_20251107.csv \
  --cash 200000 \
  --positions 10

# ä¿å­˜æŠ¥å‘Šåˆ°æ–‡ä»¶
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool_20251107.csv \
  --output signals/daily_$(date +%Y%m%d).txt \
  --csv signals/signals_$(date +%Y%m%d).csv
```

### 2. ä½¿ç”¨è‡ªå®šä¹‰ç­–ç•¥å‚æ•°

```bash
# ä½¿ç”¨çŸ­æœŸ5æ—¥å‡çº¿å’Œé•¿æœŸ20æ—¥å‡çº¿
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool_20251107.csv \
  --n1 5 \
  --n2 20

# æ³¨æ„ï¼šç­–ç•¥å‚æ•°å¿…é¡»ä¸å›æµ‹æ—¶ä½¿ç”¨çš„å‚æ•°ä¸€è‡´ï¼
```

## ä¿¡å·ç±»å‹è¯´æ˜

- **BUYï¼ˆä¹°å…¥ï¼‰** - é‡‘å‰ä¿¡å·ï¼ŒçŸ­æœŸå‡çº¿ä¸Šç©¿é•¿æœŸå‡çº¿
- **SELLï¼ˆå–å‡ºï¼‰** - æ­»å‰ä¿¡å·ï¼ŒçŸ­æœŸå‡çº¿ä¸‹ç©¿é•¿æœŸå‡çº¿
- **HOLD_LONGï¼ˆæŒæœ‰å¤šå¤´ï¼‰** - çŸ­æœŸå‡çº¿åœ¨é•¿æœŸå‡çº¿ä¸Šæ–¹ï¼Œç»§ç»­æŒæœ‰
- **HOLD_SHORTï¼ˆæŒæœ‰ç©ºå¤´ï¼‰** - çŸ­æœŸå‡çº¿åœ¨é•¿æœŸå‡çº¿ä¸‹æ–¹ï¼Œä¸å»ºè®®ä¹°å…¥

## è¾“å‡ºç¤ºä¾‹

```
================================================================================
äº¤æ˜“ä¿¡å·æŠ¥å‘Š - 2025-11-07 15:35:20
================================================================================

ğŸ“Š ä¿¡å·ç»Ÿè®¡
--------------------------------------------------------------------------------
  BUY: 3 åª
  HOLD_LONG: 15 åª
  HOLD_SHORT: 82 åª

ğŸ”” ä¹°å…¥ä¿¡å·ï¼ˆé‡‘å‰ï¼‰
--------------------------------------------------------------------------------
  588170.SH
    å½“å‰ä»·æ ¼: Â¥1.234
    çŸ­æœŸå‡çº¿: 1.235
    é•¿æœŸå‡çº¿: 1.220
    ä¿¡å·å¼ºåº¦: 1.23%
    è¯´æ˜: é‡‘å‰ä¹°å…¥ä¿¡å·ï¼çŸ­æœŸå‡çº¿(10æ—¥)ä¸Šç©¿é•¿æœŸå‡çº¿(20æ—¥)

  589010.SH
    å½“å‰ä»·æ ¼: Â¥2.567
    çŸ­æœŸå‡çº¿: 2.570
    é•¿æœŸå‡çº¿: 2.550
    ä¿¡å·å¼ºåº¦: 0.78%
    è¯´æ˜: é‡‘å‰ä¹°å…¥ä¿¡å·ï¼çŸ­æœŸå‡çº¿(10æ—¥)ä¸Šç©¿é•¿æœŸå‡çº¿(20æ—¥)

ğŸ’° èµ„é‡‘åˆ†é…å»ºè®®
--------------------------------------------------------------------------------
  æ€»èµ„é‡‘: Â¥100,000.00
  åˆ†é…èµ„é‡‘: Â¥98,500.00
  å‰©ä½™èµ„é‡‘: Â¥1,500.00
  å»ºè®®æŒä»“æ•°: 3

  å…·ä½“ä¹°å…¥å»ºè®®:

  [1] 588170.SH
      ä¹°å…¥ä»·æ ¼: Â¥1.23
      ä¹°å…¥æ•°é‡: 26500 è‚¡
      é¢„è®¡æˆæœ¬: Â¥32,595.00
      ä»“ä½å æ¯”: 32.60%
      ä¿¡å·å¼ºåº¦: 1.23%

  [2] 589010.SH
      ä¹°å…¥ä»·æ ¼: Â¥2.57
      ä¹°å…¥æ•°é‡: 12800 è‚¡
      é¢„è®¡æˆæœ¬: Â¥32,896.00
      ä»“ä½å æ¯”: 32.90%
      ä¿¡å·å¼ºåº¦: 0.78%

  [3] 159366.SZ
      ä¹°å…¥ä»·æ ¼: Â¥3.45
      ä¹°å…¥æ•°é‡: 9500 è‚¡
      é¢„è®¡æˆæœ¬: Â¥32,775.00
      ä»“ä½å æ¯”: 32.78%
      ä¿¡å·å¼ºåº¦: 0.56%
```

## å‚æ•°è¯´æ˜

### åŸºæœ¬å‚æ•°ï¼ˆæ— çŠ¶æ€æ¨¡å¼ï¼‰

- `--stock-list` - è‚¡ç¥¨åˆ—è¡¨CSVæ–‡ä»¶ â­ å¿…éœ€
- `--strategy` - ç­–ç•¥åç§°ï¼ˆé»˜è®¤: sma_crossï¼‰
- `--cash` - å¯ç”¨èµ„é‡‘ï¼ˆé»˜è®¤: 100000ï¼‰
- `--positions` - ç›®æ ‡æŒä»“æ•°é‡ï¼ˆé»˜è®¤: 10ï¼‰
- `--n1`, `--n2` - çŸ­æœŸå’Œé•¿æœŸå‡çº¿å‘¨æœŸ
- `--cost-model` - è´¹ç”¨æ¨¡å‹ï¼ˆé»˜è®¤: cn_etfï¼‰
- `--data-dir` - æ•°æ®ç›®å½•ï¼ˆé»˜è®¤: data/csv/dailyï¼‰
- `--output` - æŠ¥å‘Šè¾“å‡ºæ–‡ä»¶ï¼›`--csv` - CSVè¾“å‡ºè·¯å¾„

### è´¹ç”¨æ¨¡å‹ï¼ˆç”¨äºèµ„é‡‘åˆ†é…è®¡ç®—ï¼‰

| æ¨¡å‹ | ä½£é‡‘ | æ»‘ç‚¹ | ç”¨é€” |
|------|------|------|------|
| `default` | 0% | 0% | æ— è´¹ç”¨ |
| `cn_etf` | 0.01% | 0.01% | ä¸­å›½ETF â­ æ¨è |
| `cn_stock` | 0.03% | 0.1% | ä¸­å›½Aè‚¡ï¼ˆå«å°èŠ±ç¨ï¼‰ |
| `us_stock` | 0.1% | 0.05% | ç¾è‚¡ |

## èµ„é‡‘åˆ†é…ä¸è®¡ç®—

### å½“å‰åˆ†é…ç­–ç•¥ï¼ˆç­‰æƒé‡æ¨¡å¼ï¼‰

ç³»ç»Ÿé‡‡ç”¨**ç­‰æƒé‡åˆ†é…**ï¼š
1. ç­›é€‰æ‰€æœ‰"BUY"ä¿¡å·çš„æ ‡çš„
2. æŒ‰ä¿¡å·å¼ºåº¦æ’åºï¼ˆå‡çº¿ä¹–ç¦»%ï¼‰
3. å–å‰ N ä¸ªæ ‡çš„ï¼ˆN = `--positions`ï¼‰
4. å¹³å‡åˆ†é…èµ„é‡‘ç»™è¿™ N ä¸ªæ ‡çš„
5. è®¡ç®—ä¹°å…¥è‚¡æ•°ï¼ˆå‘ä¸‹å–æ•´åˆ°100è‚¡å€æ•°ï¼‰

### ä¹°å…¥æ•°é‡å…¬å¼

```python
cash_per_position = total_cash / n_positions
effective_cash = cash_per_position * (1 - commission - spread)
shares = int(effective_cash / price / 100) * 100
```

### é‡è¦æ³¨æ„

- **Aè‚¡æœ€å°äº¤æ˜“å•ä½æ˜¯100è‚¡**ï¼Œç³»ç»Ÿè‡ªåŠ¨å‘ä¸‹å–æ•´
- **äº¤æ˜“æˆæœ¬å·²è®¡å…¥**ï¼Œå®é™…ä¹°å…¥é‡‘é¢ç•¥å°äºåˆ†é…èµ„é‡‘
- **ä¿¡å·å¼ºåº¦**è¶Šå¤§è¡¨ç¤ºå‡çº¿ä¹–ç¦»è¶Šå¤§ï¼ˆå‚è€ƒæŒ‡æ ‡ï¼‰

## é«˜çº§ç”¨æ³•

### å®šæ—¶ä»»åŠ¡

ä½¿ç”¨cronæ¯å¤©15:30è‡ªåŠ¨è¿è¡Œï¼š

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆæ¯ä¸ªäº¤æ˜“æ—¥15:30ï¼‰
30 15 * * 1-5 cd /path/to/backtesting && ./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool_20251107.csv \
  --output signals/daily_$(date +\%Y\%m\%d).txt \
  --csv signals/signals_$(date +\%Y\%m\%d).csv
```

### Pythonè„šæœ¬ç›´æ¥è°ƒç”¨

å¦‚æœéœ€è¦æ›´å¤šè‡ªå®šä¹‰ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨Pythonè„šæœ¬ï¼š

```bash
/home/zijunliu/miniforge3/condabin/conda run -n backtesting \
  python generate_signals.py \
  --stock-list results/trend_etf_pool_20251107.csv \
  --cash 100000 \
  --positions 10 \
  --n1 15 \
  --n2 50 \
  --data-dir data/csv/daily
```

### ç»“åˆå…¶ä»–å·¥å…·

```bash
# ç”Ÿæˆä¿¡å·å¹¶å‘é€é‚®ä»¶é€šçŸ¥
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool_20251107.csv \
  --output /tmp/signals.txt && \
  mail -s "ä»Šæ—¥äº¤æ˜“ä¿¡å·" your@email.com < /tmp/signals.txt

# ç”Ÿæˆä¿¡å·å¹¶ä¿å­˜åˆ°å†å²è®°å½•
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool_20251107.csv \
  --output signals/history/$(date +%Y%m%d).txt
```

## å¸¸è§é—®é¢˜

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| **ä¸ºä»€ä¹ˆæ²¡æœ‰ä¹°å…¥ä¿¡å·ï¼Ÿ** | æ‰€æœ‰æ ‡çš„å¤„äºä¸‹é™è¶‹åŠ¿æˆ–æ— é‡‘å‰å‘ç”Ÿã€‚æ£€æŸ¥æ•°æ®æ˜¯å¦å·²æ›´æ–°åˆ°æœ€æ–°äº¤æ˜“æ—¥ã€‚ |
| **ä¿¡å·å¼ºåº¦æ˜¯ä»€ä¹ˆï¼Ÿ** | (çŸ­æœŸå‡çº¿ - é•¿æœŸå‡çº¿) / é•¿æœŸå‡çº¿ Ã— 100%ã€‚ç»å¯¹å€¼è¶Šå¤§ï¼Œä¹–ç¦»è¶Šå¤§ã€‚ |
| **ä¸ºä»€ä¹ˆä¹°å…¥æ•°é‡ä¸æ•´æ•°ï¼Ÿ** | ç³»ç»Ÿæ ¹æ®ï¼šèµ„é‡‘ Ã· æŒä»“æ•° - æ‰‹ç»­è´¹ Ã· ä»·æ ¼ï¼Œå‘ä¸‹å–æ•´åˆ°100è‚¡å€æ•°ã€‚ |
| **ç­–ç•¥å‚æ•°æ€ä¹ˆé€‰ï¼Ÿ** | ç”¨ `./run_backtest.sh --optimize` ä¼˜åŒ–è‚¡ç¥¨æ± ï¼Œå–æ”¶ç›Šæœ€é«˜çš„å‚æ•°ç»„åˆã€‚ |
| **å¯ä»¥è‡ªåŠ¨äº¤æ˜“å—ï¼Ÿ** | æœ¬ç³»ç»Ÿä»…ç”Ÿæˆå»ºè®®ï¼Œéœ€äººå·¥å®¡æ ¸ååœ¨åˆ¸å•†è½¯ä»¶ä¸­ä¸‹å•ã€‚ |
| **å¦‚ä½•å‡å°‘é£é™©ï¼Ÿ** | ä»å°èµ„é‡‘å¼€å§‹æµ‹è¯•ï¼ˆ1-2ä¸‡ï¼‰ï¼Œå®šæœŸæ ¸å¯¹æŒä»“ä¸è´¦æˆ·ï¼Œç›‘æ§å®é™…è¡¨ç°ã€‚ |

## æŠ€æœ¯ç»†èŠ‚

### ä¿¡å·æ£€æµ‹é€»è¾‘

```python
if sma_short_prev <= sma_long_prev and sma_short > sma_long:
    signal = 'BUY'      # é‡‘å‰
elif sma_short_prev >= sma_long_prev and sma_short < sma_long:
    signal = 'SELL'     # æ­»å‰
elif sma_short > sma_long:
    signal = 'HOLD_LONG'    # å¤šå¤´æŒæœ‰
else:
    signal = 'HOLD_SHORT'   # ç©ºå¤´
```

### æ•°æ®è¦æ±‚

- **æœ€å°‘æ•°æ®é‡**ï¼šè‡³å°‘30å¤©ï¼ˆç”¨äºè®¡ç®—å‡çº¿ï¼‰
- **é»˜è®¤å›çœ‹æœŸ**ï¼š250ä¸ªäº¤æ˜“æ—¥ï¼ˆçº¦1å¹´ï¼‰
- **æ•°æ®æ ¼å¼**ï¼šDate, Open, High, Low, Close, Volume

## ğŸš€ æŒç»­äº¤æ˜“ç³»ç»Ÿï¼ˆPortfolio Managementï¼‰

### é—®é¢˜åˆ†æ

æ— çŠ¶æ€ç³»ç»Ÿæ¯æ¬¡è¿è¡Œéƒ½å‡è®¾ä»é›¶å¼€å§‹å»ºä»“ã€‚å®é™…é—®é¢˜ï¼š
- ç¬¬1å¤©ï¼šå»ºè®®ä¹°Aã€Bã€Cï¼ˆå„3.3ä¸‡ï¼‰
- ç¬¬2å¤©ï¼šAå‡ºç°å–å‡ºä¿¡å·ï¼Œä½†ç³»ç»Ÿä»å»ºè®®ä¹°Dã€Eã€Fï¼ˆå‡è®¾è¿˜æœ‰10ä¸‡ï¼‰
- âŒ **é”™è¯¯**ï¼šç³»ç»Ÿä¸çŸ¥é“å·²æŒæœ‰Aæˆ–å‰©ä½™ç°é‡‘

**è§£å†³**ï¼šå¼•å…¥æŒä»“çŠ¶æ€æ–‡ä»¶è®°å½•å½“å‰çœŸå®çŠ¶å†µï¼Œæ”¯æŒå¢é‡å†³ç­–ã€‚

### ç³»ç»Ÿå·¥ä½œæµ

1. **è¯»å–æŒä»“** â†’ è·å–å½“å‰æŒä»“å’Œç°é‡‘
2. **ç”Ÿæˆä¿¡å·** â†’ åˆ†æè‚¡ç¥¨æ± ï¼ˆä½¿ç”¨å¤æƒä»·æ ¼è®¡ç®—æŒ‡æ ‡ï¼‰
3. **å¢é‡å†³ç­–** â†’ ä¼˜å…ˆå–å‡ºï¼ˆé‡Šæ”¾èµ„é‡‘ï¼‰ï¼Œå†ä¹°å…¥ï¼ˆä½¿ç”¨é‡Šæ”¾èµ„é‡‘ï¼‰
4. **ç¡®è®¤æ‰§è¡Œ** â†’ ç”¨æˆ·ç¡®è®¤åæ›´æ–°æŒä»“
5. **è®°å½•äº¤æ˜“** â†’ ä¿å­˜äº¤æ˜“å†å²å’Œæ›´æ–°åçš„æŒä»“

#### æŒä»“çŠ¶æ€æ–‡ä»¶æ ¼å¼

**`positions/portfolio.json`** - æ ¸å¿ƒçŠ¶æ€æ–‡ä»¶

```json
{
  "cash": 35000.00,
  "positions": [
    {
      "ts_code": "159001.SZ",
      "shares": 10000,
      "entry_price": 3.25,
      "entry_date": "2025-11-06",
      "cost": 32512.50
    },
    {
      "ts_code": "510300.SH",
      "shares": 5000,
      "entry_price": 4.15,
      "entry_date": "2025-11-07",
      "cost": 20770.00
    }
  ],
  "last_update": "2025-11-07 15:35:20"
}
```

**å­—æ®µè¯´æ˜ï¼š**
- `cash`: å½“å‰å¯ç”¨ç°é‡‘
- `positions`: æŒä»“åˆ—è¡¨
  - `ts_code`: è‚¡ç¥¨ä»£ç 
  - `shares`: æŒæœ‰è‚¡æ•°
  - `entry_price`: ä¹°å…¥å‡ä»·
  - `entry_date`: å»ºä»“æ—¥æœŸ
  - `cost`: æŒä»“æˆæœ¬ï¼ˆå«æ‰‹ç»­è´¹ï¼‰
- `last_update`: æœ€åæ›´æ–°æ—¶é—´

#### å¢é‡å†³ç­–é€»è¾‘

ç³»ç»ŸæŒ‰ä»¥ä¸‹é¡ºåºæ‰§è¡Œï¼š

1. **å–å‡ºå¤„ç†**ï¼šéå†æŒä»“ï¼ŒSELLä¿¡å·çš„æ ‡çš„å–å‡ºï¼Œé‡Šæ”¾èµ„é‡‘
2. **ä¹°å…¥ç­›é€‰**ï¼šä»è‚¡ç¥¨æ± ä¸­ç­›é€‰BUYä¿¡å·ä¸”æœªæŒæœ‰çš„æ ‡çš„ï¼ŒæŒ‰ä¿¡å·å¼ºåº¦æ’åº
3. **å¯ç”¨èµ„é‡‘è®¡ç®—**ï¼šå½“å‰ç°é‡‘ + å–å‡ºæ”¶å…¥ = å¯ç”¨èµ„é‡‘
4. **ä¹°å…¥æ‰§è¡Œ**ï¼šç­‰æƒåˆ†é…ç»™ç­›é€‰å‡ºçš„æ ‡çš„ï¼ˆæœ€å¤šä¸è¶…è¿‡max_positions - å½“å‰æŒä»“æ•°ï¼‰
5. **æŒä»“ç»´æŠ¤**ï¼šHOLDä¿¡å·çš„æ ‡çš„ç»§ç»­æŒæœ‰ï¼Œä¸æ“ä½œ

#### ä½¿ç”¨æŒ‡å—

**1. åˆå§‹åŒ–ï¼ˆç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼‰**

```bash
# åˆ›å»ºåˆå§‹æŒä»“çŠ¶æ€æ–‡ä»¶
./generate_daily_signals.sh \
  --init 100000 \
  --portfolio-file positions/portfolio.json
```

è¾“å‡ºï¼š
```
âœ“ æŒä»“çŠ¶æ€å·²åˆå§‹åŒ–
  åˆå§‹èµ„é‡‘: Â¥100,000.00
  æŒä»“æ–‡ä»¶: positions/portfolio.json
```

**2. æ¯æ—¥åˆ†æï¼ˆæŸ¥çœ‹æ¨¡å¼ï¼‰**

```bash
# åˆ†æå½“å‰ä¿¡å·ï¼Œä½†ä¸æ‰§è¡Œäº¤æ˜“
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool_20251107.csv \
  --portfolio-file positions/portfolio.json \
  --analyze
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
================================================================================
å½“å‰æŒä»“çŠ¶æ€
================================================================================

ğŸ’° èµ„é‡‘ä¿¡æ¯
--------------------------------------------------------------------------------
  å¯ç”¨ç°é‡‘: Â¥35,000.00
  æŒä»“å¸‚å€¼: Â¥65,000.00
  æ€»èµ„äº§:   Â¥100,000.00
  æŒä»“ç›ˆäº: +Â¥2,500.00 (+4.00%)

ğŸ“Š æŒä»“æ˜ç»† (2/10)
--------------------------------------------------------------------------------
  159001.SZ
    æŒä»“æ•°é‡: 10000 è‚¡
    ä¹°å…¥ä»·æ ¼: Â¥3.25 (2025-11-06)
    å½“å‰ä»·æ ¼: Â¥3.35
    æŒä»“æˆæœ¬: Â¥32,512.50
    å½“å‰å¸‚å€¼: Â¥33,500.00
    ç›ˆäº:     +Â¥987.50 (+3.04%)

  510300.SH
    æŒä»“æ•°é‡: 5000 è‚¡
    ä¹°å…¥ä»·æ ¼: Â¥4.15 (2025-11-07)
    å½“å‰ä»·æ ¼: Â¥4.30
    æŒä»“æˆæœ¬: Â¥20,770.00
    å½“å‰å¸‚å€¼: Â¥21,500.00
    ç›ˆäº:     +Â¥730.00 (+3.51%)

================================================================================
äº¤æ˜“å»ºè®®
================================================================================

ğŸ“‰ å–å‡ºæ“ä½œ (1)
--------------------------------------------------------------------------------
  [1] 159001.SZ
      æ“ä½œ: å–å‡º
      ä»·æ ¼: Â¥3.35
      æ•°é‡: 10000 è‚¡
      é¢„è®¡æ”¶å…¥: Â¥33,466.50
      åŸå› : æ­»å‰å–å‡ºä¿¡å·ï¼çŸ­æœŸå‡çº¿(10æ—¥)ä¸‹ç©¿é•¿æœŸå‡çº¿(20æ—¥)

ğŸ“ˆ ä¹°å…¥æ“ä½œ (1)
--------------------------------------------------------------------------------
  [1] 588170.SH
      æ“ä½œ: ä¹°å…¥
      ä»·æ ¼: Â¥1.23
      æ•°é‡: 55600 è‚¡
      é¢„è®¡æˆæœ¬: Â¥68,388.00
      ä¿¡å·å¼ºåº¦: 1.23%
      åŸå› : é‡‘å‰ä¹°å…¥ä¿¡å·ï¼çŸ­æœŸå‡çº¿(10æ—¥)ä¸Šç©¿é•¿æœŸå‡çº¿(20æ—¥)

================================================================================
```

**3. æ‰§è¡Œäº¤æ˜“ï¼ˆæ‰§è¡Œæ¨¡å¼ï¼‰**

```bash
# ç¡®è®¤æ— è¯¯åï¼Œæ‰§è¡Œäº¤æ˜“å¹¶æ›´æ–°æŒä»“
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool_20251107.csv \
  --portfolio-file positions/portfolio.json \
  --execute
```

äº¤äº’å¼ç¡®è®¤ï¼š
```
âš ï¸  å³å°†æ‰§è¡Œäº¤æ˜“æ“ä½œï¼Œè¯·ç¡®è®¤ï¼š
  - å–å‡º 1 åªæ ‡çš„
  - ä¹°å…¥ 1 åªæ ‡çš„

æ˜¯å¦ç¡®è®¤æ‰§è¡Œï¼Ÿ(yes/no): yes

å¼€å§‹æ‰§è¡Œäº¤æ˜“...
âœ“ å–å‡º: 159001.SZ 10000è‚¡ @Â¥3.35 æ”¶å…¥Â¥33,466.50
âœ“ ä¹°å…¥: 588170.SH 55600è‚¡ @Â¥1.23 æˆæœ¬Â¥68,388.00

âœ“ æŒä»“å·²æ›´æ–°: positions/portfolio.json
âœ“ äº¤æ˜“è®°å½•å·²ä¿å­˜: positions/history/trades_20251107.json
```

**4. æŸ¥çœ‹æŒä»“ï¼ˆçŠ¶æ€æ¨¡å¼ï¼‰**

```bash
# éšæ—¶æŸ¥çœ‹å½“å‰æŒä»“çŠ¶æ€
./generate_daily_signals.sh \
  --portfolio-file positions/portfolio.json \
  --status
```

#### å®Œæ•´å‘½ä»¤å‚æ•°

```bash
./generate_daily_signals.sh \
  --stock-list <è‚¡ç¥¨æ± CSV> \              # å¿…éœ€
  --portfolio-file <æŒä»“JSON> \           # æŒä»“çŠ¶æ€æ–‡ä»¶è·¯å¾„
  --strategy <ç­–ç•¥å> \                    # é»˜è®¤sma_cross
  --n1 <çŸ­æœŸ> --n2 <é•¿æœŸ> \                # ç­–ç•¥å‚æ•°
  --max-positions <æ•°é‡> \                 # æœ€å¤§æŒä»“æ•°ï¼ˆé»˜è®¤10ï¼‰
  --cost-model <æ¨¡å‹> \                    # è´¹ç”¨æ¨¡å‹ï¼ˆé»˜è®¤cn_etfï¼‰
  [--init <åˆå§‹èµ„é‡‘>] \                    # åˆå§‹åŒ–æ¨¡å¼
  [--analyze] \                           # åˆ†ææ¨¡å¼ï¼ˆä¸æ‰§è¡Œï¼‰
  [--execute] \                           # æ‰§è¡Œæ¨¡å¼ï¼ˆæ›´æ–°æŒä»“ï¼‰
  [--status]                              # æŸ¥çœ‹æŒä»“çŠ¶æ€
```

#### å…¸å‹ä½¿ç”¨åœºæ™¯

**åœºæ™¯1ï¼šå®Œå…¨æ–°æ‰‹ç¬¬ä¸€æ¬¡ä½¿ç”¨**

```bash
# Day 0: åˆå§‹åŒ–æŒä»“ï¼ŒæŠ•å…¥10ä¸‡
./generate_daily_signals.sh --init 100000 --portfolio-file positions/portfolio.json

# Day 1: ç¬¬ä¸€å¤©æ”¶ç›˜ååˆ†æ
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/portfolio.json \
  --analyze

# ç¡®è®¤åæ‰§è¡Œ
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/portfolio.json \
  --execute
```

**åœºæ™¯2ï¼šå·²æœ‰æŒä»“ï¼Œå¯¼å…¥ç°æœ‰ä»“ä½**

```bash
# æ‰‹åŠ¨ç¼–è¾‘ positions/portfolio.jsonï¼Œå½•å…¥å½“å‰çœŸå®æŒä»“
vim positions/portfolio.json

# ç„¶åæ­£å¸¸ä½¿ç”¨
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/portfolio.json \
  --analyze
```

**åœºæ™¯3ï¼šæ¯æ—¥æ“ä½œæµç¨‹ï¼ˆæœ€å¸¸ç”¨ï¼‰**

```bash
# æ¯å¤©15:30åï¼Œä¸€é”®åˆ†æ+æ‰§è¡Œ
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/portfolio.json \
  --analyze && \
./generate_daily_signals.sh \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/portfolio.json \
  --execute
```

**åœºæ™¯4ï¼šå®šæ—¶ä»»åŠ¡è‡ªåŠ¨åŒ–**

```bash
# crontabå®šæ—¶ä»»åŠ¡ï¼ˆä»…åˆ†ææ¨¡å¼ï¼Œå‘é€é€šçŸ¥ï¼‰
30 15 * * 1-5 cd /path/to/backtesting && \
  ./generate_daily_signals.sh \
    --stock-list results/trend_etf_pool.csv \
    --portfolio-file positions/portfolio.json \
    --analyze \
    --output /tmp/signals.txt && \
  mail -s "ä»Šæ—¥äº¤æ˜“ä¿¡å·" your@email.com < /tmp/signals.txt
```

#### æ–‡ä»¶ç»“æ„

```
backtesting/
â”œâ”€â”€ generate_signals.py              # ä¿¡å·ç”Ÿæˆè„šæœ¬ï¼ˆå¢å¼ºç‰ˆï¼‰
â”œâ”€â”€ generate_daily_signals.sh        # ç»Ÿä¸€å…¥å£è„šæœ¬ï¼ˆç«¯åˆ°ç«¯ï¼‰
â”œâ”€â”€ README_SIGNALS.md               # æœ¬æ–‡æ¡£
â”œâ”€â”€ positions/                       # æŒä»“ç®¡ç†ç›®å½• â­ NEW
â”‚   â”œâ”€â”€ portfolio.json              # å½“å‰æŒä»“çŠ¶æ€æ–‡ä»¶
â”‚   â””â”€â”€ history/                    # äº¤æ˜“å†å²è®°å½•
â”‚       â”œâ”€â”€ trades_20251106.json    # æ¯æ—¥äº¤æ˜“è®°å½•
â”‚       â”œâ”€â”€ trades_20251107.json
â”‚       â””â”€â”€ portfolio_backup/       # æŒä»“å¤‡ä»½ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ signals/                        # ä¿¡å·è¾“å‡ºç›®å½•
â”‚   â”œâ”€â”€ daily_20251107.txt
â”‚   â””â”€â”€ signals_20251107.csv
â””â”€â”€ data/                           # æ•°æ®ç›®å½•
    â””â”€â”€ csv/daily/
```

#### æŠ€æœ¯å®ç°è¦ç‚¹

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **æŒä»“çŠ¶æ€** | JSONæ ¼å¼å­˜å‚¨ï¼Œäººå·¥å¯è¯»ï¼Œæ¯æ¬¡äº¤æ˜“åè‡ªåŠ¨æ›´æ–° |
| **å¢é‡å†³ç­–** | ä¼˜å…ˆå–å‡ºâ†’å†ä¹°å…¥â†’è€ƒè™‘æŒä»“ä¸Šé™å’Œèµ„é‡‘çº¦æŸ |
| **äº¤æ˜“å†å²** | æ¯æ—¥è®°å½•åˆ° `positions/history/trades_YYYYMMDD.json`ï¼Œä¾¿äºå¤ç›˜ |
| **å®‰å…¨æœºåˆ¶** | æ‰§è¡Œæ¨¡å¼éœ€ç”¨æˆ·ç¡®è®¤ï¼›åˆ†ææ¨¡å¼åªè¯»ä¸å†™ï¼›çŠ¶æ€æ¨¡å¼åªæŸ¥çœ‹ |
| **é”™è¯¯å¤„ç†** | æŒä»“æ–‡ä»¶ä¸å­˜åœ¨â†’æç¤ºåˆå§‹åŒ–ï¼›ç°é‡‘ä¸è¶³â†’æ‹’ç»ä¹°å…¥ï¼›å–å‡ºä¸å­˜åœ¨æŒä»“â†’è­¦å‘Š |
| **å‘åå…¼å®¹** | ä¸ç”¨ `--portfolio-file` æ—¶è¡Œä¸ºä¸åŸç³»ç»Ÿä¸€è‡´ï¼›å¯æ¸è¿›å¼å‡çº§ |

#### åŒä»·æ ¼æ¨¡å¼ï¼ˆè‡ªåŠ¨å¤„ç†ï¼‰

- **ä¿¡å·è®¡ç®—**ï¼šä½¿ç”¨å¤æƒä»·æ ¼ï¼ˆç¡®ä¿æŠ€æœ¯æŒ‡æ ‡å‡†ç¡®ï¼‰
- **äº¤æ˜“æ‰§è¡Œ**ï¼šä½¿ç”¨åŸå§‹ä»·æ ¼ï¼ˆç¬¦åˆå®ç›˜äº¤æ˜“ï¼‰
- **è‡ªåŠ¨æ˜ å°„**ï¼šç³»ç»Ÿè‡ªåŠ¨å¤„ç†å¤æƒä»·æ ¼å’ŒåŸå§‹ä»·æ ¼çš„æ˜ å°„
- **ä»·æ ¼å·®å¼‚ç¤ºä¾‹**ï¼š588170.SHåœ¨2025-11-03 å¤æƒä»·æ ¼Â¥2.10ï¼ŒåŸå§‹ä»·æ ¼Â¥1.39ï¼ˆå·®å¼‚51%ï¼‰

---

## ğŸ¯ ç³»ç»ŸéªŒæ”¶çŠ¶æ€

### åŠŸèƒ½éªŒæ”¶ï¼šæŒä»“ç®¡ç†ç³»ç»Ÿï¼ˆ2025-11-08ï¼‰

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| åˆå§‹åŒ–æ¨¡å¼ (`--init`) | âœ… | åˆ›å»ºåˆå§‹æŒä»“æ–‡ä»¶ |
| çŠ¶æ€æŸ¥çœ‹ (`--status`) | âœ… | å®æ—¶æŸ¥çœ‹æŒä»“å’Œç›ˆäº |
| åˆ†ææ¨¡å¼ (`--analyze`) | âœ… | ç”Ÿæˆäº¤æ˜“å»ºè®®ï¼ˆæ¨èç”¨äºå®ç›˜ï¼‰ |
| æ‰§è¡Œæ¨¡å¼ (`--execute`) | âœ… | æ‰§è¡Œäº¤æ˜“å¹¶æ›´æ–°æŒä»“ï¼ˆåŒä»·æ ¼æ¨¡å¼å·²ä¿®å¤ï¼‰ |
| ç›ˆäºè®¡ç®— | âœ… | è‡ªåŠ¨è®¡ç®—æŒä»“å¸‚å€¼å’Œç›ˆäºç™¾åˆ†æ¯” |
| å¢é‡å†³ç­– | âœ… | åŸºäºå½“å‰æŒä»“æ™ºèƒ½ç”Ÿæˆäº¤æ˜“è®¡åˆ’ |
| å‘åå…¼å®¹ | âœ… | æ— çŠ¶æ€æ¨¡å¼å®Œå…¨ä¿ç•™ |
| è´¹ç”¨ä¸€è‡´æ€§ | âœ… | ä¸backtestingæ¡†æ¶å®Œå…¨ä¸€è‡´ |

### åŠŸèƒ½éªŒæ”¶ï¼šæ–¹æ¡ˆAå•ä»“ä½ä¸Šé™ï¼ˆ2025-11-08ï¼‰

**éªŒæ”¶æ—¥æœŸ**: 2025-11-08
**éªŒæ”¶æ–¹æ³•**: è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ (`test_position_limit.py`)
**æµ‹è¯•ç»“æœ**: âœ… å…¨éƒ¨é€šè¿‡

| æµ‹è¯•åœºæ™¯ | é¢„æœŸè¡Œä¸º | å®é™…ç»“æœ | çŠ¶æ€ |
|---------|---------|----------|------|
| å•ä¿¡å·åœºæ™¯ | åˆ†é…â‰¤5%èµ„é‡‘ | åˆ†é…4.00%ï¼ˆå—100è‚¡é™åˆ¶ï¼‰ | âœ… é€šè¿‡ |
| 10ä¿¡å·åœºæ™¯ | æ¯ä¸ªâ‰¤5%ï¼Œæ€»è®¡â‰¤50% | æ¯ä¸ªâ‰¤5%ï¼Œæ€»è®¡42.76% | âœ… é€šè¿‡ |
| æœ€å°ä¿¡å·æ•°æ£€æŸ¥ | 1ä¸ªä¿¡å·<3ä¸ªæœ€å°è¦æ±‚ï¼Œä¸ä¹°å…¥ | æ­£ç¡®æ‹’ç»ä¹°å…¥ | âœ… é€šè¿‡ |
| 30ä¿¡å·åœºæ™¯ | å‰10ä¸ªå„â‰¤5% | å‰10ä¸ªå„4.00% | âœ… é€šè¿‡ |

**å‚æ•°é…ç½®**:
- `--max-position-pct 0.05` (é»˜è®¤å€¼ï¼Œå•ä»“ä½ä¸Šé™5%)
- `--min-buy-signals 1` (é»˜è®¤å€¼ï¼Œæœ‰ä¿¡å·å°±ä¹°å…¥)

**å…³é”®å‘ç°**:
1. âœ… å•ä»“ä½ä¸Šé™åŠŸèƒ½å·¥ä½œæ­£å¸¸ï¼Œæœ‰æ•ˆé˜²æ­¢èµ„é‡‘è¿‡åº¦é›†ä¸­
2. âœ… æœ€å°ä¿¡å·æ•°æ£€æŸ¥æ­£å¸¸ï¼Œå¯æ§åˆ¶åˆ†æ•£ç¨‹åº¦
3. âœ… Aè‚¡100è‚¡æœ€å°äº¤æ˜“å•ä½å¯¼è‡´å®é™…ä»“ä½ç•¥ä½äºä¸Šé™ï¼ˆæ­£å¸¸ç°è±¡ï¼‰
4. âœ… å‚æ•°å·²ç»Ÿä¸€åœ¨ `generate_daily_signals.sh` ä¸­ç®¡ç†

**ä½¿ç”¨å»ºè®®**:
- æ¨èä½¿ç”¨é»˜è®¤é…ç½®ï¼š`--max-position-pct 0.05 --min-buy-signals 1`
- 10-20ä¸ªæ ‡çš„æ± é€‚ç”¨é»˜è®¤é…ç½®
- å¯æ ¹æ®é£é™©åå¥½è°ƒæ•´ `max-position-pct` (0.05-0.10)
- è‹¥å¸Œæœ›å¼ºåˆ¶åˆ†æ•£ï¼Œå¯å¢åŠ  `min-buy-signals` (3-5)

---

**æ–¹å¼1: åˆ†ææ¨¡å¼ï¼ˆæ¨èï¼‰**
```bash
./generate_daily_signals.sh --analyze \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/portfolio.json
```

**æ–¹å¼2: åˆ†æ+æ‰§è¡Œï¼ˆè‡ªåŠ¨åŒ–ï¼‰**
```bash
./generate_daily_signals.sh --analyze ... && \
./generate_daily_signals.sh --execute ...
```

**æ–¹å¼3: æ— çŠ¶æ€æ¨¡å¼ï¼ˆåŸæœ‰åŠŸèƒ½ä¿ç•™ï¼‰**
```bash
./generate_daily_signals.sh --stock-list pool.csv --cash 100000
```

### æ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦æé†’ï¼š**

1. **æŒä»“æ–‡ä»¶ä¸è´¦æˆ·åŒæ­¥** - æ¯æ¬¡çœŸå®äº¤æ˜“åæ ¸å¯¹å¹¶æ›´æ–°ï¼Œå¦‚æœå®é™…æˆäº¤ä»·æ ¼æˆ–æ•°é‡ä¸åŒ
2. **100%æˆäº¤å‡è®¾** - ç³»ç»Ÿé»˜è®¤è®¢å•å®Œå…¨æˆäº¤ï¼Œå®é™…éœ€æ‰‹åŠ¨æ ¸å¯¹
3. **é™åˆ¶åœºæ™¯** - ä¸æ”¯æŒT+0æ—¥å†…äº¤æ˜“ã€å¤šè´¦æˆ·ã€èèµ„èåˆ¸
4. **å®šæœŸå¤‡ä»½** - å»ºè®®ç”¨gitç®¡ç† `positions/` ç›®å½•ï¼Œæ¯å‘¨å¤‡ä»½ä¸€æ¬¡
5. **ä»å°èµ„é‡‘å¼€å§‹** - å»ºè®®åˆå§‹æŠ•å…¥1-2ä¸‡è¿›è¡Œæµ‹è¯•ï¼Œç›‘æ§å®é™…è¡¨ç°

## æ”¯æŒä¸åé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æŸ¥çœ‹ï¼š
- é¡¹ç›®æ–‡æ¡£ï¼š`README_BACKTESTING.md`
- å›æµ‹æ–‡æ¡£ï¼š`README_BACKTESTING.md`
- ETFç­›é€‰æ–‡æ¡£ï¼š`etf_selector/README.md`


---

## ä¼˜åŒ–ç‚¹ï¼šæœªå¹³ä»“äº¤æ˜“è­¦å‘Šçš„å¤„ç†

### é—®é¢˜ç°è±¡
æ‰§è¡Œè„šæœ¬æ—¶å‡ºç°å¤§é‡æ—¥å¿—è¾“å‡ºï¼š
- è¿›åº¦æ¡: `Backtest.run:   0%|          | 0/120 [00:00<?, ?bar/s]`
- è­¦å‘Š: `UserWarning: Some trades remain open at the end of backtest. Use Backtest(..., finalize_trades=True)...`

### è°ƒæŸ¥ç»“è®º

#### 1. æœªå¹³ä»“äº¤æ˜“äº§ç”ŸåŸå› 
- å›æµ‹ç»“æŸæ—¶ï¼Œç­–ç•¥ä»æŒæœ‰ä»“ä½ï¼ˆæœ€åä¸€å¤©æ²¡æœ‰è§¦å‘å¹³ä»“ä¿¡å·ï¼‰
- æœªè®¾ç½® `finalize_trades=True` å‚æ•°
- **è¿™æ˜¯æ­£å¸¸ç°è±¡**ï¼Œå°¤å…¶åœ¨åŒå‡çº¿ç­–ç•¥ä¸­ï¼ˆæœ€åæŒæœ‰å¤šå¤´/ç©ºå¤´ï¼‰

#### 2. å¯¹å®ç›˜ä¿¡å·çš„å½±å“
**ç»“è®ºï¼šâœ… ä¸å½±å“å®ç›˜ä¿¡å·ç”Ÿæˆçš„å‡†ç¡®æ€§**

åŸå› ï¼š
- `generate_signals.py` ä¿¡å·ç”Ÿæˆå®Œå…¨åŸºäºæŒ‡æ ‡å€¼ï¼ˆå‡çº¿äº¤å‰ï¼‰
- ä¸ä¾èµ–äº `position` çŠ¶æ€æˆ– `trades` æŒä»“
- éªŒè¯æµ‹è¯•æ˜¾ç¤ºï¼šfinalize_trades=False/True ä¸‹ä¿¡å·100%ä¸€è‡´

å…³é”®ä»£ç ï¼ˆgenerate_signals.py:196-227ï¼‰ï¼š
```python
# åªä½¿ç”¨æŒ‡æ ‡å€¼åˆ¤æ–­ä¿¡å·
sma_short = strategy.sma1[-1]
sma_long = strategy.sma2[-1]

if sma_short_prev <= sma_long_prev and sma_short > sma_long:
    result['signal'] = 'BUY'  # é‡‘å‰
elif sma_short_prev >= sma_long_prev and sma_short < sma_long:
    result['signal'] = 'SELL'  # æ­»å‰
```

#### 3. finalize_trades å‚æ•°è¯´æ˜

| å‚æ•°å€¼ | è¡Œä¸º | é€‚ç”¨åœºæ™¯ |
|--------|------|----------|
| Falseï¼ˆé»˜è®¤ï¼‰ | ä¸å¼ºåˆ¶å¹³ä»“ï¼Œæœªå¹³ä»“äº¤æ˜“ä¸è®¡å…¥ç»Ÿè®¡ | å®ç›˜ä¿¡å·ç”Ÿæˆ |
| True | è‡ªåŠ¨å¹³ä»“æ‰€æœ‰æœªå¹³ä»“äº¤æ˜“ï¼Œå®Œæ•´ç»Ÿè®¡ | å›æµ‹åˆ†æã€å‚æ•°ä¼˜åŒ– |

#### 4. å®æ–½çš„è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šå®ç›˜ä¿¡å·ç”Ÿæˆï¼ˆgenerate_signals.pyï¼‰**
```python
import os
import warnings

# ç¦ç”¨è¿›åº¦æ¡ï¼ˆåœ¨å¯¼å…¥backtestingä¹‹å‰ï¼‰
os.environ['BACKTESTING_DISABLE_PROGRESS'] = 'true'

# è¿‡æ»¤æœªå¹³ä»“è­¦å‘Š
warnings.filterwarnings('ignore', message='.*Some trades remain open.*')
warnings.filterwarnings('ignore', category=UserWarning, module='backtesting')
```

- âœ… å‡å°‘æ—¥å¿—å™ªéŸ³ï¼Œä¸å½±å“ä¿¡å·å‡†ç¡®æ€§
- âœ… å‡å°‘è®¡ç®—å¼€é”€ï¼ˆä¸éœ€è¦å¼ºåˆ¶å¹³ä»“ï¼‰

**æ–¹æ¡ˆBï¼šå›æµ‹ç»Ÿè®¡åˆ†æï¼ˆbacktest_runner.pyï¼‰**
```python
bt = Backtest(
    data,
    strategy_class,
    cash=cash,
    commission=cost_calculator,
    finalize_trades=True,  # âœ… ç¡®ä¿ç»Ÿè®¡å‡†ç¡®
)
```

- âœ… è·å¾—å®Œæ•´çš„äº¤æ˜“ç»Ÿè®¡ï¼ˆåŒ…å«æœ€åä¸€ç¬”äº¤æ˜“ï¼‰
- âœ… ç¡®ä¿å‚æ•°ä¼˜åŒ–åŸºäºå‡†ç¡®æ•°æ®

#### 5. éªŒè¯æµ‹è¯•
åˆ›å»ºäº†æµ‹è¯•è„šæœ¬éªŒè¯æ–¹æ¡ˆï¼š
```bash
# æµ‹è¯•æ—¥å¿—æŠ‘åˆ¶
python test_quiet_backtest.py

# éªŒè¯ä¿¡å·ä¸€è‡´æ€§ï¼ˆGOOGæ•°æ® + åˆæˆæ•°æ®ï¼‰
python investigate_open_trades.py
```

ç»“æœï¼š
- âœ… æ— è¿›åº¦æ¡å’Œè­¦å‘Šè¾“å‡º
- âœ… ä¿¡å·åœ¨ finalize_trades=False/True ä¸‹å®Œå…¨ä¸€è‡´
- âœ… æœªå¹³ä»“äº¤æ˜“ä¸å½±å“æŒ‡æ ‡è®¡ç®—

#### 6. æœ€ä½³å®è·µ

| ç”¨é€” | finalize_trades | æŠ‘åˆ¶æ—¥å¿— | åŸå›  |
|------|----------------|---------|------|
| å®ç›˜ä¿¡å·ç”Ÿæˆ | False | âœ… æ˜¯ | ä¿¡å·åŸºäºæŒ‡æ ‡ï¼Œä¸éœ€è¦å®Œæ•´ç»Ÿè®¡ |
| å›æµ‹ç»Ÿè®¡åˆ†æ | True | âŒ å¦ | éœ€è¦å‡†ç¡®çš„æ€§èƒ½æŒ‡æ ‡ |
| å‚æ•°ä¼˜åŒ– | True | âŒ å¦ | é¿å…ä¼˜åŒ–ç»“æœåå·® |

#### 7. é£é™©è¯„ä¼°
- **å®ç›˜é£é™©**ï¼šâœ… æ— é£é™©ï¼ˆä¿¡å·å‡†ç¡®æ€§éªŒè¯é€šè¿‡ï¼‰
- **å›æµ‹é£é™©**ï¼šâœ… å·²ç¼“è§£ï¼ˆbacktest_runner.py æ­£ç¡®ä½¿ç”¨ finalize_trades=Trueï¼‰

å‚è€ƒæµ‹è¯•è„šæœ¬ï¼š`test_quiet_backtest.py`ã€`investigate_open_trades.py`



---

## âš ï¸ æŒä»“ç®¡ç†ä¼˜åŒ–å»ºè®®

### å½“å‰é—®é¢˜

#### 1. å•ä¸€æ ‡çš„é›†ä¸­é£é™©
**é—®é¢˜æè¿°**ï¼š
- å½“åªæœ‰1æ”¯æ ‡çš„æœ‰ä¹°å…¥ä¿¡å·æ—¶ï¼Œç³»ç»Ÿå°†100%èµ„é‡‘æŠ•å…¥è¯¥æ ‡çš„
- ç­‰æƒåˆ†é…å…¬å¼ï¼š`cash_per_position = total_cash / n_buy_signals`
- ç¤ºä¾‹ï¼š10ä¸‡èµ„é‡‘ï¼Œ1ä¸ªä¹°å…¥ä¿¡å· â†’ åˆ†é…10ä¸‡ï¼ˆ100%ä»“ä½ï¼‰

**é£é™©**ï¼š
- è¿ååˆ†æ•£æŠ•èµ„åŸåˆ™
- å•ä¸€æ ‡çš„ä¸‹è·Œå¯èƒ½å¯¼è‡´é‡å¤§æŸå¤±
- æ— æ³•åº”å¯¹é»‘å¤©é¹…äº‹ä»¶

#### 2. å¿½è§†æ³¢åŠ¨ç‡å·®å¼‚
**é—®é¢˜æè¿°**ï¼š
- é«˜æ³¢åŠ¨æ ‡çš„ï¼ˆå¦‚ç§‘æŠ€ETFï¼‰ä¸ä½æ³¢åŠ¨æ ‡çš„ï¼ˆå¦‚çº¢åˆ©ETFï¼‰è·å¾—ç›¸åŒæƒé‡
- ä¸è€ƒè™‘ATRã€æ ‡å‡†å·®ç­‰æ³¢åŠ¨ç‡æŒ‡æ ‡

**é£é™©**ï¼š
- é«˜æ³¢åŠ¨æ ‡çš„å¯èƒ½è§¦å‘æ›´å¤§æ­¢æŸ
- ç»„åˆæ•´ä½“æ³¢åŠ¨ç‡ä¸å¯æ§

#### 3. æ— ç›¸å…³æ€§åˆ†æ
**é—®é¢˜æè¿°**ï¼š
- ä¹°å…¥å¤šåªé«˜åº¦ç›¸å…³æ ‡çš„ï¼ˆå¦‚å¤šåªç§‘æŠ€ETFï¼‰
- æœªå®ç°çœŸæ­£çš„é£é™©åˆ†æ•£

**é£é™©**ï¼š
- ç³»ç»Ÿæ€§é£é™©é›†ä¸­
- è¡Œä¸šå´©ç›˜æ—¶æŸå¤±æ”¾å¤§

---

### ä¼˜åŒ–æ–¹æ¡ˆ

#### æ–¹æ¡ˆAï¼šå›ºå®šå•ä»“ä½ä¸Šé™ï¼ˆå¿«é€Ÿå®æ–½ï¼‰â­ æ¨è

**æ ¸å¿ƒé€»è¾‘**ï¼š
```python
# å½“å‰é€»è¾‘ï¼ˆæœ‰é—®é¢˜ï¼‰
cash_per_position = total_cash / n_buy_signals

# ä¼˜åŒ–åé€»è¾‘
MAX_POSITION_PCT = 0.05  # å•ä»“ä½ä¸Šé™5%
cash_per_position = min(total_cash / n_buy_signals, total_cash * MAX_POSITION_PCT)
```

**å®æ–½ä½ç½®**ï¼š
- `generate_signals.py:451` (æ— çŠ¶æ€æ¨¡å¼)
- `portfolio_manager.py:440` (æŒä»“ç®¡ç†æ¨¡å¼)

**æ•ˆæœ**ï¼š
- 1ä¸ªä¿¡å·ï¼šåˆ†é…5%èµ„é‡‘ï¼Œå‰©ä½™95%ç°é‡‘ç­‰å¾…
- 3ä¸ªä¿¡å·ï¼šåˆ†é…15%èµ„é‡‘ï¼ˆ3 Ã— 5%ï¼‰
- 10ä¸ªä¿¡å·ï¼šåˆ†é…50%èµ„é‡‘ï¼ˆ10 Ã— 5%ï¼‰
- 20+ä¸ªä¿¡å·ï¼šç­‰æƒåˆ†é…ï¼ˆæ¯ä¸ªâ‰¤5%ï¼‰

**é…ç½®å‚æ•°ï¼ˆç»Ÿä¸€åœ¨ generate_daily_signals.sh ä¸­ç®¡ç†ï¼‰**ï¼š

```bash
--max-position-pct <0.0-1.0>     # å•ä»“ä½ä¸Šé™ï¼ˆé»˜è®¤0.05ï¼Œå³5%ï¼‰
--min-buy-signals <n>            # æœ€å°ä¹°å…¥ä¿¡å·æ•°ï¼ˆé»˜è®¤1ï¼‰
```

**å‚æ•°è¯´æ˜**ï¼š

**1. `--max-position-pct`ï¼ˆå•ä»“ä½ä¸Šé™ï¼‰**
- **å«ä¹‰**ï¼šå•ä¸ªæ ‡çš„æœ€å¤šå ç”¨æ€»èµ„é‡‘çš„ç™¾åˆ†æ¯”
- **é»˜è®¤å€¼**ï¼š0.05ï¼ˆ5%ï¼‰
- **ä½œç”¨**ï¼šé˜²æ­¢å•ä¸€æ ‡çš„é£é™©è¿‡åº¦é›†ä¸­
- **ç¤ºä¾‹**ï¼š
  - æ€»èµ„é‡‘10ä¸‡ï¼Œè®¾ç½®0.05 â†’ å•ä¸ªæ ‡çš„æœ€å¤šä¹°å…¥5000å…ƒ
  - æ€»èµ„é‡‘10ä¸‡ï¼Œè®¾ç½®0.10 â†’ å•ä¸ªæ ‡çš„æœ€å¤šä¹°å…¥10000å…ƒ

**2. `--min-buy-signals`ï¼ˆæœ€å°ä¹°å…¥ä¿¡å·æ•°ï¼‰**
- **å«ä¹‰**ï¼šå½“ä¹°å…¥ä¿¡å·æ•°é‡å°‘äºæ­¤å€¼æ—¶ï¼Œç³»ç»Ÿä¸æ‰§è¡Œä¹°å…¥æ“ä½œï¼Œç»§ç»­æŒæœ‰ç°é‡‘ç­‰å¾…æ›´å¤šæœºä¼š
- **é»˜è®¤å€¼**ï¼š1ï¼ˆæœ‰ä¿¡å·å°±ä¹°å…¥ï¼‰
- **ä½œç”¨**ï¼šæ§åˆ¶åˆ†æ•£ç¨‹åº¦ï¼Œé¿å…èµ„é‡‘è¿‡äºé›†ä¸­åœ¨å°‘æ•°æ ‡çš„
- **ä½¿ç”¨åœºæ™¯**ï¼š
  - **è®¾ä¸º1**ï¼ˆæ¨èé»˜è®¤å€¼ï¼‰ï¼šæœ‰ä¹°å…¥ä¿¡å·å°±ä¹°å…¥ï¼Œä½†å—å•ä»“ä½ä¸Šé™ä¿æŠ¤ï¼ˆæ¯ä¸ªæœ€å¤š5%ï¼‰
    - âœ… ä¼˜ç‚¹ï¼šä¸é”™è¿‡äº¤æ˜“æœºä¼šï¼Œå•ä»“ä½ä¸Šé™å·²ç»æä¾›é£é™©ä¿æŠ¤
    - âœ… é€‚ç”¨ï¼šå¯¹ç­–ç•¥æœ‰ä¿¡å¿ƒï¼Œå¸Œæœ›å……åˆ†åˆ©ç”¨æ¯ä¸ªä¿¡å·
  - **è®¾ä¸º3-5**ï¼ˆä¿å®ˆç­–ç•¥ï¼‰ï¼šå¿…é¡»æœ‰3-5ä¸ªä¹°å…¥ä¿¡å·æ‰ä¹°å…¥ï¼Œç¡®ä¿ä¸€å®šçš„åˆ†æ•£åº¦
    - âœ… ä¼˜ç‚¹ï¼šå¼ºåˆ¶åˆ†æ•£æŠ•èµ„ï¼Œé™ä½ç»„åˆæ³¢åŠ¨
    - âš ï¸ ç¼ºç‚¹ï¼šå¯èƒ½é”™è¿‡éƒ¨åˆ†äº¤æ˜“æœºä¼šï¼Œèµ„é‡‘åˆ©ç”¨ç‡è¾ƒä½
  - **ä¸å»ºè®®è®¾å¤ªé«˜**ï¼šå¦‚æœæ‚¨çš„è‚¡ç¥¨æ± åªæœ‰10-20ä¸ªæ ‡çš„ï¼Œè®¾ä¸º10+ä¼šå¯¼è‡´å‡ ä¹æ²¡æœ‰äº¤æ˜“æœºä¼š

**å…¸å‹é…ç½®ç¤ºä¾‹**ï¼š

```bash
# é…ç½®1ï¼šç§¯æç­–ç•¥ï¼ˆæ¨èï¼‰
# æœ‰ä¿¡å·å°±ä¹°ï¼Œå•ä»“ä½5%ä¿æŠ¤
./generate_daily_signals.sh --analyze \
  --stock-list pool.csv \
  --portfolio-file portfolio.json \
  --max-position-pct 0.05 \
  --min-buy-signals 1

# é…ç½®2ï¼šç¨³å¥ç­–ç•¥
# è‡³å°‘3ä¸ªä¿¡å·æ‰ä¹°ï¼Œå•ä»“ä½8%
./generate_daily_signals.sh --analyze \
  --stock-list pool.csv \
  --portfolio-file portfolio.json \
  --max-position-pct 0.08 \
  --min-buy-signals 3

# é…ç½®3ï¼šä¿å®ˆç­–ç•¥
# è‡³å°‘5ä¸ªä¿¡å·ï¼Œå•ä»“ä½5%
./generate_daily_signals.sh --analyze \
  --stock-list pool.csv \
  --portfolio-file portfolio.json \
  --max-position-pct 0.05 \
  --min-buy-signals 5
```

**å¦‚ä½•é€‰æ‹©å‚æ•°**ï¼š

| æ‚¨çš„æƒ…å†µ | max-position-pct | min-buy-signals | è¯´æ˜ |
|---------|------------------|-----------------|------|
| 10-20ä¸ªæ ‡çš„ï¼ŒåŠå¹´ä¸å˜ | 0.05 | 1 | æ¨èé»˜è®¤é…ç½®ï¼Œæœ‰ä¿¡å·å°±ä¹° |
| å¯¹å•ä¸ªæ ‡çš„æœ‰ä¿¡å¿ƒ | 0.10 | 1 | æé«˜å•ä»“ä½ä¸Šé™ |
| å¸Œæœ›å¼ºåˆ¶åˆ†æ•£ | 0.05 | 3-5 | ç­‰å¾…æ›´å¤šä¿¡å·å†ä¹°å…¥ |
| èµ„é‡‘é‡å¤§ï¼ˆ50ä¸‡+ï¼‰ | 0.05 | 5-10 | å¼ºåˆ¶é«˜åº¦åˆ†æ•£ |

---

#### æ–¹æ¡ˆBï¼šåŸºäºæ³¢åŠ¨ç‡çš„é£é™©è°ƒæ•´ï¼ˆä¸­çº§ï¼‰

**æ ¸å¿ƒé€»è¾‘**ï¼š
```python
class RiskAdjustedAllocation:
    def calculate_position_size(self, signals, portfolio):
        """åŸºäºæ³¢åŠ¨ç‡å’ŒATRåŠ¨æ€è°ƒæ•´ä»“ä½"""
        positions = []

        for signal in signals:
            # 1. è®¡ç®—æ ‡çš„æ³¢åŠ¨ç‡æŒ‡æ ‡
            volatility = self.calculate_volatility(signal['ts_code'], window=20)  # 20æ—¥æ³¢åŠ¨ç‡
            atr = self.calculate_atr(signal['ts_code'], window=14)  # 14æ—¥ATR

            # 2. å›ºå®šåˆ†æ•°é£é™©æ¨¡å‹ï¼ˆæ¯ç¬”äº¤æ˜“é£é™©2%ï¼‰
            risk_per_trade = portfolio.cash * 0.02
            stop_loss_distance = atr * 2  # 2å€ATRæ­¢æŸ

            # 3. è®¡ç®—ä»“ä½å¤§å°
            position_size = risk_per_trade / stop_loss_distance
            shares = self.calculate_shares(position_size, signal['price'])

            # 4. ç”ŸæˆæŒä»“å»ºè®®
            positions.append({
                'ts_code': signal['ts_code'],
                'shares': shares,
                'max_cost': position_size,
                'stop_loss': signal['price'] - stop_loss_distance,
                'risk_score': volatility,
                'atr': atr
            })

        return positions

    def calculate_volatility(self, ts_code: str, window: int = 20) -> float:
        """è®¡ç®—å†å²æ³¢åŠ¨ç‡ï¼ˆå¹´åŒ–ï¼‰"""
        data = self.load_data(ts_code)
        returns = data['Close'].pct_change().dropna()
        volatility = returns.rolling(window).std().iloc[-1] * np.sqrt(252)
        return volatility

    def calculate_atr(self, ts_code: str, window: int = 14) -> float:
        """è®¡ç®—å¹³å‡çœŸå®æ³¢å¹…"""
        data = self.load_data(ts_code)
        high = data['High']
        low = data['Low']
        close_prev = data['Close'].shift(1)

        tr1 = high - low
        tr2 = abs(high - close_prev)
        tr3 = abs(low - close_prev)

        tr = pd.concat([tr1, tr2, tr3], axis=1).max(axis=1)
        atr = tr.rolling(window).mean().iloc[-1]
        return atr
```

**å®æ–½è¯´æ˜**ï¼š
1. åœ¨ `generate_signals.py` ä¸­æ·»åŠ  `RiskAdjustedAllocation` ç±»
2. æ–°å¢ `--allocation-method` å‚æ•°ï¼š`equal_weight` | `risk_adjusted`
3. é›†æˆåˆ° `SignalGenerator._allocate_cash()` æ–¹æ³•

**ä¼˜åŠ¿**ï¼š
- é«˜æ³¢åŠ¨æ ‡çš„è‡ªåŠ¨é™ä½ä»“ä½
- ç»Ÿä¸€é£é™©æ°´å¹³ï¼ˆæ¯ç¬”2%ï¼‰
- åŸºäºATRçš„ç§‘å­¦æ­¢æŸä½

---

#### æ–¹æ¡ˆCï¼šç›¸å…³æ€§çº¦æŸç»„åˆä¼˜åŒ–ï¼ˆé«˜çº§ï¼‰

**æ ¸å¿ƒé€»è¾‘**ï¼š
```python
import numpy as np
from scipy.optimize import minimize

class PortfolioOptimizer:
    def optimize_weights(self, signals, max_correlation=0.7):
        """åŸºäºç›¸å…³æ€§çº¦æŸçš„ç»„åˆä¼˜åŒ–"""
        # 1. è·å–æ ‡çš„åˆ—è¡¨
        ts_codes = [s['ts_code'] for s in signals]

        # 2. è®¡ç®—æ”¶ç›Šç‡ç›¸å…³æ€§çŸ©é˜µ
        returns = self.get_returns_matrix(ts_codes, window=60)
        corr_matrix = returns.corr()

        # 3. è¿‡æ»¤é«˜ç›¸å…³æ ‡çš„
        selected = []
        for ts_code in ts_codes:
            # æ£€æŸ¥ä¸å·²é€‰æ ‡çš„çš„ç›¸å…³æ€§
            if not selected:
                selected.append(ts_code)
                continue

            max_corr_with_selected = corr_matrix.loc[ts_code, selected].max()
            if max_corr_with_selected < max_correlation:
                selected.append(ts_code)

        # 4. ç­‰æƒæˆ–æœ€å°æ–¹å·®åˆ†é…
        n_selected = len(selected)
        weights = {ts: 1.0 / n_selected for ts in selected}

        return weights, selected
```

**å®æ–½è¯´æ˜**ï¼š
1. éœ€è¦å®‰è£… `scipy`ï¼š`pip install scipy`
2. æ–°å¢ `--max-correlation` å‚æ•°ï¼ˆé»˜è®¤0.7ï¼‰
3. åœ¨ `generate_trade_plan()` å‰è°ƒç”¨ç›¸å…³æ€§è¿‡æ»¤

**ä¼˜åŠ¿**ï¼š
- é¿å…æŒæœ‰é«˜åº¦ç›¸å…³æ ‡çš„
- å®ç°çœŸæ­£çš„é£é™©åˆ†æ•£
- å¯æ‰©å±•è‡³æœ€å°æ–¹å·®/æœ€å¤§å¤æ™®ä¼˜åŒ–

---

### å®æ–½ä¼˜å…ˆçº§

| æ–¹æ¡ˆ | å¤æ‚åº¦ | å®æ–½æ—¶é—´ | é£é™©æ”¶ç›Šæ¯” | æ¨èåº¦ |
|------|--------|----------|------------|--------|
| **æ–¹æ¡ˆAï¼šå›ºå®šä»“ä½ä¸Šé™** | ä½ | 30åˆ†é’Ÿ | é«˜ | â­â­â­â­â­ |
| æ–¹æ¡ˆBï¼šæ³¢åŠ¨ç‡è°ƒæ•´ | ä¸­ | 2-3å°æ—¶ | ä¸­ | â­â­â­â­ |
| æ–¹æ¡ˆCï¼šç›¸å…³æ€§ä¼˜åŒ– | é«˜ | 1å¤© | ä¸­ | â­â­â­ |

**å»ºè®®è·¯å¾„**ï¼š
1. **ç«‹å³å®æ–½æ–¹æ¡ˆA**ï¼ˆä¿æŠ¤ç°æœ‰èµ„é‡‘ï¼Œé»˜è®¤é…ç½®ï¼šå•ä»“ä½5%ï¼Œæœ‰ä¿¡å·å°±ä¹°å…¥ï¼‰
2. **å®ç›˜æµ‹è¯•2å‘¨åè¯„ä¼°**ï¼Œè‹¥éœ€è¦æ›´ç²¾ç»†æ§åˆ¶ï¼Œå†å®æ–½æ–¹æ¡ˆB
3. **æ–¹æ¡ˆCé€‚åˆèµ„é‡‘é‡è¾ƒå¤§**ï¼ˆ50ä¸‡+ï¼‰æˆ–ä¸“ä¸šæŠ•èµ„è€…

**æ–¹æ¡ˆAé»˜è®¤é…ç½®ï¼ˆ10-20ä¸ªæ ‡çš„æ± é€‚ç”¨ï¼‰**ï¼š
- `--max-position-pct 0.05` ï¼ˆå•ä»“ä½ä¸Šé™5%ï¼‰
- `--min-buy-signals 1` ï¼ˆæœ‰ä¿¡å·å°±ä¹°å…¥ï¼Œä¸ç­‰å¾…ï¼‰
- ä¼˜åŠ¿ï¼šé£é™©ç”±å•ä»“ä½ä¸Šé™æ§åˆ¶ï¼Œä¸é”™è¿‡äº¤æ˜“æœºä¼šï¼Œèµ„é‡‘è‡ªåŠ¨åˆ†æ•£

---

### æ–¹æ¡ˆAå®æ–½ç¤ºä¾‹

#### ä¿®æ”¹ç‚¹1ï¼š`generate_signals.py` (æ— çŠ¶æ€æ¨¡å¼)

**ä½ç½®**ï¼š`generate_signals.py:449-451`

**å½“å‰ä»£ç **ï¼š
```python
# è®¡ç®—æ¯ä¸ªæ ‡çš„çš„åˆ†é…èµ„é‡‘ï¼ˆç­‰æƒé‡ï¼‰
n_positions = len(buy_signals)
cash_per_position = self.cash / n_positions
```

**ä¿®æ”¹ä¸º**ï¼š
```python
# è®¡ç®—æ¯ä¸ªæ ‡çš„çš„åˆ†é…èµ„é‡‘ï¼ˆå¸¦å•ä»“ä½ä¸Šé™ï¼‰
n_positions = len(buy_signals)
MAX_POSITION_PCT = 0.05  # å•ä»“ä½ä¸Šé™5%ï¼Œå¯é…ç½®
cash_per_position = min(self.cash / n_positions, self.cash * MAX_POSITION_PCT)
```

#### ä¿®æ”¹ç‚¹2ï¼š`portfolio_manager.py` (æŒä»“ç®¡ç†æ¨¡å¼)

**ä½ç½®**ï¼š`portfolio_manager.py:439-440`

**å½“å‰ä»£ç **ï¼š
```python
if buy_candidates and available_cash > 0:
    cash_per_position = available_cash / len(buy_candidates)
```

**ä¿®æ”¹ä¸º**ï¼š
```python
if buy_candidates and available_cash > 0:
    MAX_POSITION_PCT = 0.05  # å•ä»“ä½ä¸Šé™5%ï¼Œå¯é…ç½®
    total_capital = self.portfolio.cash + self.portfolio.get_total_cost()  # æ€»èµ„äº§
    cash_per_position = min(
        available_cash / len(buy_candidates),
        total_capital * MAX_POSITION_PCT
    )
```

#### ä¿®æ”¹ç‚¹3ï¼šæ·»åŠ å‘½ä»¤è¡Œå‚æ•°

**ä½ç½®**ï¼š`generate_daily_signals.sh` å’Œ `generate_signals.py` å‚æ•°è§£æ

**æ–°å¢å‚æ•°ï¼ˆç»Ÿä¸€åœ¨ generate_daily_signals.sh ä¸­ç®¡ç†ï¼‰**ï¼š
```bash
--max-position-pct <0.0-1.0>     # å•ä»“ä½ä¸Šé™ï¼ˆé»˜è®¤0.05ï¼Œå³5%ï¼‰
--min-buy-signals <n>            # æœ€å°ä¹°å…¥ä¿¡å·æ•°ï¼ˆé»˜è®¤1ï¼Œæœ‰ä¿¡å·å°±ä¹°å…¥ï¼‰
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```bash
# ç¤ºä¾‹1ï¼šä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆæ¨èï¼‰
./generate_daily_signals.sh \
  --analyze \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/portfolio.json
# é»˜è®¤ï¼šå•ä»“ä½5%ï¼Œæœ‰1ä¸ªä¿¡å·å°±ä¹°å…¥

# ç¤ºä¾‹2ï¼šæé«˜å•ä»“ä½ä¸Šé™åˆ°10%
./generate_daily_signals.sh \
  --analyze \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/portfolio.json \
  --max-position-pct 0.10

# ç¤ºä¾‹3ï¼šä¿å®ˆç­–ç•¥ï¼Œè‡³å°‘3ä¸ªä¿¡å·æ‰ä¹°å…¥
./generate_daily_signals.sh \
  --analyze \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/portfolio.json \
  --min-buy-signals 3

# ç¤ºä¾‹4ï¼šè‡ªå®šä¹‰ç»„åˆ
./generate_daily_signals.sh \
  --analyze \
  --stock-list results/trend_etf_pool.csv \
  --portfolio-file positions/portfolio.json \
  --max-position-pct 0.08 \
  --min-buy-signals 2
```

---

### é£é™©æ§åˆ¶æœ€ä½³å®è·µ

#### 1. ä»“ä½ç®¡ç†åŸåˆ™
- âœ… **å•ä»“ä½ä¸Šé™**ï¼šé»˜è®¤5%ï¼ˆ`--max-position-pct 0.05`ï¼‰ï¼Œå¯æ ¹æ®é£é™©åå¥½è°ƒæ•´åˆ°8%-10%
- âœ… **æœ€å°åˆ†æ•£**ï¼šé»˜è®¤æœ‰1ä¸ªä¿¡å·å°±ä¹°å…¥ï¼Œé£é™©ç”±å•ä»“ä½ä¸Šé™æ§åˆ¶
- âœ… **ç°é‡‘å‚¨å¤‡**ï¼šç³»ç»Ÿè‡ªåŠ¨ä¿ç•™æœªåˆ†é…èµ„é‡‘ï¼Œç”¨äºåç»­æœºä¼š
- âœ… **é¿å…æ»¡ä»“**ï¼šå½“ä¿¡å·è¾ƒå°‘æ—¶ï¼ˆå¦‚åªæœ‰1-2ä¸ªï¼‰ï¼Œç³»ç»Ÿåªåˆ†é…5%-10%èµ„é‡‘ï¼Œè‡ªåŠ¨ä¿æŒå¤§é‡ç°é‡‘
- âŒ **é¿å…å•ä¸€è¡Œä¸šé›†ä¸­**ï¼šå®šæœŸæ£€æŸ¥æŒä»“æ ‡çš„çš„è¡Œä¸šåˆ†å¸ƒ

**ç¤ºä¾‹åœºæ™¯**ï¼š
- 10ä¸‡èµ„é‡‘ï¼Œåªæœ‰1ä¸ªä¹°å…¥ä¿¡å· â†’ ä¹°å…¥5000å…ƒï¼ˆ5%ï¼‰ï¼Œä¿ç•™95000ç°é‡‘
- 10ä¸‡èµ„é‡‘ï¼Œæœ‰3ä¸ªä¹°å…¥ä¿¡å· â†’ æ¯ä¸ªä¹°å…¥5000å…ƒï¼ˆå…±15%ï¼‰ï¼Œä¿ç•™85000ç°é‡‘
- 10ä¸‡èµ„é‡‘ï¼Œæœ‰10ä¸ªä¹°å…¥ä¿¡å· â†’ æ¯ä¸ªä¹°å…¥5000å…ƒï¼ˆå…±50%ï¼‰ï¼Œä¿ç•™50000ç°é‡‘
- 10ä¸‡èµ„é‡‘ï¼Œæœ‰20ä¸ªä¹°å…¥ä¿¡å· â†’ æ¯ä¸ªä¹°å…¥5000å…ƒï¼ˆå…±100%ï¼‰ï¼Œå…¨ä»“

#### 2. æ­¢æŸæ­¢ç›ˆè®¾ç½®
- **å›ºå®šæ­¢æŸ**ï¼š-8%æˆ–2å€ATRï¼ˆè‡ªåŠ¨è§¦å‘ï¼‰
- **ç§»åŠ¨æ­¢ç›ˆ**ï¼šç›ˆåˆ©>10%åï¼Œå›æ’¤5%æ­¢ç›ˆ
- **æ—¶é—´æ­¢æŸ**ï¼šæŒä»“30å¤©æ— ç›ˆåˆ©ä¸”ä¿¡å·è½¬å¼±ï¼Œè€ƒè™‘ç¦»åœº

#### 3. åˆ†æ‰¹å»ºä»“ç­–ç•¥
```python
# ä¿¡å·å¼ºåº¦ < 1.5%ï¼šå»ºä»“50%
# ä¿¡å·å¼ºåº¦ â‰¥ 1.5%ï¼šå»ºä»“100%
if signal_strength < 1.5:
    shares = int(shares * 0.5)
```

#### 4. ç›‘æ§æŒ‡æ ‡
- **ç»„åˆæ³¢åŠ¨ç‡**ï¼šåº”<æ ‡çš„å¹³å‡æ³¢åŠ¨ç‡
- **æœ€å¤§å›æ’¤**ï¼šè§¦åŠ-10%éœ€å®¡æŸ¥ç­–ç•¥
- **èƒœç‡**ï¼šåº”>55%ï¼ˆåŒå‡çº¿ç­–ç•¥åŸºçº¿ï¼‰
- **ç›ˆäºæ¯”**ï¼šåº”>1.5ï¼ˆå¹³å‡ç›ˆåˆ©/å¹³å‡äºæŸï¼‰

---

### éªŒè¯æµ‹è¯•å»ºè®®

å®æ–½ä¿®æ”¹åï¼Œå»ºè®®è¿›è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

```bash
# 1. å•ä¿¡å·æµ‹è¯•ï¼ˆåº”åˆ†é…â‰¤5%ï¼‰
./generate_daily_signals.sh \
  --analyze \
  --stock-list test/single_signal.csv \
  --portfolio-file test/portfolio.json \
  --max-position-pct 0.05

# 2. å¤šä¿¡å·æµ‹è¯•ï¼ˆåº”æ€»è®¡â‰¤100%ï¼‰
./generate_daily_signals.sh \
  --analyze \
  --stock-list test/multi_signals.csv \
  --portfolio-file test/portfolio.json \
  --max-position-pct 0.05

# 3. å›æµ‹éªŒè¯ï¼ˆå¯¹æ¯”ä¿®æ”¹å‰åæ”¶ç›Š/å›æ’¤ï¼‰
./run_backtest.sh \
  --stock-list results/trend_etf_pool.csv \
  --optimize \
  --test-position-limit  # æ–°å¢æµ‹è¯•æ¨¡å¼
```

**é¢„æœŸç»“æœ**ï¼š
- æœ€å¤§å›æ’¤é™ä½15%-25%
- å¤æ™®æ¯”ç‡æå‡10%-20%
- èƒœç‡ä¿æŒä¸å˜æˆ–ç•¥é™ï¼ˆæ›´ä¿å®ˆï¼‰
