# 美股回测系统使用指南

## 项目简介

这是一个基于 backtesting.py 框架的美股回测系统，专门用于对特斯拉和英伟达股票进行交易策略回测。系统实现了经典的双均线交叉策略，支持参数优化，并能够生成详细的统计报告和交互式图表。

## 系统特性

- ✅ 自动加载理杏仁网站格式的股价数据
- ✅ 双均线交叉策略 (SMA Crossover)
- ✅ 参数优化支持
- ✅ 详细的回测统计报告 (CSV格式)
- ✅ 交互式可视化图表 (HTML格式)
- ✅ 支持单股票或批量回测
- ✅ 自定义初始资金和手续费率

## 环境要求

- **操作系统**: Linux / WSL / macOS
- **Python版本**: 3.9+
- **Conda环境**: backtesting
- **依赖包**: pandas, numpy, bokeh, backtesting

## 快速开始

### 1. 环境设置

确保已安装并激活 backtesting conda 环境：

```bash
# 如果环境不存在，先创建
conda create -n backtesting python=3.9

# 激活环境
conda activate backtesting

# 安装项目依赖
cd /mnt/d/git/backtesting
pip install -e .
```

### 2. 数据准备

股价数据应放在 `data/american_stocks/` 目录下，CSV格式，包含以下字段：
- 日期
- 股价(美元)

当前已包含：
- 特斯拉 (Tesla): 2010-06-29 至 2025-10-29
- 英伟达 (NVIDIA): 1999-01-22 至 2025-10-29

### 3. 运行回测

使用 shell 脚本执行回测：

```bash
# 查看帮助信息
bash run_backtest.sh -h

# 对特斯拉运行回测
bash run_backtest.sh -s tesla -t sma_cross

# 对所有股票运行回测
bash run_backtest.sh -s all -t sma_cross

# 启用参数优化
bash run_backtest.sh -s tesla -t sma_cross -o

# 自定义初始资金和手续费
bash run_backtest.sh -s nvidia -t sma_cross -c 0.001 -m 50000
```

## 命令行参数

| 参数 | 完整名称 | 说明 | 默认值 |
|------|---------|------|--------|
| `-s` | `--stock` | 股票选择: tesla, nvidia, all | all |
| `-t` | `--strategy` | 策略选择: sma_cross, all | sma_cross |
| `-o` | `--optimize` | 启用参数优化 | 否 |
| `-c` | `--commission` | 手续费率 | 0.002 (0.2%) |
| `-m` | `--cash` | 初始资金(美元) | 10000 |
| `-d` | `--output-dir` | 输出目录 | results |
| | `--data-dir` | 数据目录 | data/american_stocks |
| | `--start-date` | 开始日期 (YYYY-MM-DD) | 无 (使用全部数据) |
| | `--end-date` | 结束日期 (YYYY-MM-DD) | 无 (使用全部数据) |
| `-h` | `--help` | 显示帮助信息 | - |

## 策略说明

### 双均线交叉策略 (SMA Crossover)

**策略逻辑：**
- 计算短期移动平均线 (默认10天)
- 计算长期移动平均线 (默认20天)
- 当短期均线上穿长期均线时 → 买入信号（金叉）
- 当短期均线下穿长期均线时 → 卖出信号（死叉）

**默认参数：**
- `n1 = 10`：短期均线周期
- `n2 = 20`：长期均线周期

**优化参数范围：**
- 短期均线 (n1): 5, 10, 15, ..., 50
- 长期均线 (n2): 20, 40, 60, ..., 200
- 约束条件: n1 < n2

## 输出文件

回测完成后，结果保存在 `results/` 目录：

### 1. 统计报告 (results/stats/)

CSV格式，包含以下指标：

- **基本信息**: 股票名称、策略、日期范围
- **收益指标**: 收益率、年化收益率、买入持有收益率
- **风险指标**: 夏普比率、索提诺比率、最大回撤
- **交易指标**: 交易次数、胜率、盈亏比、平均交易
- **其他指标**: SQN、手续费总额等

文件命名格式: `{股票}_{策略}_{时间戳}.csv`

例如: `tesla_sma_cross_20251030_234355.csv`

### 2. 交易记录 (results/stats/)

每笔交易的详细记录，包括：
- 开仓/平仓时间和价格
- 持仓大小
- 盈亏金额和百分比
- 持仓时长

文件命名格式: `{股票}_{策略}_{时间戳}_trades.csv`

### 3. 交互式图表 (results/plots/)

HTML格式的交互式图表，包含：
- 📊 K线图（价格走势）
- 📈 双均线指标
- 🔵 买入信号标记
- 🔴 卖出信号标记
- 💰 权益曲线
- 📉 回撤曲线

文件命名格式: `{股票}_{策略}.html`

可以直接在浏览器中打开查看。

## 使用示例

### 示例 1: 快速测试单个股票

```bash
bash run_backtest.sh -s tesla -t sma_cross
```

**输出:**
```
======================================================================
回测: 特斯拉 - sma_cross
======================================================================

运行回测...

----------------------------------------------------------------------
回测结果
----------------------------------------------------------------------
初始资金:     $10,000.00
最终资金:     $24,935.23
收益率:       149.35%
年化收益率:   6.15%
夏普比率:     0.09
最大回撤:     -92.38%
交易次数:     212
胜率:         40.57%
盈亏比:       1.65
----------------------------------------------------------------------
```

### 示例 2: 批量回测所有股票

```bash
bash run_backtest.sh -s all -t sma_cross
```

生成汇总对比表：
```
======================================================================
回测汇总
======================================================================
股票              策略              收益率          夏普比率         最大回撤
----------------------------------------------------------------------
特斯拉             sma_cross           149.35%       0.09     -92.38%
英伟达             sma_cross           -97.45%      -0.25     -98.25%
======================================================================
```

### 示例 3: 参数优化

```bash
bash run_backtest.sh -s tesla -t sma_cross -o
```

系统会自动搜索最优参数组合（约200种组合），并输出：
```
开始参数优化...
参数空间: {'n1': range(5, 51, 5), 'n2': range(20, 201, 20)}

最优参数:
  短期均线 (n1): 15
  长期均线 (n2): 80
```

### 示例 4: 自定义配置

```bash
# 模拟大资金账户，低手续费
bash run_backtest.sh -s nvidia -t sma_cross -c 0.0005 -m 100000
```

### 示例 5: 限定日期范围 ⭐ 新功能

```bash
# 只分析最近5年的数据
bash run_backtest.sh -s tesla --start-date 2020-01-01

# 分析特定时间段（2015-2020）
bash run_backtest.sh -s nvidia --start-date 2015-01-01 --end-date 2020-12-31
```

**结果对比:**
```
英伟达 (NVIDIA) - 双均线策略
-------------------------------------------
全时段 (1999-2025):  收益率 -97.45% ❌
限定 (2015-2020):    收益率 +80.56% ✅
年化收益率:          10.36%
夏普比率:            0.21
```

💡 **建议**: 英伟达26年的历史数据跨度太长，包含多个市场周期，导致策略表现不佳。限定到特定时间段（如2015-2020）后，策略表现显著改善！

## 回测结果分析

### 特斯拉 (Tesla)

**表现:** ✅ 盈利
- 收益率: 149.35%
- 年化收益率: 6.15%
- 最大回撤: -92.38%
- 交易次数: 212
- 胜率: 40.57%

**分析:**
- 策略在特斯拉上总体盈利
- 但最大回撤很大 (-92%)，风险较高
- 胜率不高但盈亏比良好 (1.65)，说明盈利的交易幅度大于亏损
- 建议进行参数优化以提升表现

### 英伟达 (NVIDIA)

**表现:** ❌ 亏损
- 收益率: -97.45%
- 年化收益率: -12.83%
- 最大回撤: -98.25%
- 交易次数: 341
- 胜率: 39.00%

**分析:**
- 策略在英伟达上表现不佳
- 严重亏损，几乎损失所有本金
- 交易频繁但效果不好
- 双均线策略可能不适合英伟达的价格波动特性
- 需要考虑：
  - 调整参数范围
  - 尝试其他策略
  - 加入止损机制

## 常见问题

### Q1: 为什么英伟达表现这么差？

**A:** 几个可能原因：
1. **数据时间跨度过长**（1999-2025，26年），市场环境变化巨大
2. 双均线策略对剧烈波动的股票适应性差
3. 默认参数 (10/20) 可能不适合英伟达
4. 只有收盘价数据，无法构造完整OHLC

**解决方案 ⭐:**
```bash
# 限定到合理的时间范围（2015-2020）
bash run_backtest.sh -s nvidia --start-date 2015-01-01 --end-date 2020-12-31
```
**效果**: 收益率从 -97% 提升到 +80%！

**其他建议:**
- 运行参数优化: `bash run_backtest.sh -s nvidia -o`
- 尝试其他时间段: 2020-2025, 2010-2015 等

### Q2: 如何提升策略表现？

**A:** 改进方向：
1. **参数优化**: 使用 `-o` 参数找到最佳参数
2. **加入止损**: 实现带追踪止损的策略
3. **多指标结合**: 结合RSI、MACD等其他指标
4. **时间过滤**: 只在特定市场状态下交易
5. **头寸管理**: 根据信号强度调整仓位大小

### Q3: 警告信息 "insufficient margin" 是什么意思？

**A:** 这表示账户资金不足以执行订单。发生在：
- 连续亏损导致账户余额过低
- 股价波动太大，无法买入整股

**解决方案:**
- 增加初始资金: `-m 50000`
- 降低手续费: `-c 0.001`
- 调整策略参数以减少交易频率

### Q4: 如何查看具体的交易明细？

**A:** 交易明细保存在 `results/stats/*_trades.csv` 文件中，包含每笔交易的：
- 开仓/平仓时间
- 买入/卖出价格
- 盈亏金额
- 持仓时长

可以用Excel或Python pandas打开分析。

### Q5: 图表无法显示怎么办？

**A:** HTML图表文件保存在 `results/plots/` 目录，需要：
1. 将文件复制到Windows可访问的位置
2. 用浏览器打开HTML文件
3. 确保浏览器支持JavaScript

## 项目结构

```
backtesting/
├── data/
│   └── american_stocks/        # 股价数据CSV
├── strategies/
│   ├── __init__.py
│   └── sma_cross.py           # 双均线策略
├── utils/
│   ├── __init__.py
│   └── data_loader.py         # 数据加载模块
├── results/
│   ├── stats/                 # 统计报告
│   └── plots/                 # 可视化图表
├── backtest_runner.py         # Python执行器
├── run_backtest.sh            # Shell启动脚本
└── README_BACKTESTING.md      # 本文档
```

## 扩展开发

### 添加新策略

1. 在 `strategies/` 目录创建新文件
2. 继承 `Strategy` 基类
3. 实现 `init()` 和 `next()` 方法
4. 在 `backtest_runner.py` 的 `STRATEGIES` 字典中注册

示例：
```python
# strategies/my_strategy.py
from backtesting import Strategy

class MyStrategy(Strategy):
    def init(self):
        # 初始化指标
        pass

    def next(self):
        # 交易逻辑
        pass
```

### 添加新数据源

修改 `utils/data_loader.py` 中的 `load_lixinger_data()` 函数，支持新的CSV格式。

## 技术支持

如遇问题，请检查：
1. ✅ Conda环境是否正确激活
2. ✅ 数据文件路径是否正确
3. ✅ 依赖包是否完整安装
4. ✅ 查看错误日志信息

## 版本历史

### v1.0.0 (2025-10-30)
- ✅ 实现数据加载模块
- ✅ 实现双均线交叉策略
- ✅ 实现回测执行器
- ✅ 创建Shell启动脚本
- ✅ 支持参数优化
- ✅ 生成统计报告和图表

## 许可证

本项目基于 backtesting.py (AGPL-3.0) 开发。

---

**祝你回测愉快！** 📈🚀
