# 日期过滤功能使用指南

## 功能说明

日期过滤功能允许你限定回测的时间范围，这对于以下场景非常有用：
- 避免过长的历史数据影响策略表现
- 分析特定市场周期的策略效果
- 对比不同时间段的策略表现
- 排除异常时期的数据（如金融危机、疫情等）

## 参数说明

| 参数 | 格式 | 说明 | 示例 |
|------|------|------|------|
| `--start-date` | YYYY-MM-DD | 回测开始日期 | 2020-01-01 |
| `--end-date` | YYYY-MM-DD | 回测结束日期 | 2025-12-31 |

**注意:**
- 两个参数可以单独使用，也可以组合使用
- 日期格式必须是：`YYYY-MM-DD`（年-月-日）
- 如果不指定，则使用数据文件中的全部时间范围

## 使用示例

### 1. 只指定开始日期（分析最近几年）

```bash
# 只分析2020年之后的数据
bash run_backtest.sh -s tesla --start-date 2020-01-01

# 只分析2018年之后的数据
bash run_backtest.sh -s nvidia --start-date 2018-01-01
```

### 2. 只指定结束日期（分析历史数据）

```bash
# 只分析2020年之前的数据
bash run_backtest.sh -s tesla --end-date 2020-12-31

# 分析到2018年为止的数据
bash run_backtest.sh -s nvidia --end-date 2018-12-31
```

### 3. 同时指定开始和结束日期（特定时间段）

```bash
# 分析2015-2020年的数据
bash run_backtest.sh -s nvidia --start-date 2015-01-01 --end-date 2020-12-31

# 分析2018-2022年的数据
bash run_backtest.sh -s tesla --start-date 2018-01-01 --end-date 2022-12-31
```

### 4. 结合其他参数使用

```bash
# 日期过滤 + 参数优化
bash run_backtest.sh -s nvidia --start-date 2015-01-01 --end-date 2020-12-31 -o

# 日期过滤 + 自定义资金和手续费
bash run_backtest.sh -s tesla --start-date 2020-01-01 -m 50000 -c 0.001

# 对所有股票在特定时段运行
bash run_backtest.sh -s all --start-date 2020-01-01 --end-date 2023-12-31
```

## 实战案例

### 案例 1: 英伟达的最佳时间段

**问题:** 英伟达全时段回测亏损严重（-97.45%）

**解决方案:**
```bash
# 测试2015-2020年（AI芯片起飞期）
bash run_backtest.sh -s nvidia --start-date 2015-01-01 --end-date 2020-12-31
```

**结果:**
- 收益率: 从 -97.45% → +80.56% ✅
- 年化收益率: 10.36%
- 夏普比率: 0.21
- 最大回撤: 从 -98.25% → -67.00%

### 案例 2: 对比不同市场周期

```bash
# 测试牛市期间 (2015-2020)
bash run_backtest.sh -s nvidia --start-date 2015-01-01 --end-date 2020-12-31

# 测试最近期间 (2020-2025)
bash run_backtest.sh -s nvidia --start-date 2020-01-01

# 测试早期 (2010-2015)
bash run_backtest.sh -s nvidia --start-date 2010-01-01 --end-date 2015-12-31
```

### 案例 3: 排除异常时期

```bash
# 排除2020年疫情影响，只分析2021年之后
bash run_backtest.sh -s all --start-date 2021-01-01

# 排除2008金融危机，分析2010年之后
bash run_backtest.sh -s all --start-date 2010-01-01
```

## 技巧和建议

### ✅ 推荐做法

1. **根据股票上市时间选择**
   - 特斯拉: 2010年6月上市，建议从2010-07开始
   - 英伟达: 1999年上市，但建议从2010或2015开始

2. **选择完整的市场周期**
   - 5年为一个较好的周期（一个完整的市场周期）
   - 避免只选择1-2年，样本太小

3. **分段测试策略稳定性**
   ```bash
   # 测试不同时期的稳定性
   bash run_backtest.sh -s tesla --start-date 2010-01-01 --end-date 2015-12-31
   bash run_backtest.sh -s tesla --start-date 2015-01-01 --end-date 2020-12-31
   bash run_backtest.sh -s tesla --start-date 2020-01-01 --end-date 2025-12-31
   ```

4. **结合参数优化**
   ```bash
   # 在特定时段找最优参数
   bash run_backtest.sh -s nvidia --start-date 2015-01-01 --end-date 2020-12-31 -o
   ```

### ❌ 避免的做法

1. **时间跨度过长**
   - ❌ 不要用26年的数据（如英伟达1999-2025）
   - ✅ 建议5-10年的时间跨度

2. **时间跨度过短**
   - ❌ 不要只用1年的数据
   - ✅ 至少3-5年才有统计意义

3. **只测试牛市**
   - ❌ 只选择上涨期间会高估策略
   - ✅ 应该包含完整的市场周期

4. **忽视数据质量**
   - 检查起始日期是否有数据
   - 确保日期格式正确

## 数据可用时间范围

| 股票 | 完整数据范围 | 推荐分析范围 |
|------|------------|------------|
| 特斯拉 (TSLA) | 2010-06-29 至 2025-10-29 | 2015-01-01 至今 |
| 英伟达 (NVDA) | 1999-01-22 至 2025-10-29 | 2010-01-01 至今 |

## 日期格式参考

### 正确格式 ✅
```bash
--start-date 2020-01-01
--end-date 2025-12-31
```

### 错误格式 ❌
```bash
--start-date 2020/01/01      # 错误: 应该用 - 而不是 /
--start-date 01-01-2020      # 错误: 应该是 年-月-日 而不是 月-日-年
--start-date 2020-1-1        # 错误: 月份和日期应该是两位数
--start-date "2020-01-01"    # 可以工作但不需要引号
```

## 常见问题

### Q: 如果日期超出数据范围会怎样？

A: 系统会自动调整到数据的实际范围，并给出警告。

### Q: 可以只指定年份吗？

A: 不可以，必须指定完整的日期（年-月-日）。建议使用每年的1月1日或12月31日。

### Q: 日期过滤会影响参数优化吗？

A: 不会。参数优化会在过滤后的数据上进行，这样可以找到特定时期的最优参数。

### Q: 如何查看过滤掉了多少数据？

A: 运行回测时，系统会显示：
```
原始数据行数: 6736
应用开始日期过滤: 2015-01-01
应用结束日期过滤: 2020-12-31
过滤掉 5224 行数据
处理后数据行数: 1511
```

## 快速参考

```bash
# 快速模板
bash run_backtest.sh -s <股票> --start-date <YYYY-MM-DD> --end-date <YYYY-MM-DD>

# 常用时间段
最近5年:   --start-date 2020-01-01
最近10年:  --start-date 2015-01-01
2015-2020: --start-date 2015-01-01 --end-date 2020-12-31
```

---

**提示:** 日期过滤是改善回测结果的关键工具。合理选择时间范围可以显著提升策略表现！
