# 全池动态筛选投资组合回测方案

**需求编号**: REQ-20251213-PORTFOLIO-DYNAMIC
**优先级**: P1
**状态**: ✅ 方案确认，待开发
**创建日期**: 2025-12-13
**最后更新**: 2025-12-13
**关联文档**:
- `20251211_etf_trend_following_v2_requirement.md` (§16.4 已知问题与限制)
- `20251112_dynamic_pool_rotation_strategy.md` (轮动策略研究，Phase 4结论：固定池优于动态轮动)
- `20251210_trend_follow_pool_discussion_with_gemini.md` ⭐ **核心参考：现代CTA趋势跟踪实践**

---

## 目录

1. [问题陈述](#1-问题陈述)
2. [架构设计](#2-架构设计)
3. [实现方案](#3-实现方案)
4. [关键实现细节](#4-关键实现细节)
5. [与 backtesting.py 的复用边界](#5-与-backtestingpy-的复用边界)
6. [风险与缓解](#6-风险与缓解)
7. [验收标准](#7-验收标准)
8. [已确认决策](#8-已确认决策) ⭐ **用户确认**
9. [参考文档](#9-参考文档)
10. **[筛选逻辑对比分析](#10-筛选逻辑对比分析-gemini方案-vs-v2实现-vs-旧轮动实验)** ⭐ 核心章节

---

## 1. 问题陈述

### 1.1 当前实现状态

根据 `20251211_etf_trend_following_v2_requirement.md` §16.4：

> **投资组合级别回测**:
> - 单标回测：`BacktestRunner` 仍为"单标的独立回测"（依赖 backtesting.py 单标引擎）
> - ✅ 组合级回测：新增 `PortfolioBacktestRunner`，支持 TopN+缓冲带、分簇限额、波动率倒数仓位、佣金+固定滑点
> - ⚠️ **限制：组合级回测仍基于静态池文件/列表（非全池动态筛选），且与 backtesting.py 引擎路径独立**

### 1.2 核心问题分析

| 问题编号 | 问题描述 | 影响范围 |
|---------|---------|---------|
| **P1** | 缺乏全池动态筛选：当前 `PortfolioBacktestRunner` 只接受静态池文件或列表，无法在回测期间动态重新筛选ETF | 无法模拟真实的动态ETF筛选策略 |
| **P2** | backtesting.py 单标引擎限制：框架原生为单标的设计，不支持投资组合级别交易 | 投资组合级回测需独立实现撮合逻辑 |
| **P3** | 代码路径分离：`BacktestRunner` (单标, 复用backtesting.py) 与 `PortfolioBacktestRunner` (组合, 独立实现) 逻辑分离，维护成本高 | 两套代码，不同的撮合逻辑和统计计算 |

### 1.3 目标

1. **实现真正的全池动态筛选**：基于预计算轮动表，在回测期间按指定频率（如每5/10/20天）更新ETF池
2. **最大化复用 backtesting.py**：在单标策略执行层面复用 backtesting.py 的信号生成和撮合逻辑
3. **统一架构**：设计清晰的分层架构，明确哪些部分复用 backtesting.py，哪些部分需要独立实现
4. **轮动周期可配置**：支持灵活设置轮动周期，方便回测不同周期效果对比

---

## 2. 架构设计

### 2.1 核心洞察：分层复用策略

**关键认识**：backtesting.py 的核心价值不在于多标的撮合，而在于：
1. ✅ **单标策略逻辑** (`Strategy` 类的 `init()` / `next()` 框架)
2. ✅ **单标信号生成** (指标计算、买卖信号)
3. ✅ **单标撮合模拟** (单标的订单执行、成本计算)
4. ✅ **单标绩效统计** (夏普、回撤、胜率等)

**不在 backtesting.py 范围内**：
- ❌ 多标的资金分配
- ❌ 投资组合级仓位管理
- ❌ 动态ETF筛选
- ❌ 跨标的风险控制

### 2.2 分层架构设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Layer 4: Portfolio Orchestrator                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  DynamicPoolPortfolioRunner                                     │   │
│  │  - 全池动态筛选调度                                              │   │
│  │  - 投资组合级资金分配                                            │   │
│  │  - 跨标的风险控制（分簇限额、总仓位）                             │   │
│  │  - 投资组合级绩效统计聚合                                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                    │
│                                    ▼                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  预计算轮动表 (复用 etf_selector/ 生成)                         │   │
│  │  - 回测前一次性生成，确保可复现                                 │   │
│  │  - 严格按 as_of_date 筛选，避免未来信息                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    Layer 3: Signal Pipeline                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  SignalPipeline (现有，稍作扩展)                                 │   │
│  │  - 全池信号扫描                                                 │   │
│  │  - 动量评分 & 排名                                              │   │
│  │  - TopN + 缓冲带选股                                            │   │
│  │  - 风控检查（ATR/时间止损）                                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    Layer 2: Single-Asset Strategy                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  backtesting.py Strategy (复用)                                 │   │
│  │  - MACD/KAMA 等策略的 init() / next()                          │   │
│  │  - 指标计算 (self.I())                                         │   │
│  │  - 买卖信号生成                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Signal Generator (独立实现，已有)                              │   │
│  │  - MACDSignalGenerator / KAMASignalGenerator                    │   │
│  │  - 与 backtesting.py Strategy 逻辑对齐                          │   │
│  │  - 用于全池扫描（无需完整回测）                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    Layer 1: Portfolio Execution                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Portfolio (现有，稍作扩展)                                      │   │
│  │  - 多标的持仓管理                                               │   │
│  │  - T+1 约束                                                     │   │
│  │  - 交易指令生成 & 执行                                          │   │
│  │  - 权益曲线追踪                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ❌ 不复用 backtesting.py 的 _Broker（单标设计）                       │
│  ✅ 自研 Portfolio 类已实现多标的撮合                                  │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.3 复用边界明确

| 模块 | 复用 backtesting.py | 独立实现 | 说明 |
|------|---------------------|---------|------|
| 策略定义 (`Strategy` 基类) | ✅ | - | 继承 `Strategy`，定义 `init()` / `next()` |
| 指标计算 (`self.I()`) | ✅ | - | 复用 `_Indicator` 机制 |
| 单标信号生成 | ✅ (可选) | ✅ | 可用 `BacktestStrategy` 或独立 `SignalGenerator` |
| 单标完整回测 | ✅ | - | 用于单标验证和参数优化 |
| 全池信号扫描 | - | ✅ | `SignalGenerator` 高效扫描 |
| 轮动表预生成 | - | ✅ | 复用 `etf_selector/`，独立工具生成 |
| 投资组合撮合 | - | ✅ | `Portfolio` 类 |
| 组合级统计 | - | ✅ | 自定义聚合逻辑 |

---

## 3. 实现方案

### 3.1 方案概述

**核心思路**: 在现有 `PortfolioBacktestRunner` 基础上，增加**动态筛选调度层**，使其能够在回测期间按指定频率调用ETF筛选器，更新可交易标的池。

### 3.2 关键设计决策

#### 决策1: 筛选调度方式

**选项A**: 预计算轮动表（静态） ✅ **推荐**
- 回测前一次性生成整个时间段的轮动表
- 优点：性能好，可重复使用，便于调试
- 缺点：需要额外的预处理步骤

**选项B**: 实时筛选（动态）
- 回测过程中每个轮动日实时调用筛选器
- 优点：更灵活，可支持复杂筛选逻辑
- 缺点：性能差，不利于调试

**决策**: 采用**选项A（预计算轮动表）**，与现有动态轮动策略实验保持一致。

#### 决策2: 候选池数据加载策略

**背景**: 全池范围为**预过滤后的候选池（约150-200只ETF）**，非全市场1600+
- 流动性过滤：日均成交额 ≥ 5万元
- 上市时间过滤：上市 ≥ 60天

**方案**: 直接加载候选池全部数据
- 150-200只ETF的OHLCV数据量可控（约100-200MB）
- 无需复杂的分层加载，简化实现

#### 决策3: 复用 backtesting.py 的边界

**复用场景**:
1. 单标策略开发和验证（`BacktestRunner.run_single()`）
2. 参数优化（`Backtest.optimize()`）
3. 策略对比基准（单标独立回测聚合）

**不复用场景**:
1. 投资组合级别回测（用 `DynamicPoolPortfolioRunner`）
2. 实盘信号生成（用 `SignalPipeline`）

### 3.3 新增模块设计

#### 3.3.1 `DynamicPoolPortfolioRunner` 类

```python
# etf_trend_following_v2/src/dynamic_pool_runner.py

class DynamicPoolPortfolioRunner:
    """
    全池动态筛选投资组合回测运行器。

    核心功能:
    1. 加载预计算的轮动表（不支持实时筛选，确保可复现性）
    2. 在每个交易日执行信号扫描和组合决策
    3. 管理投资组合状态和交易执行
    4. 生成组合级绩效统计

    与现有模块的关系:
    - 扩展自 PortfolioBacktestRunner
    - 复用 SignalPipeline 进行信号生成
    - 复用 Portfolio 进行持仓管理
    - 轮动表由独立工具预生成（复用 etf_selector/）
    """

    def __init__(self, config: Config):
        self.config = config
        self.portfolio = Portfolio(...)
        self.signal_pipeline = SignalPipeline(config)

        # 动态筛选配置
        self.rotation_period_days: int = config.rotation.period_days  # 例如 5/10/20
        self.pool_size: int = config.rotation.pool_size  # 例如 20

        # 轮动表（预计算）
        self.rotation_schedule: Dict[str, List[str]] = {}

    def load_rotation_schedule(self, schedule_path: str) -> None:
        """加载预计算的轮动表"""
        ...

    def run(
        self,
        start_date: str,
        end_date: str,
        initial_capital: float = 1_000_000,
        output_dir: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        执行全池动态筛选回测。

        流程:
        1. 加载预计算的轮动表
        2. 加载候选池全部OHLCV数据
        3. 逐日迭代:
           a. 检查是否为轮动日 → 更新可交易池
           b. 执行信号扫描
           c. 生成交易指令
           d. 执行交易并更新持仓
           e. 记录权益曲线
        4. 生成绩效报告
        """
        ...
```

#### 3.3.2 配置扩展

```json
// config/example_config.json 扩展

{
  "rotation": {
    "period_days": 5,
    "pool_size": 20,
    "schedule_path": "results/rotation_schedules/rotation_5d.json"
  }
}
```

### 3.4 实现阶段

#### Phase 1: 轮动表集成 (复用现有)

**目标**: 使 `PortfolioBacktestRunner` 支持预计算轮动表

**工作项**:
1. 扩展 `PortfolioBacktestRunner` 配置，支持轮动表路径
2. 实现轮动表加载和日期匹配逻辑
3. 在轮动日更新可交易池
4. 单元测试

**预计工时**: 8小时

**复用现有代码**:
- `scripts/prepare_rotation_schedule.py` (轮动表生成)
- `backtest_runner/data/virtual_etf_builder.py` (数据加载)

#### Phase 2: 轮动表生成工具

**目标**: 提供轮动表预计算工具，支持不同轮动周期

**工作项**:
1. 扩展轮动表生成脚本，支持可配置周期（5/10/20天）
2. 封装 `etf_selector/` 调用接口，确保严格的 `as_of_date` 约束（避免未来信息）
3. 生成多个周期的轮动表文件，便于后续对比实验
4. 单元测试验证无前视偏差

**预计工时**: 8小时

#### Phase 3: 统一接口和文档

**目标**: 提供清晰的使用接口和文档

**工作项**:
1. CLI 参数扩展（`--enable-dynamic-filtering`, `--rotation-schedule`）
2. 更新 `run_backtest.sh` 脚本
3. 编写用户指南
4. 与现有单标回测的对比基准

**预计工时**: 8小时

---

## 4. 关键实现细节

### 4.1 避免未来信息泄露

**原则**: 在任意时点 T，筛选器只能使用 T 之前的数据

**实现**:
```python
def filter_etfs_as_of(self, as_of_date: str) -> List[str]:
    """
    以 as_of_date 为截止日期筛选ETF。

    确保:
    1. 评分使用的数据截止到 as_of_date
    2. 基本面数据（规模、流动性）使用 as_of_date 之前最近的可用值
    3. 不使用任何 as_of_date 之后的信息
    """
    ...
```

### 4.2 轮动日判定逻辑

```python
def is_rotation_day(self, current_date: str) -> bool:
    """
    判断是否为轮动日。

    条件: current_date 在预计算的轮动表中
    """
    return current_date in self.rotation_schedule
```

### 4.3 数据加载

```python
class CandidatePoolDataLoader:
    """
    候选池数据加载器。

    策略:
    - 直接加载预过滤候选池（150-200只）的全部OHLCV数据
    - 数据量可控，无需复杂的分层加载
    """

    def __init__(self, data_dir: str):
        self.data_dir = data_dir
        self.data_cache: Dict[str, pd.DataFrame] = {}

    def load_candidate_pool(
        self,
        symbols: List[str],
        start_date: str,
        end_date: str
    ) -> Dict[str, pd.DataFrame]:
        """一次性加载候选池全部数据"""
        for symbol in symbols:
            if symbol not in self.data_cache:
                self.data_cache[symbol] = self._load_single(symbol, start_date, end_date)
        return {s: self.data_cache[s] for s in symbols}

    def _load_single(self, symbol: str, start_date: str, end_date: str) -> pd.DataFrame:
        """加载单只ETF数据"""
        ...
```

---

## 5. 与 backtesting.py 的复用边界

### 5.1 明确复用场景

| 使用场景 | 推荐方案 | 说明 |
|---------|---------|------|
| 单标策略开发 | `BacktestRunner.run_single()` | 复用 backtesting.py |
| 单标参数优化 | `Backtest.optimize()` | 复用 backtesting.py |
| 多标聚合统计 | `BacktestRunner.run_universe()` | 独立回测后聚合 |
| **投资组合回测** | `DynamicPoolPortfolioRunner.run()` | **本方案** |
| 实盘信号生成 | `SignalPipeline.run()` | 独立实现 |

### 5.2 代码结构调整

```
etf_trend_following_v2/src/
├── backtest_runner.py           # 单标回测（复用 backtesting.py）✅ 已有
├── portfolio_backtest_runner.py # 静态池组合回测 ✅ 已有
├── dynamic_pool_runner.py       # 🆕 全池动态筛选组合回测
├── rotation_schedule_generator.py # 🆕 轮动表预生成工具
├── signal_pipeline.py           # 信号管线 ✅ 已有
├── portfolio.py                 # 持仓管理 ✅ 已有
└── strategies/
    ├── backtest_wrappers.py     # backtesting.py Strategy 包装 ✅ 已有
    ├── macd.py                  # MACD 信号生成器 ✅ 已有
    └── kama.py                  # KAMA 信号生成器 ✅ 已有
```

---

## 6. 风险与缓解

| 风险 | 影响 | 缓解措施 |
|-----|------|---------|
| 筛选器时间一致性 | 高 | 严格的 as_of_date 约束 + 单测 |
| 与现有代码冲突 | 低 | 新增模块，不修改现有逻辑 |
| 轮动表生成耗时 | 中 | 预计算 + 缓存轮动表文件 |
| 复杂度增加 | 中 | 清晰的分层架构 + 文档 |

---

## 7. 验收标准

### 7.1 功能验收

- [ ] 支持预计算轮动表加载
- [ ] 轮动周期可配置（5/10/20天等，默认5天）
- [ ] 池子大小可配置（10-50只）
- [ ] 无未来信息泄露（通过单测验证）
- [ ] 输出完整的组合级绩效报告

### 7.2 性能验收

- [ ] 候选池（150-200只ETF）2年回测 < 10分钟
- [ ] 内存占用 < 1GB

### 7.3 兼容性验收

- [ ] 现有单标回测功能不受影响
- [ ] 现有 `PortfolioBacktestRunner` 功能不受影响
- [ ] CLI 向后兼容

---

## 8. 已确认决策

以下为用户确认的关键设计决策（2025-12-13）：

### 8.1 参数选择 ✅

**决策**: 沿用v2当前参数（更激进风格）

| 参数 | 采用值 | Gemini建议 | 说明 |
|------|--------|-----------|------|
| ATR止损倍数 | 2.0 | 3.0 | 更紧的止损，快速止损 |
| 目标风险 | 2.0% | 0.5% | 更大仓位，更高风险敞口 |
| 相关性窗口 | 60天 | 120天 | 更敏感的聚类 |
| 时间止损 | 60天 | 20天 | 给予更多时间 |
| 聚类更新 | 20天 | 5天 | 更稳定的聚类结构 |

### 8.2 轮动周期 ✅

**决策**:
- **默认周期**: 5个交易日（每周轮动，与Gemini建议一致）
- **可配置性**: 必须支持灵活配置，方便日后测试不同周期（如10天、20天）

**轮动周期说明**：
轮动周期指**重新筛选ETF池的频率**，而非回测时间范围。

示例（轮动周期=5天）：
```
第1天:   从全池筛选Top 20 ETF → 可交易池A
第1-5天: 在池A中执行趋势策略
第6天:   重新筛选全池 → 可交易池B（可能与A不同）
第6-10天: 在池B中执行策略
...以此类推
```

### 8.3 回测时间范围 ✅

**决策**: 分段回测，覆盖不同市场环境

| 阶段 | 时间范围 | 市场特征 | 验证目标 |
|------|---------|---------|---------|
| 熊市 | 2022-01 ~ 2023-12 | 下跌震荡 | 验证空仓避险能力 |
| 牛市 | 2024-01 ~ 2025-11 | 上涨行情 | 验证趋势捕捉能力 |
| 全周期 | 2022-01 ~ 2025-11 | 完整牛熊 | 验证策略稳健性 |

### 8.4 全池范围 ✅

**决策**: 预过滤后的候选池（非全市场1600+）

**筛选规则**:
1. 流动性过滤：日均成交额 ≥ 5万元
2. 上市时间过滤：上市 ≥ 60天
3. 规模过滤：基金规模合理

**预期候选池规模**: 约150-200只ETF

### 8.5 筛选调度方式 ✅

**决策**: 预计算轮动表（选项A）

- 回测前一次性生成整个时间段的轮动表
- 严格防止前视偏差：每个时点的筛选只使用该时点之前的数据
- 便于调试和复现

### 8.6 再平衡模式 ✅

**决策**: 支持两种模式，默认增量调整

| 模式 | 说明 | 成本 | 适用场景 |
|------|------|------|---------|
| 增量调整 | 仅买卖差异部分 | 低 | **默认** |
| 全平仓重建 | 清仓后重新建仓 | 高 | 特殊测试 |

---

## 9. 参考文档

1. `etf_trend_following_v2/src/portfolio_backtest_runner.py` - 现有组合回测实现
2. `etf_trend_following_v2/src/signal_pipeline.py` - 信号管线
3. `scripts/prepare_rotation_schedule.py` - 轮动表生成
4. `etf_selector/` - ETF筛选器模块
5. `20251112_dynamic_pool_rotation_strategy.md` - 动态轮动实验（结论：固定池更优）

---

**文档状态**: ✅ 方案确认，待开发
**作者**: Claude
**最后更新**: 2025-12-13
**用户确认**: 2025-12-13（参数选择、轮动周期、回测范围、全池范围）

---

## 10. 筛选逻辑对比分析：Gemini方案 vs v2实现 vs 旧轮动实验

本节对比三套筛选逻辑的差异，帮助理解为什么旧轮动实验结论不置信，以及v2与Gemini最佳实践的对齐程度。

### 10.1 三套方案概览

| 维度 | Gemini CTA最佳实践 | v2 当前实现 | 旧轮动实验 (Phase 4) |
|------|-------------------|-------------|---------------------|
| **核心理念** | 全池监控 + 绝对趋势 + 相对排名 | 与Gemini高度对齐 | 简化版虚拟ETF合成 |
| **信号与排名耦合** | 方案B：先趋势信号，再排名选优 | ✅ 完全实现 | ❌ 无趋势信号过滤 |
| **聚类风控** | 层次聚类 + 簇内限额 | ✅ 完全实现 | ❌ 未实现 |
| **仓位管理** | 波动率倒数加权 + 多层约束 | ✅ 完全实现 | ❌ 等权分配 |
| **缓冲带** | 买Top10 / 持有到Top15 | ✅ 完全实现 | ❌ 未实现 |
| **ATR止损** | Chandelier Exit (3倍ATR) | ✅ 实现 (2倍ATR) | ❌ 无动态止损 |
| **回测可信度** | - | ⭐⭐⭐⭐⭐ | ⭐⭐ (过于简化) |

### 10.2 详细对比：核心模块

#### 10.2.1 动量评分逻辑

| 特性 | Gemini建议 | v2实现 | 旧轮动实验 | 对齐度 |
|------|-----------|--------|-----------|-------|
| **评分公式** | 多周期波动率加权动量 | ✅ `Σ(weight_i × return_i / volatility_i)` | 简单评分排序 | v2 ✅ |
| **周期权重** | 20d:60d:120d = 0.4:0.3:0.3 | 20d:60d:120d = 0.3:0.4:0.3 | 单一周期或简单平均 | v2 ✅ (微调) |
| **惯性加分** | 5%-10% (持仓优势) | 5% | ❌ 未实现 | v2 ✅ |
| **缓冲带机制** | 买Top10, 持有Top15 | 买Top10, 持有Top15 | ❌ 硬阈值切换 | v2 ✅ |
| **调仓频率** | 每周 (5天) | 每5天 ✅ | 30天/60天 | v2 ✅ |

**关键差异分析**:
- **旧轮动实验缺陷**: 无惯性加分导致频繁换手；无缓冲带导致排名抖动时反复买卖
- **v2优势**: 完整实现Gemini建议的防抖动机制

#### 10.2.2 聚类风控逻辑

| 特性 | Gemini建议 | v2实现 | 旧轮动实验 | 对齐度 |
|------|-----------|--------|-----------|-------|
| **聚类方法** | 层次聚类 + Ward连接 | ✅ 层次聚类 + average连接 | ❌ 未实现 | v2 ✅ |
| **距离公式** | `sqrt(2(1-ρ))` | ✅ 完全一致 | - | v2 ✅ |
| **相关性窗口** | 120天 | 60天 (更敏感) | - | v2 ⚠️ |
| **切割阈值** | 相关性 > 0.5 | 相关性 > 0.5 | - | v2 ✅ |
| **簇内限额** | 每簇最多2个持仓 | 每簇最多2个持仓 | ❌ 无限制 | v2 ✅ |
| **更新频率** | 每周 | 每20天 | - | v2 ⚠️ |

**关键差异分析**:
- **旧轮动实验缺陷**: 无聚类风控，可能同时持有多个高相关ETF（如3只半导体），一荣俱荣、一损俱损
- **v2优势**: 自动识别相关性，分散风险

#### 10.2.3 仓位管理逻辑

| 特性 | Gemini建议 | v2实现 | 旧轮动实验 | 对齐度 |
|------|-----------|--------|-----------|-------|
| **核心方法** | 波动率倒数加权 | ✅ 波动率倒数加权 | ❌ 等权分配 | v2 ✅ |
| **波动率估计** | EWMA (λ=0.94) | ✅ EWMA (λ=0.94) | - | v2 ✅ |
| **目标风险** | 每标的 0.5% 日波动 | 每标的 2% 日波动 | - | v2 ⚠️ 更激进 |
| **单标上限** | 20-30% | 15% | - | v2 ✅ |
| **簇上限** | 20% | 30% | - | v2 ⚠️ |
| **总仓位上限** | 100% | 95% | - | v2 ✅ |
| **最小现金** | - | 5% | - | v2 ✅ |

**关键差异分析**:
- **旧轮动实验缺陷**: 等权分配导致高波动标的贡献过大风险
- **v2优势**: 波动率倒数加权使每个持仓风险贡献均衡

#### 10.2.4 风控止损逻辑

| 特性 | Gemini建议 | v2实现 | 旧轮动实验 | 对齐度 |
|------|-----------|--------|-----------|-------|
| **ATR止损** | Chandelier Exit (3倍ATR) | ✅ (2倍ATR) | ❌ 无 | v2 ✅ (参数不同) |
| **止损只升不降** | ✅ | ✅ | - | v2 ✅ |
| **时间止损** | 20天 + 未盈利1×ATR | 60天 + 未盈利1×ATR | ❌ 无 | v2 ⚠️ 更宽松 |
| **熔断机制** | 大盘-5%或账户-3%禁开仓 | 大盘-10%或账户-3%禁开仓 | ❌ 无 | v2 ✅ |
| **T+1约束** | ✅ | ✅ | ❌ 未考虑 | v2 ✅ |

**关键差异分析**:
- **旧轮动实验缺陷**: 无止损机制，下跌时完全被动
- **v2优势**: 多层风控保护资金

#### 10.2.5 信号与排名耦合逻辑

| 特性 | Gemini建议 | v2实现 | 旧轮动实验 | 对齐度 |
|------|-----------|--------|-----------|-------|
| **核心逻辑** | 方案B：先信号后排名 | ✅ 方案B | ❌ 方案C (排名即信号) | v2 ✅ |
| **买入条件** | 有趋势信号 AND 排名Top10 | ✅ 完全一致 | 仅看排名 | v2 ✅ |
| **无信号时** | 空仓 | ✅ 空仓 | 按排名买入 | v2 ✅ |
| **信号优先级** | 止损 > 策略卖出 > 排名劣汰 | ✅ 完全一致 | 无层级 | v2 ✅ |

**关键差异分析**:
- **旧轮动实验缺陷**: 方案C（排名即信号）在熊市会买入"跌得最少的"，实际是接飞刀
- **v2优势**: 绝对趋势+相对排名双重确认，避免熊市错误买入

### 10.3 旧轮动实验失败原因剖析

根据 `20251112_dynamic_pool_rotation_strategy.md` Phase 4 结论：
> 固定池夏普 0.82 vs 30天轮动 0.40 vs 60天轮动 0.15

**失败归因**：

| 问题 | 旧实验做法 | 应有做法 (Gemini/v2) | 影响 |
|------|-----------|---------------------|------|
| **虚拟ETF合成法** | 等权组合多只ETF成"虚拟ETF" | 真实多标的组合回测 | 稀释强势ETF收益 |
| **无趋势信号过滤** | 仅按排名买入Top N | 先趋势信号，再排名选优 | 熊市接飞刀 |
| **无缓冲带** | 硬阈值切换 | 缓冲带 + 惯性加分 | 频繁换手，成本高 |
| **无聚类风控** | 可能同时持有多只高相关ETF | 簇内限额 | 风险集中 |
| **等权分配** | 每只ETF等权 | 波动率倒数加权 | 高波动标的风险贡献过大 |
| **无止损机制** | 无 | ATR移动止损 + 时间止损 | 下跌被动承受 |

**结论**: 旧轮动实验的"动态轮动劣于固定池"结论**不置信**，因为实验设计过于简化，未实现现代CTA的核心风控机制。

### 10.4 v2实现与Gemini建议的参数差异

虽然v2架构与Gemini高度对齐，但部分参数更激进：

| 参数 | Gemini建议 | v2实现 | 差异影响 | 建议调整 |
|------|-----------|--------|---------|---------|
| **ATR倍数** | 3.0 倍 | 2.0 倍 | v2止损更紧，可能过早止损 | 可测试3.0 |
| **目标风险** | 0.5% | 2.0% | v2单标仓位更大，风险更高 | 可测试0.5%-1.0% |
| **相关性窗口** | 120天 | 60天 | v2聚类更敏感，更频繁重组 | 可测试120天 |
| **时间止损天数** | 20天 | 60天 | v2给予更多时间，但可能占用资金 | 可测试20-30天 |
| **聚类更新频率** | 每周 (5天) | 每20天 | v2更稳定，但可能错过变化 | 可测试每周 |

### 10.5 本次实现的核心目标

基于以上分析，本次全池动态筛选实现应：

1. **复用v2已有模块**：评分、聚类、仓位、风控逻辑均已完善，直接复用
2. **补齐动态筛选能力**：在回测期间按频率更新可交易池
3. **严防前视偏差**：所有筛选使用 `as_of_date` 之前的数据
4. **验证Gemini方案**：通过严谨的全池动态筛选回测，验证现代CTA方法的有效性

### 10.6 预期改进效果

| 指标 | 旧轮动实验 | 预期本次实现 | 改进来源 |
|------|-----------|-------------|---------|
| 夏普比率 | 0.40 (30天轮动) | 0.8+ | 趋势信号过滤 + 缓冲带 + 止损 |
| 最大回撤 | -27% | -15%以内 | ATR止损 + 聚类风控 |
| 换手率 | 高 (无惯性) | 中低 | 惯性加分 + 缓冲带 |
| 熊市表现 | 差 (接飞刀) | 空仓避险 | 无信号时空仓 |

---

**本节总结**：v2已实现Gemini CTA最佳实践的90%+，旧轮动实验失败是因为设计过于简化。本次全池动态筛选将复用v2模块，补齐动态筛选能力，预期能验证现代CTA方法在A股ETF的有效性。
