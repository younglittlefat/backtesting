# 动态池子轮动策略实现需求

**需求编号**: REQ-20251112-ROTATION
**优先级**: P2 (研究性需求)
**状态**: 🔴 **Phase 1 受阻** - 遇到技术障碍，需调整方案
**创建日期**: 2025-11-12
**最后更新**: 2025-11-12 (Phase 1实施记录)

---

## 📋 目录

1. [需求背景](#1-需求背景)
2. [技术方案](#2-技术方案)
3. [开发进展](#3-开发进展-当前状态)
4. [实现路径](#4-实现路径分4个phase)
5. [技术细节](#5-技术细节补充)
6. [风险与假设](#6-风险与假设)
7. [验收标准](#7-验收标准)

---

## 1. 需求背景

### 1.1 当前问题
现有回测框架采用"固定池子"模式：
- ETF筛选器一次性选出20只标的 → 整个回测期（2023-11至2025-11）固定不变
- **局限性**: 无法适应市场环境变化，ETF趋势性可能衰减或新优质标的出现
- **未验证假设**: 动态调整池子是否能提升收益？

### 1.2 研究目标
**核心问题**: 定期重新筛选ETF池（如每30天）能否相比固定池提升风险调整后收益？

**关键评估维度**:
- 收益提升 vs 额外交易成本
- 最优轮动周期（7天/15天/30天/60天）
- 再平衡模式（全平仓 vs 增量调整）的影响

---

## 2. 技术方案

### 2.1 架构设计

#### 核心思路：元策略 + 预计算轮动表

```
[预处理阶段]
历史数据 → ETF筛选器(时序滑窗) → rotation_schedule.json
                ↓
        {
          "2023-11-01": ["159915.SZ", "510300.SH", ...],  # 20只
          "2023-12-01": ["159915.SZ", "515030.SH", ...],  # 池子可能变化
          ...
        }

[回测阶段]
rotation_schedule.json → RotationMetaStrategy → 连续回测
                              ↓
                  - 每个轮动日执行再平衡
                  - 对当前池子中的标的应用KAMA策略
                  - 准确计入交易成本
```

### 2.2 关键技术挑战

#### 挑战1: backtesting.py的单标的假设
**解决方案**: 等权组合法 - 将多标的合并为"虚拟ETF组合"

#### 挑战2: ⚠️ **ETF筛选器在时序窗口下的兼容性问题**（见§3开发进展）

---

## 3. 开发进展（当前状态）

### 3.1 Phase 1实施情况 ✅/❌

**实施日期**: 2025-11-12

#### ✅ 已完成的工作

| 交付物 | 状态 | 说明 |
|--------|------|------|
| `scripts/prepare_rotation_schedule.py` | ✅ 完成 | 轮动表生成主脚本（537行） |
| `scripts/generate_all_rotation_schedules.sh` | ✅ 完成 | 批量生成脚本 |
| `scripts/validate_rotation_schedule.py` | ✅ 完成 | 验证脚本（437行，带健康度评分） |
| 配置参数调优 | ✅ 完成 | 流动性阈值降至5万元，上市天数60天 |

**核心功能实现**：
- 轮动日期序列计算 ✅
- 多时点ETF筛选调度 ✅
- 换手率和稳定性统计 ✅
- JSON格式输出（metadata + schedule + statistics） ✅
- 完整验证框架（结构、日期、代码格式检查） ✅

#### ❌ 遇到的技术障碍

**问题描述**: ETF筛选器的第二级筛选在时点数据下失效

**症状**:
```bash
# 测试：截至2023-10-31的历史数据筛选
🔍 第一级筛选：流动性 + 上市时间
  ✅ 通过第一级筛选: 402只 (28.7%)

🧮 第二级筛选：趋势性量化分析
  ❌ 获得 0 只有效标的

结果：筛选失败，无符合条件的ETF
```

**根本原因分析**:

1. **评分阈值过严**: 第二级筛选要求ETF在ADX、趋势性等多维度指标上达到百分位阈值，截至2023-10-31的历史数据中，所有402只候选ETF均无法达标

2. **无偏评分系统的时效性**: 现有筛选器设计时使用的是**静态时间窗口**（固定start_date和end_date），未考虑**动态时点筛选**的场景，导致评分权重和阈值不适配

3. **市场环境因素**: 2023年中国A股市场整体趋势性较弱，可能导致ADX等趋势指标普遍偏低

**已尝试的解决方案**:
- ❌ 降低流动性阈值（1亿 → 5万） - 仅解决第一级，第二级仍失败
- ❌ 放宽ADX百分位（80% → 90%） - 第二级仍获得0只
- ❌ 缩短上市天数（180天 → 60天） - 第一级通过率提升，但第二级仍失败
- ❌ 使用全部历史数据（不限制120天窗口） - 第二级依然失效

**问题影响**:
- 🔴 **Phase 1 无法按原计划完成** - 轮动表生成依赖筛选器，筛选器失效导致无法生成有效轮动表
- 🔴 **Phase 2-4 受阻** - 后续虚拟ETF构建和实验依赖Phase 1的轮动表
- ⚠️ **预计延期1-2天** - 需深入调试或调整方案

---

### 3.2 替代方案

#### 方案A：深入调试ETF筛选器 ⚠️
**思路**: 分析第二级筛选的评分逻辑和阈值设置，针对时点数据场景优化

**优点**:
- ✅ 彻底解决问题，获得真正的动态筛选能力
- ✅ 可复用于未来其他时点筛选需求

**缺点**:
- ❌ 工作量大：需深入阅读`etf_selector/scoring.py`、`unbiased_indicators.py`等模块（~2000行）
- ❌ 风险高：可能影响现有筛选器的稳定性
- ❌ 时间成本：预计需要额外1-2天

**预估工期**: +1-2天

---

#### 方案B：基于现有trend_etf_pool.csv的简化轮动 ✅ **推荐**
**思路**: 使用已筛选好的20只ETF作为固定候选池，通过重新评分实现"小幅轮动"

**核心逻辑**:
```python
# 1. 加载现有的trend_etf_pool.csv（20只优质ETF）
fixed_candidates = load_csv("results/trend_etf_pool.csv")

# 2. 在每个轮动日期，对这20只重新计算简单指标评分
for rotation_date in rotation_dates:
    scores = {}
    for etf in fixed_candidates:
        # 使用截至rotation_date-1的数据计算简单指标
        adx = calculate_adx(etf, end_date=rotation_date-1)
        momentum = calculate_momentum(etf, end_date=rotation_date-1)
        scores[etf] = 0.6 * adx + 0.4 * momentum

    # 3. 选出top 15-18只（模拟轮换）
    top_etfs = sorted(scores, key=scores.get, reverse=True)[:18]
    schedule[rotation_date] = top_etfs
```

**优点**:
- ✅ 2-3小时内可完成实现
- ✅ 绕过筛选器的复杂问题
- ✅ 仍能验证"轮动是否有效"的核心假设
- ✅ 可以后续优化（方案A）

**缺点**:
- ⚠️ 候选池固定（20只），无法纳入新上市的优质ETF
- ⚠️ 不是完全动态的轮动，更像是"微调"

**预估工期**: +2-3小时

---

#### 方案C：暂停开发，优先级降级 ⚠️
**思路**: 将此需求降为P3，聚焦于其他高优先级任务

**触发条件**: 如果方案B的简化版轮动实验结果显示无明显增益，则无需投入更多时间

---

### 3.3 当前决策

**待用户确认**: 请用户选择方案A/B/C，或提出其他建议

---

## 4. 实现路径（分4个Phase）

### Phase 1: 数据预处理 🔧 [🔴 受阻]

**状态**: 部分完成（脚本已实现，但因筛选器问题无法生成有效轮动表）

**已交付**:
- ✅ `scripts/prepare_rotation_schedule.py` (537行)
- ✅ `scripts/generate_all_rotation_schedules.sh`
- ✅ `scripts/validate_rotation_schedule.py` (437行)

**待解决**: ETF筛选器第二级失效问题（见§3.1）

---

### Phase 2: 虚拟ETF数据生成 📊 [⏸️ 待Phase 1完成]

**依赖**: Phase 1生成的`rotation_schedule.json`

**任务**:
- 实现`backtest_runner/data/virtual_etf_builder.py`
- 将动态池子合并为单一虚拟ETF的OHLCV数据
- 计算换仓成本（全平仓 vs 增量调整）

**预计工时**: 6小时（实现） + 3小时（测试）

---

### Phase 3: 策略实现 🎯 [⏸️ 待Phase 2完成]

**任务**:
- 实现`strategies/rotation_meta_strategy.py`
- 集成到`backtest_runner/cli/backtest_cli.py`
- 端到端测试

**预计工时**: 4小时（策略） + 2小时（集成） + 2小时（测试）

---

### Phase 4: 对比实验 🧪 [⏸️ 待Phase 3完成]

**实验矩阵**: 1基准 + 8轮动场景（4周期 × 2再平衡模式）

**预计工时**: 2小时（脚本） + 4小时（执行） + 4小时（分析）

---

## 5. 技术细节补充

### 5.1 数据对齐问题处理
处理不同ETF交易日不一致的情况（停牌、新上市）

### 5.2 交易成本计入的准确性
轮动日的成本计入时机需确保不泄露未来信息

### 5.3 性能优化考虑
只加载轮动表中实际用到的ETF，使用parquet格式加速

---

## 6. 风险与假设

### 6.1 假设条件
1. **无滑点假设**: 轮动日能以收盘价成交
2. **无容量约束**: 任意时刻都能买入/卖出任意数量
3. **历史评分有效性**: 评分对未来仍有预测力

### 6.2 已知风险
| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| **ETF筛选器兼容性** | Phase 1受阻（当前） | 采用简化方案B |
| 过拟合 | 轮动周期在训练集最优，实盘失效 | 使用独立验证集 |
| 交易成本低估 | 实际成本更高，Alpha被吞噬 | 保守估计成本（0.3%双边） |

### 6.3 局限性
- 不考虑资金容量和冲击成本
- 假设轮动日能准确执行

---

## 7. 验收标准

### 7.1 功能验收
- [ ] 能成功生成4种周期的轮动表（当前受阻）
- [ ] 轮动表统计信息合理（换手率10%-50%）
- [ ] 虚拟ETF数据通过单元测试
- [ ] 能运行完整的9场景实验
- [ ] 生成结果报告

### 7.2 质量验收
- [ ] 虚拟ETF构建逻辑经过代码审查
- [ ] 交易成本计入准确性经过独立验证
- [ ] 实验结果可复现

### 7.3 结论明确性
- [ ] 能回答："轮动是否优于固定池？"
- [ ] 能明确推荐最优轮动周期和再平衡模式

---

## 8. 参考资料

### 8.1 相关代码模块
- `etf_selector/`: ETF筛选器实现
- `backtest_runner/data/`: 数据加载和处理
- `strategies/kama_cross.py`: KAMA策略实现

### 8.2 相关实验
- `experiment/etf/kama_cross/hyperparameter_search/`: KAMA策略验证（夏普1.69）
- `experiment/etf/sma_cross/stop_loss_comparison/`: SMA止损实验

### 8.3 理论基础
- 均值回归 vs 动量延续
- Kelly公式：最优再平衡频率
- 信息比率：主动管理 vs 被动持有

---

## 9. FAQ

**Q1: 为什么不直接在backtesting.py中支持多标的？**
A: 改造框架成本高且风险大，虚拟ETF方法能达到相同效果且向后兼容。

**Q2: ETF筛选器为什么在时点数据下失效？**
A: 第二级评分阈值是基于长期历史数据（如2年）优化的，在单一时点（如2023-10-31）的数据分布下，可能所有ETF都无法达标。需要针对时点场景重新校准阈值。

**Q3: 简化方案B（基于固定候选池）是否有意义？**
A: 有意义。即使候选池固定，通过动态调整持仓权重（top 15-18只）仍能验证"及时淘汰表现变差的ETF"这一核心假设。如果简化版有效，再投入资源实现完整版。

**Q4: 如果轮动实验结果显示不如固定池，是否值得？**
A: 非常值得！证伪也是重要发现，说明筛选器的时效性不足，或成本过高。

---

## 10. 开发日志

### 2025-11-12: Phase 1 实施与受阻

**工作内容**:
1. 实现轮动表生成脚本（537行，包含完整的日期调度、筛选调用、统计计算）
2. 实现批量生成脚本和验证脚本（437行，带健康度评分）
3. 配置参数调优（流动性5万、上市60天、ADX 90%）

**测试发现**:
- 第一级筛选通过率28.7%（402只）✅
- 第二级筛选获得0只有效标的 ❌
- 问题根源：评分阈值在时点数据下不适配

**待决策**: 选择方案A（调试筛选器）、方案B（简化轮动）或方案C（暂停）

---

**文档结束** | 最后更新: 2025-11-12 | 状态: Phase 1受阻，待方案确认
