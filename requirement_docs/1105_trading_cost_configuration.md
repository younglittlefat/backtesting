# äº¤æ˜“æˆæœ¬é…ç½®åŒ–è®¾è®¡æ–‡æ¡£

**æ—¥æœŸ**: 2025-11-05
**ä½œè€…**: Claude Code
**ç‰ˆæœ¬**: v2.1 (å·²å®Œæˆ)
**å®Œæˆæ—¥æœŸ**: 2025-11-05 (åˆç‰ˆ) / 2025-11-06 (æ–°å¢defaulté¢„è®¾)

---

## 1. éœ€æ±‚æ¦‚è¿°

### 1.1 ç›®æ ‡
å°†å›æµ‹ç³»ç»Ÿçš„äº¤æ˜“æˆæœ¬ï¼ˆæ‰‹ç»­è´¹ã€å°èŠ±ç¨ã€æ»‘ç‚¹ï¼‰é…ç½®åŒ–ï¼Œæ”¯æŒä¸åŒå¸‚åœºå’Œæ ‡çš„ç±»å‹çš„å·®å¼‚åŒ–è´¹ç”¨æ¨¡å‹ï¼Œç”¨æˆ·å¯åœ¨å›æµ‹æ—¶é€šè¿‡å‚æ•°ç›´æ¥é€‰æ‹©è´¹ç”¨é…ç½®ã€‚

### 1.2 æ”¯æŒçš„å¸‚åœºå’Œæ ‡çš„ç±»å‹
| æ ‡çš„ç±»å‹ | å¸‚åœº | å…³é”®ç‰¹å¾ |
|---------|------|---------|
| **ETF** | ä¸­å›½Aè‚¡ | å…å°èŠ±ç¨ã€ä½ä½£é‡‘ã€åŒå‘æ”¶è´¹ |
| **ä¸ªè‚¡** | ä¸­å›½Aè‚¡ | æœ‰å°èŠ±ç¨ï¼ˆå–å‡ºå•å‘ï¼‰ã€è¿‡æˆ·è´¹ã€åˆ¸å•†ä½£é‡‘æœ€ä½5å…ƒ |
| **è‚¡ç¥¨** | ç¾å›½ | SECè´¹ã€TAFè´¹ã€æ— å°èŠ±ç¨ |

### 1.3 éªŒæ”¶æ ‡å‡†
- âœ… åˆ›å»ºè´¹ç”¨é…ç½®ç±»ï¼Œæ”¯æŒ4ç§é¢„è®¾é…ç½®ï¼ˆdefault, cn_etf, cn_stock, us_stockï¼‰
- âœ… CLIå‚æ•° `--cost-model` å¯é€‰ `default`, `cn_etf`, `cn_stock`, `us_stock`, `custom`
- âœ… æ”¯æŒAè‚¡ä¸ªè‚¡çš„å•å‘å°èŠ±ç¨
- âœ… æ”¯æŒè‡ªå®šä¹‰è¦†ç›–é…ç½®å‚æ•°
- âœ… å•å…ƒæµ‹è¯•å®Œæ•´ï¼ˆ19ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡ï¼‰
- âœ… é›†æˆæµ‹è¯•éªŒæ”¶é€šè¿‡

---

## 2. è´¹ç”¨é…ç½®æ–¹æ¡ˆ

### 2.0 æ¡†æ¶ç¼ºçœé¢„è®¾ (`default`)

**é€‚ç”¨åœºæ™¯**: backtesting.pyæ¡†æ¶çš„åŸå§‹é»˜è®¤è®¾ç½®ï¼Œç”¨äºå¯¹æ¯”åˆ†æè´¹ç”¨å¯¹æ”¶ç›Šç‡çš„å½±å“

#### è´¹ç”¨æ˜ç»†
| è´¹ç”¨é¡¹ | ä¹°å…¥ | å–å‡º | è¯´æ˜ |
|-------|------|------|------|
| åˆ¸å•†ä½£é‡‘ | 0.0% | 0.0% | æ¡†æ¶é»˜è®¤é›¶ä½£é‡‘ |
| å°èŠ±ç¨ | - | - | æ— å°èŠ±ç¨ |
| è¿‡æˆ·è´¹ | - | - | æ— è¿‡æˆ·è´¹ |
| æ»‘ç‚¹ | 0.0% | 0.0% | æ¡†æ¶é»˜è®¤é›¶æ»‘ç‚¹ |
| **æ€»æˆæœ¬** | **0.0%** | **0.0%** | ç†æƒ³åŒ–æ— æˆæœ¬ |

#### é…ç½®å‚æ•°
```python
TradingCostConfig(
    name='æ¡†æ¶ç¼ºçœ',
    commission_rate=0.0,    # 0%
    spread=0.0,              # 0%
    stamp_duty=0.0,          # æ— å°èŠ±ç¨
    min_commission=0.0,      # æ— æœ€ä½ä½£é‡‘
)
```

**ç”¨é€”è¯´æ˜**:
- ğŸ“Š **å¯¹æ¯”åŸºå‡†**: ç”¨äºå¯¹æ¯”æœ‰/æ— äº¤æ˜“æˆæœ¬å¯¹ç­–ç•¥æ”¶ç›Šç‡çš„å½±å“
- ğŸ” **ç­–ç•¥éªŒè¯**: å¿«é€ŸéªŒè¯ç­–ç•¥é€»è¾‘ï¼Œæ’é™¤è´¹ç”¨å› ç´ å¹²æ‰°
- âš ï¸ **æ³¨æ„**: ä¸ä»£è¡¨ä»»ä½•çœŸå®å¸‚åœºç¯å¢ƒï¼Œä»…ç”¨äºå­¦æœ¯ç ”ç©¶å’Œå¯¹æ¯”åˆ†æ

**å…³é”®å·®å¼‚**:
æ ¹æ® `backtesting/backtesting.py:1184-1186`ï¼š
```python
cash: float = 10_000,
spread: float = .0,           # é»˜è®¤0æ»‘ç‚¹
commission: Union[float, Tuple[float, float]] = .0,  # é»˜è®¤0ä½£é‡‘
```

---

### 2.1 ä¸­å›½Aè‚¡ETF (`cn_etf`)

**é€‚ç”¨åœºæ™¯**: å›æµ‹ä¸­å›½Aè‚¡ETFæ ‡çš„ï¼ˆæ²ªæ·±300ETFã€ä¸­è¯500ETFç­‰ï¼‰

#### è´¹ç”¨æ˜ç»†
| è´¹ç”¨é¡¹ | ä¹°å…¥ | å–å‡º | è¯´æ˜ |
|-------|------|------|------|
| åˆ¸å•†ä½£é‡‘ | 0.05% | 0.05% | ä¸‡äº”ï¼ˆ0.0005ï¼‰ |
| å°èŠ±ç¨ | - | - | ETFå…å°èŠ±ç¨ |
| è¿‡æˆ·è´¹ | - | - | ETFé€šå¸¸ä¸æ”¶å– |
| æ»‘ç‚¹ | 0.01% | 0.01% | å¸‚åœºå†²å‡»æˆæœ¬ |
| **æ€»æˆæœ¬** | **0.06%** | **0.06%** | å•è¾¹æ€»æˆæœ¬ |

#### é…ç½®å‚æ•°
```python
TradingCostConfig(
    name='ä¸­å›½Aè‚¡ETF',
    commission_rate=0.0005,    # 0.05%
    spread=0.0001,              # 0.01%
    stamp_duty=0.0,             # å…å°èŠ±ç¨
    min_commission=0.0,         # æ— æœ€ä½ä½£é‡‘
)
```

---

### 2.2 ä¸­å›½Aè‚¡ä¸ªè‚¡ (`cn_stock`)

**é€‚ç”¨åœºæ™¯**: å›æµ‹ä¸­å›½Aè‚¡ä¸ªè‚¡æ ‡çš„ï¼ˆè´µå·èŒ…å°ã€æ‹›å•†é“¶è¡Œç­‰ï¼‰

#### è´¹ç”¨æ˜ç»†
| è´¹ç”¨é¡¹ | ä¹°å…¥ | å–å‡º | è¯´æ˜ |
|-------|------|------|------|
| åˆ¸å•†ä½£é‡‘ | 0.03% | 0.03% | ä¸‡ä¸‰ï¼ˆ0.0003ï¼‰ï¼Œæœ€ä½5å…ƒ |
| å°èŠ±ç¨ | - | 0.1% | **ä»…å–å‡ºæ”¶å–**ï¼ˆ0.001ï¼‰ |
| è¿‡æˆ·è´¹ | 0.001% | 0.001% | ä¸Šäº¤æ‰€ï¼ŒåŒå‘ï¼ˆ0.00001ï¼‰ |
| æ»‘ç‚¹ | 0.02% | 0.02% | ä¸ªè‚¡æµåŠ¨æ€§è¾ƒETFå·® |
| **æ€»æˆæœ¬** | **0.051%** | **0.151%** | ä¹°å…¥/å–å‡ºä¸å¯¹ç§° |

#### é…ç½®å‚æ•°
```python
TradingCostConfig(
    name='ä¸­å›½Aè‚¡ä¸ªè‚¡',
    commission_rate=0.0003,     # 0.03%
    spread=0.0002,              # 0.02%
    stamp_duty=0.001,           # 0.1%ï¼ˆä»…å–å‡ºï¼‰
    stamp_duty_side='sell',     # å•å‘å°èŠ±ç¨
    transfer_fee=0.00001,       # 0.001%ï¼ˆåŒå‘ï¼‰
    min_commission=5.0,         # æœ€ä½ä½£é‡‘5å…ƒ
)
```

**å…³é”®ç‰¹æ€§**:
- âœ… å°èŠ±ç¨**ä»…åœ¨å–å‡ºæ—¶æ”¶å–**
- âœ… åˆ¸å•†ä½£é‡‘æœ‰**æœ€ä½5å…ƒé—¨æ§›**ï¼ˆå°èµ„é‡‘è´¦æˆ·å½±å“æ˜¾è‘—ï¼‰
- âœ… è¿‡æˆ·è´¹åŒå‘æ”¶å–

---

### 2.3 ç¾å›½è‚¡ç¥¨ (`us_stock`)

**é€‚ç”¨åœºæ™¯**: å›æµ‹ç¾è‚¡æ ‡çš„ï¼ˆAAPLã€TSLAç­‰ï¼‰

#### è´¹ç”¨æ˜ç»†
| è´¹ç”¨é¡¹ | ä¹°å…¥ | å–å‡º | è¯´æ˜ |
|-------|------|------|------|
| åˆ¸å•†ä½£é‡‘ | $0 | $0 | å¤šæ•°åˆ¸å•†å·²é›¶ä½£é‡‘ |
| SECè´¹ | - | 0.00278% | ä»…å–å‡ºï¼Œçº¦$27.8/$1M |
| æ»‘ç‚¹ | 0.01% | 0.01% | å–å†³äºè‚¡ç¥¨æµåŠ¨æ€§ |
| **æ€»æˆæœ¬** | **0.01%** | **0.01278%** | æä½æˆæœ¬ |

#### é…ç½®å‚æ•°
```python
TradingCostConfig(
    name='ç¾å›½è‚¡ç¥¨',
    commission_rate=0.0,        # é›¶ä½£é‡‘
    spread=0.0001,              # 0.01%
    sec_fee=0.0000278,          # ä»…å–å‡º
    min_commission=0.0,         # æ— æœ€ä½ä½£é‡‘
)
```

---

## 3. æŠ€æœ¯å®ç°

### 3.1 æ¶æ„è®¾è®¡
```
ç”¨æˆ·CLIå‚æ•° (--cost-model cn_etf)
    â†“
TradingCostConfig.get_preset('cn_etf')  â†’ è·å–é¢„è®¾é…ç½®
    â†“
TradingCostCalculator(config)            â†’ åˆ›å»ºè®¡ç®—å™¨
    â†“
Backtest(commission=calculator)          â†’ ä¼ å…¥å›æµ‹å¼•æ“
```

### 3.2 æ ¸å¿ƒç±»

#### 3.2.1 `TradingCostConfig` - é…ç½®ç±»
**æ–‡ä»¶**: `utils/trading_cost.py`

```python
@dataclass
class TradingCostConfig:
    """äº¤æ˜“æˆæœ¬é…ç½®"""
    name: str                              # é…ç½®åç§°
    commission_rate: float                 # åŸºç¡€ä½£é‡‘ç‡
    spread: float                          # æ»‘ç‚¹/ä»·å·®
    stamp_duty: float = 0.0                # å°èŠ±ç¨ï¼ˆå•å‘ï¼‰
    stamp_duty_side: Literal['buy', 'sell', 'both'] = 'sell'
    transfer_fee: float = 0.0              # è¿‡æˆ·è´¹ï¼ˆåŒå‘ï¼‰
    sec_fee: float = 0.0                   # SECè´¹ï¼ˆå•å‘ï¼‰
    min_commission: float = 0.0            # æœ€ä½ä½£é‡‘

    @classmethod
    def get_preset(cls, model_name: str) -> 'TradingCostConfig':
        """è·å–é¢„è®¾é…ç½®"""
```

#### 3.2.2 `TradingCostCalculator` - è®¡ç®—ç±»
**æ–‡ä»¶**: `utils/trading_cost.py`

```python
class TradingCostCalculator:
    """
    äº¤æ˜“æˆæœ¬è®¡ç®—å™¨ï¼Œå…¼å®¹ backtesting.py çš„ commission å‚æ•°
    å¯ä½œä¸º callable ä¼ å…¥: Backtest(..., commission=calculator)
    """
    def __call__(self, size: float, price: float) -> float:
        """
        è®¡ç®—è®¢å•çš„æ€»æˆæœ¬
        Args:
            size: è®¢å•æ•°é‡ï¼ˆæ­£æ•°=ä¹°å…¥ï¼Œè´Ÿæ•°=å–å‡ºï¼‰
            price: æˆäº¤ä»·æ ¼
        Returns:
            æˆæœ¬é‡‘é¢ï¼ˆåŒ…å«ä½£é‡‘ã€å°èŠ±ç¨ã€è¿‡æˆ·è´¹ã€SECè´¹ç­‰ï¼‰
        """
```

**å®ç°çš„æˆæœ¬è®¡ç®—é€»è¾‘**:
1. âœ… åŸºç¡€ä½£é‡‘ = order_value Ã— commission_rate
2. âœ… æœ€ä½ä½£é‡‘é™åˆ¶ = max(ä½£é‡‘, min_commission)
3. âœ… å•å‘å°èŠ±ç¨ï¼ˆä»…å–å‡ºæ—¶æ”¶å–ï¼‰
4. âœ… åŒå‘è¿‡æˆ·è´¹
5. âœ… SECè´¹ï¼ˆä»…å–å‡ºæ—¶æ”¶å–ï¼‰

---

## 4. ä»£ç æ”¹åŠ¨

### 4.1 æ–°å¢æ–‡ä»¶
âœ… **`utils/trading_cost.py`** (230è¡Œ)
- `TradingCostConfig` é…ç½®ç±»
- `TradingCostCalculator` è®¡ç®—ç±»
- `PRESET_CONFIGS` é¢„è®¾é…ç½®å­—å…¸
- `get_cost_summary()` è´¹ç”¨æ‘˜è¦å‡½æ•°

âœ… **`backtesting/test/test_trading_cost.py`** (225è¡Œ)
- 19ä¸ªå•å…ƒæµ‹è¯•ç”¨ä¾‹
- è¦†ç›–æ‰€æœ‰è´¹ç”¨è®¡ç®—é€»è¾‘
- æµ‹è¯•ç»“æœï¼š**19/19 é€šè¿‡**

### 4.2 ä¿®æ”¹æ–‡ä»¶

#### `backtest_runner.py` ä¸»è¦æ”¹åŠ¨
1. âœ… å¯¼å…¥æ–°çš„äº¤æ˜“æˆæœ¬æ¨¡å—
   ```python
   from utils.trading_cost import TradingCostConfig, TradingCostCalculator, get_cost_summary
   ```

2. âœ… ç§»é™¤æ—§çš„è´¹ç”¨é…ç½®
   ```python
   # åˆ é™¤: CATEGORY_DEFAULT_COMMISSION å­—å…¸
   # åˆ é™¤: DEFAULT_COMMISSION å¸¸é‡
   ```

3. âœ… æ–°å¢CLIå‚æ•°
   ```python
   parser.add_argument('--cost-model',
                       choices=['cn_etf', 'cn_stock', 'us_stock', 'custom'],
                       default='cn_etf')
   parser.add_argument('--commission', type=float, default=None)
   parser.add_argument('--spread', type=float, default=None)
   ```

4. âœ… ä¿®æ”¹å›æµ‹è°ƒç”¨é€»è¾‘
   ```python
   # åˆ›å»ºæˆæœ¬é…ç½®
   config = TradingCostConfig.get_preset(args.cost_model)
   if args.commission: config.commission_rate = args.commission
   if args.spread: config.spread = args.spread

   # åˆ›å»ºè®¡ç®—å™¨å¹¶ä¼ å…¥å›æµ‹
   cost_calculator = TradingCostCalculator(config)
   bt = Backtest(data, strategy_class, commission=cost_calculator, ...)
   ```

5. âœ… å¢å¼ºæ—¥å¿—è¾“å‡º
   ```python
   # æ˜¾ç¤ºè¯¦ç»†è´¹ç”¨é…ç½®
   print(f"è´¹ç”¨æ¨¡å‹: {config.name}")
   print(get_cost_summary(config))
   ```

#### `run_backtest.sh` ä¸»è¦æ”¹åŠ¨
1. âœ… æ›´æ–°å¸®åŠ©ä¿¡æ¯
   ```bash
   --cost-model <model>    è´¹ç”¨æ¨¡å‹: cn_etf, cn_stock, us_stock, custom (é»˜è®¤: cn_etf)
   -c, --commission <rate> è‡ªå®šä¹‰ä½£é‡‘ç‡ï¼ˆè¦†ç›–æ¨¡å‹é»˜è®¤å€¼ï¼‰
   --spread <rate>         è‡ªå®šä¹‰æ»‘ç‚¹ç‡
   ```

2. âœ… æ–°å¢å‚æ•°è§£æ
   ```bash
   --cost-model) COST_MODEL_VALUE="$2"; shift 2;;
   --spread) SPREAD_VALUE="$2"; shift 2;;
   ```

3. âœ… æ›´æ–°é…ç½®æ˜¾ç¤º
   ```bash
   echo -e "${YELLOW}è´¹ç”¨æ¨¡å‹:${NC} $COST_MODEL_VALUE"
   if [ -n "$COMMISSION_VALUE" ]; then
       echo -e "${YELLOW}ä½£é‡‘è¦†ç›–:${NC} $COMMISSION_VALUE"
   fi
   ```

---

## 5. ä½¿ç”¨æŒ‡å—

### 5.1 é¢„è®¾è´¹ç”¨æ¨¡å‹

```bash
# æ¡†æ¶ç¼ºçœé…ç½®ï¼ˆé›¶æˆæœ¬ï¼Œç”¨äºå¯¹æ¯”åˆ†æï¼‰
./run_backtest.sh -s 510300.SH -t sma_cross --cost-model default --data-dir data/csv/daily

# ä¸­å›½ETFå›æµ‹ï¼ˆé»˜è®¤ï¼‰
./run_backtest.sh -s 510300.SH -t sma_cross --data-dir data/csv/daily

# ä¸­å›½ä¸ªè‚¡å›æµ‹ï¼ˆåŒ…å«å°èŠ±ç¨ï¼‰
./run_backtest.sh -s 600519.SH -t sma_cross --cost-model cn_stock

# ç¾è‚¡å›æµ‹
./run_backtest.sh -s AAPL -t sma_cross --cost-model us_stock --data-dir data/us_stocks

# å¯¹æ¯”åˆ†æç¤ºä¾‹ï¼šå¯¹æ¯”é›¶æˆæœ¬ vs å®é™…æˆæœ¬çš„æ”¶ç›Šç‡å·®å¼‚
./run_backtest.sh -s 510300.SH -t sma_cross --cost-model default --data-dir data/csv/daily
./run_backtest.sh -s 510300.SH -t sma_cross --cost-model cn_etf --data-dir data/csv/daily
# ä¸¤æ¬¡å›æµ‹ç»“æœçš„æ”¶ç›Šç‡å·®å¼‚å³ä¸ºäº¤æ˜“æˆæœ¬çš„å½±å“
```

### 5.2 å‚æ•°è¦†ç›–

```bash
# ä½¿ç”¨cn_etfæ¨¡å‹ï¼Œä½†æé«˜æ»‘ç‚¹è‡³0.05%
./run_backtest.sh -s 510300.SH --cost-model cn_etf --spread 0.0005

# ä½¿ç”¨cn_stockæ¨¡å‹ï¼Œä½†é™ä½ä½£é‡‘ï¼ˆVIPå®¢æˆ·ä¸‡ä¸€ï¼‰
./run_backtest.sh -s 600519.SH --cost-model cn_stock --commission 0.0001

# åŒæ—¶è¦†ç›–ä½£é‡‘å’Œæ»‘ç‚¹
./run_backtest.sh -s 510300.SH --cost-model cn_etf -c 0.001 --spread 0.0005
```

### 5.3 è‡ªå®šä¹‰æ¨¡å‹

```bash
# å®Œå…¨è‡ªå®šä¹‰è´¹ç”¨é…ç½®
./run_backtest.sh -s 510300.SH --cost-model custom -c 0.002 --spread 0.001
```

### 5.4 Python API

```python
from utils.trading_cost import TradingCostConfig, TradingCostCalculator
from backtesting import Backtest
from strategies.sma_cross import SmaCross

# ä½¿ç”¨é¢„è®¾é…ç½®
config = TradingCostConfig.get_preset('cn_stock')
calculator = TradingCostCalculator(config)

# è¿è¡Œå›æµ‹
bt = Backtest(data, SmaCross, cash=100000, commission=calculator)
stats = bt.run()
```

---

## 6. æµ‹è¯•éªŒæ”¶

### 6.1 å•å…ƒæµ‹è¯•ç»“æœ
**æ–‡ä»¶**: `backtesting/test/test_trading_cost.py`
**æµ‹è¯•æ—¶é—´**: 2025-11-05 (æ›´æ–°: 2025-11-06)
**ç»“æœ**: âœ… **22/22 é€šè¿‡** (0.002ç§’)

**æµ‹è¯•è¦†ç›–**:
- âœ… 4ä¸ªé¢„è®¾é…ç½®è·å–æµ‹è¯•ï¼ˆdefault, cn_etf, cn_stock, us_stockï¼‰
- âœ… æ¡†æ¶ç¼ºçœé…ç½®è´¹ç”¨è®¡ç®—ï¼ˆä¹°å…¥/å–å‡ºï¼Œå‡ä¸º0æˆæœ¬ï¼‰
- âœ… ä¸­å›½ETFè´¹ç”¨è®¡ç®—ï¼ˆä¹°å…¥/å–å‡ºï¼‰
- âœ… ä¸­å›½ä¸ªè‚¡è´¹ç”¨è®¡ç®—ï¼ˆå°èŠ±ç¨ã€è¿‡æˆ·è´¹ã€æœ€ä½ä½£é‡‘ï¼‰
- âœ… å°èŠ±ç¨å•å‘æ”¶å–éªŒè¯
- âœ… æœ€ä½ä½£é‡‘é—¨æ§›æµ‹è¯•
- âœ… å¤§é¢è®¢å•æµ‹è¯•
- âœ… ç¾è‚¡è´¹ç”¨è®¡ç®—ï¼ˆé›¶ä½£é‡‘ã€SECè´¹ï¼‰
- âœ… è‡ªå®šä¹‰é…ç½®æµ‹è¯•
- âœ… è´¹ç”¨æ‘˜è¦åŠŸèƒ½æµ‹è¯•

### 6.2 é›†æˆæµ‹è¯•ç»“æœ

#### æµ‹è¯•0: default vs cn_etf å¯¹æ¯”æµ‹è¯•ï¼ˆæ–°å¢ï¼‰
```bash
# æµ‹è¯•1ï¼šä½¿ç”¨æ¡†æ¶ç¼ºçœé…ç½®ï¼ˆé›¶æˆæœ¬ï¼‰
./run_backtest.sh -s 510300.SH -t sma_cross --cost-model default --data-dir data/csv/daily

# æµ‹è¯•2ï¼šä½¿ç”¨cn_etfé…ç½®ï¼ˆå«è´¹ç”¨ï¼‰
./run_backtest.sh -s 510300.SH -t sma_cross --cost-model cn_etf --data-dir data/csv/daily
```
**ç»“æœ**: âœ… æˆåŠŸ
- **defaultæ¨¡å‹**ï¼ˆé›¶æˆæœ¬ï¼‰
  - æ”¶ç›Šç‡ï¼š-30.97%
  - å¤æ™®æ¯”ç‡ï¼š-0.43
  - æœ€å¤§å›æ’¤ï¼š-55.06%
- **cn_etfæ¨¡å‹**ï¼ˆå«è´¹ç”¨ï¼‰
  - æ”¶ç›Šç‡ï¼š-33.69%
  - å¤æ™®æ¯”ç‡ï¼š-0.48
  - æœ€å¤§å›æ’¤ï¼š-56.37%
- **è´¹ç”¨å½±å“åˆ†æ**ï¼š
  - æ”¶ç›Šç‡å·®å¼‚ï¼š-2.72%ï¼ˆäº¤æ˜“æˆæœ¬å¯¼è‡´ï¼‰
  - æˆåŠŸå±•ç¤ºäº†äº¤æ˜“æˆæœ¬å¯¹ç­–ç•¥æ”¶ç›Šç‡çš„å®é™…å½±å“
  - éªŒè¯äº†defaulté¢„è®¾ç”¨äºå¯¹æ¯”åˆ†æçš„æœ‰æ•ˆæ€§

#### æµ‹è¯•1: cn_etf æ¨¡å‹
```bash
./run_backtest.sh -s 510300.SH -t sma_cross --cost-model cn_etf --data-dir data/csv/daily --verbose
```
**ç»“æœ**: âœ… æˆåŠŸ
- è´¹ç”¨æ¨¡å‹æ­£ç¡®æ˜¾ç¤ºï¼šä¸­å›½Aè‚¡ETF
- ä½£é‡‘ç‡ï¼š0.0500%
- æ»‘ç‚¹ï¼š0.0100%
- å›æµ‹æ‰§è¡ŒæˆåŠŸï¼Œç”Ÿæˆç»“æœæ–‡ä»¶

#### æµ‹è¯•2: cn_stock æ¨¡å‹ï¼ˆå¯¹æ¯”æµ‹è¯•ï¼‰
```bash
./run_backtest.sh -s 510300.SH,510500.SH -t sma_cross --cost-model cn_stock --data-dir data/csv/daily --verbose
```
**ç»“æœ**: âœ… æˆåŠŸ
- è´¹ç”¨æ¨¡å‹æ­£ç¡®æ˜¾ç¤ºï¼šä¸­å›½Aè‚¡ä¸ªè‚¡
- ä½£é‡‘ç‡ï¼š0.0300%ï¼Œæ»‘ç‚¹ï¼š0.0200%
- å°èŠ±ç¨ï¼š0.1000% (sell) âœ… å•å‘
- è¿‡æˆ·è´¹ï¼š0.0010% âœ… åŒå‘
- æœ€ä½ä½£é‡‘ï¼š5.00å…ƒ âœ…
- ä¸¤ä¸ªæ ‡çš„å›æµ‹æˆåŠŸ

#### æµ‹è¯•3: å‚æ•°è¦†ç›–åŠŸèƒ½
```bash
./run_backtest.sh -s 510300.SH --cost-model cn_etf --commission 0.001 --spread 0.0005 --data-dir data/csv/daily --verbose
```
**ç»“æœ**: âœ… æˆåŠŸ
- ä½£é‡‘è¦†ç›–æˆåŠŸï¼š0.1000% (åŸ0.0500%)
- æ»‘ç‚¹è¦†ç›–æˆåŠŸï¼š0.0500% (åŸ0.0100%)
- è´¹ç”¨è¦†ç›–åæ”¶ç›Šç‡ä¸‹é™ï¼ˆç¬¦åˆé¢„æœŸï¼‰

### 6.3 éªŒæ”¶ç»“è®º
âœ… **æ‰€æœ‰åŠŸèƒ½å·²å®ç°å¹¶é€šè¿‡æµ‹è¯•**
- å•å…ƒæµ‹è¯•ï¼š22/22 é€šè¿‡ï¼ˆæ–°å¢3ä¸ªdefaultç›¸å…³æµ‹è¯•ï¼‰
- é›†æˆæµ‹è¯•ï¼š4/4 åœºæ™¯é€šè¿‡ï¼ˆæ–°å¢default vs cn_etfå¯¹æ¯”æµ‹è¯•ï¼‰
- è´¹ç”¨è®¡ç®—å‡†ç¡®æ€§ï¼šâœ…
- å‚æ•°è¦†ç›–åŠŸèƒ½ï¼šâœ…
- æ—¥å¿—æ˜¾ç¤ºå®Œæ•´æ€§ï¼šâœ…
- å¯¹æ¯”åˆ†æåŠŸèƒ½ï¼šâœ… **æ–°å¢**

---

## 7. å…¼å®¹æ€§è¯´æ˜

### 7.1 å‘åå…¼å®¹
âœ… ä¿ç•™ `--commission` å‚æ•°ï¼Œè¯­ä¹‰å˜ä¸º"è¦†ç›–cost-modelçš„ä½£é‡‘ç‡"
âœ… é»˜è®¤ `--cost-model cn_etf`ï¼Œä¸æ—§ç‰ˆæœ¬è¡Œä¸ºä¸€è‡´
âœ… æ—§ä»£ç æ— éœ€ä¿®æ”¹å³å¯ä½¿ç”¨é»˜è®¤é…ç½®

### 7.2 è¿ç§»æŒ‡å—
| æ—§ç”¨æ³• | æ–°ç”¨æ³• | è¯´æ˜ |
|--------|--------|------|
| æ—  | `--cost-model default` | æ¡†æ¶ç¼ºçœé…ç½®ï¼Œç”¨äºå¯¹æ¯”åˆ†æ |
| `-c 0.0005` | `--cost-model cn_etf` | ä½¿ç”¨é¢„è®¾ETFæ¨¡å‹ |
| `-c 0.0003` | `--cost-model cn_stock` | ä½¿ç”¨é¢„è®¾ä¸ªè‚¡æ¨¡å‹ |
| `-c 0.001` | `--cost-model custom -c 0.001` | è‡ªå®šä¹‰ä½£é‡‘ |

---

## 8. å‚è€ƒèµ„æ–™

### 8.1 ä¸­å›½å¸‚åœºè´¹ç”¨æ ‡å‡†
- å°èŠ±ç¨: [è´¢æ”¿éƒ¨2023å¹´å…¬å‘Š](https://www.gov.cn/zhengce/zhengceku/2023-08/28/content_6900908.htm) - è¯åˆ¸äº¤æ˜“å°èŠ±ç¨0.1%
- è¿‡æˆ·è´¹: [ä¸­å›½ç»“ç®—2022å¹´å…¬å‘Š](http://www.chinaclear.cn/) - æˆäº¤é‡‘é¢0.001%
- åˆ¸å•†ä½£é‡‘: å¸‚åœºæ™®éä¸‡2.5-ä¸‡3ï¼Œæœ€ä½5å…ƒ

### 8.2 ç¾å›½å¸‚åœºè´¹ç”¨æ ‡å‡†
- [SECè´¹ç”¨](https://www.sec.gov/fast-answers/answerssec31htm.html) - $27.80 per $1,000,000
- [FINRA TAF](https://www.finra.org/rules-guidance/rulebooks/finra-rules/7270) - $0.000119 per share

### 8.3 æŠ€æœ¯å‚è€ƒ
- [backtesting.py Commissionå‚æ•°](https://kernc.github.io/backtesting.py/doc/backtesting/backtesting.html)
- [Python dataclassæ–‡æ¡£](https://docs.python.org/3/library/dataclasses.html)

---

## 9. æ€»ç»“

æœ¬æ¬¡éœ€æ±‚å·²å®Œæˆäº¤æ˜“æˆæœ¬é…ç½®åŒ–çš„å…¨éƒ¨åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

âœ… **æ ¸å¿ƒåŠŸèƒ½**
- 4ç§é¢„è®¾è´¹ç”¨æ¨¡å‹ï¼ˆ**default**, cn_etfã€cn_stockã€us_stockï¼‰
- è‡ªå®šä¹‰æ¨¡å‹æ”¯æŒ
- å‚æ•°è¦†ç›–æœºåˆ¶
- å•å‘å°èŠ±ç¨å®ç°
- æœ€ä½ä½£é‡‘é™åˆ¶
- åŒå‘è¿‡æˆ·è´¹
- **æ–°å¢**ï¼šæ¡†æ¶ç¼ºçœé¢„è®¾ç”¨äºå¯¹æ¯”åˆ†æ

âœ… **ä»£ç è´¨é‡**
- å®Œæ•´çš„å•å…ƒæµ‹è¯•ï¼ˆ22ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œæ–°å¢3ä¸ªï¼‰
- é›†æˆæµ‹è¯•éªŒæ”¶é€šè¿‡ï¼ˆ4ä¸ªåœºæ™¯ï¼Œæ–°å¢å¯¹æ¯”æµ‹è¯•ï¼‰
- å‘åå…¼å®¹æ—§ç‰ˆæœ¬
- ä»£ç æ³¨é‡Šå®Œæ•´

âœ… **ç”¨æˆ·ä½“éªŒ**
- å‘½ä»¤è¡Œå‚æ•°ç®€æ´æ˜“ç”¨
- è¯¦ç»†çš„è´¹ç”¨é…ç½®æ˜¾ç¤º
- å®Œæ•´çš„å¸®åŠ©æ–‡æ¡£
- **æ–°å¢**ï¼šæ”¯æŒé›¶æˆæœ¬åŸºå‡†å¯¹æ¯”ï¼Œä¾¿äºåˆ†æäº¤æ˜“æˆæœ¬å½±å“

âœ… **å®ç”¨ä»·å€¼**
- **æ–°å¢**ï¼šé€šè¿‡defaultæ¨¡å‹å¯é‡åŒ–äº¤æ˜“æˆæœ¬å¯¹ç­–ç•¥çš„å½±å“
- ç¤ºä¾‹ï¼š510300.SHåŒå‡çº¿ç­–ç•¥ä¸­ï¼Œäº¤æ˜“æˆæœ¬å¯¼è‡´çº¦2.72%çš„æ”¶ç›Šç‡æŸå¤±
- ä¸ºç­–ç•¥ä¼˜åŒ–å’Œæˆæœ¬æ§åˆ¶æä¾›æ•°æ®æ”¯æŒ

**é¡¹ç›®çŠ¶æ€**: ğŸ‰ **å·²å®Œæˆå¹¶éªŒæ”¶é€šè¿‡ï¼ˆv2.1 - æ–°å¢defaulté¢„è®¾ï¼‰**
