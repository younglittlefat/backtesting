# 季度轮动ETF池实验计划

## 一、实验目的

验证**按季度滚动更新ETF池**是否比**固定池子**能获得更好的收益和风险调整后收益。

### 核心假设

根据`selector_score/results/ETF_SCORING_DIMENSION_ANALYSIS.md`的发现：
- 评分期时效性是决定筛选有效性的关键因素
- 使用近期数据（2022-2023）评分，ADX维度夏普从-0.18提升到+0.50

**假设**：如果按季度滚动更新池子，始终使用最近2年数据评分，应该能持续获得较好的筛选效果。

---

## 二、实验设计

### 2.1 实验组：季度轮动（Quarterly Rotation）

每个季度重新生成ETF池，使用过去2年的日线数据进行ADX评分筛选，但**交易回测是一条从 2024-01-01 到 2025-11-30 的连续权益曲线**。

| 季度 | 评分期（2年） | 回测期 |
|------|--------------|--------|
| 2024Q1 | 2022-01-01 ~ 2023-12-31 | 2024-01-01 ~ 2024-03-31 |
| 2024Q2 | 2022-04-01 ~ 2024-03-31 | 2024-04-01 ~ 2024-06-30 |
| 2024Q3 | 2022-07-01 ~ 2024-06-30 | 2024-07-01 ~ 2024-09-30 |
| 2024Q4 | 2022-10-01 ~ 2024-09-30 | 2024-10-01 ~ 2024-12-31 |
| 2025Q1 | 2023-01-01 ~ 2024-12-31 | 2025-01-01 ~ 2025-03-31 |
| 2025Q2 | 2023-04-01 ~ 2025-03-31 | 2025-04-01 ~ 2025-06-30 |
| 2025Q3 | 2023-07-01 ~ 2025-06-30 | 2025-07-01 ~ 2025-09-30 |
| 2025Q4 | 2023-10-01 ~ 2025-09-30 | 2025-10-01 ~ 2025-11-30 |

**共8个季度**，其中2025Q4为部分季度（2个月）。

说明：
- 上表中的"评分期"用于在每个季度边界重新打分、生成新的 ETF 池；
- 上表中的"回测期"用于定义该季度在连续权益曲线上的统计窗口和池子生效区间，而不是单独开一条回测。

### 2.2 对照组：固定池子（Static Pool）

使用`pool_2022_2023`目录下的ADX池子（评分期2022-01-01~2023-12-31），在整个回测期（2024-01-01~2025-11-30）保持不变。

固定组同样采用 2024-01-01 ~ 2025-11-30 的**单次连续回测**，只是池子不随季度变化。

**对照组池子路径**：
```
experiment/etf/selector_score/pool_2022_2023/single_adx_score_pool_2022_2023.csv
```

### 2.3 回测配置（已确认）

| 配置项 | 值 |
|--------|-----|
| 策略 | kama_cross |
| KAMA周期 | 20 |
| KAMA快线 | 2 |
| KAMA慢线 | 30 |
| enable_adx_filter | True |
| adx_period | 14 |
| adx_threshold | 25.0 |
| enable_atr_stop | True |
| atr_period | 14 |
| atr_multiplier | 2.5 |
| enable_slope_confirmation | True |
| min_slope_periods | 3 |
| 池子大小 | 20只ETF |
| 筛选维度 | ADX趋势强度（单一维度，权重100%） |
| 费用模型 | cn_etf |
| 初始资金 | 10,000 |

**注意**：策略参数来自 `experiment/etf/selector_score/POOL_COMPARISON_PLAN.md` 的 4.1 节，所有参数固定不变，不做优化。

### 2.4 池子换仓规则（已确认）

池子定义的是**可交易标的的候选集合（entry universe）**：

1. **新季度开始后**：
   - 新池子之外的标的：**不再开新仓**，但已有持仓按 `kama_cross` 策略信号自然出场
   - 新进入池子的标的：从新季度起可以根据信号开仓

2. **不强制季度边界清仓**：更符合趋势跟踪习惯

### 2.5 资金管理（已确认）

采用**方案A**：每只ETF独立回测、独立资金（10,000），对比的是"池子内标的的平均表现"。

---

## 三、评估指标

### 3.1 方案A：分季度统计

基于单次连续回测得到的权益曲线，按季度切分区间，对每个季度分别计算以下指标，最后汇总均值和中位数：

| 指标 | 说明 |
|------|------|
| 季度收益率 | 该季度的总收益率 |
| 季度夏普比率 | 该季度的夏普比率 |
| 季度最大回撤 | 该季度的最大回撤 |
| 季度胜率 | 该季度盈利交易占比 |
| 季度盈亏比 | 该季度平均盈利/平均亏损 |
| 季度交易次数 | 该季度交易次数 |

**汇总统计**：
- 8个季度的均值
- 8个季度的中位数
- 标准差（衡量稳定性）

### 3.2 方案B：整体统计

基于整个连续回测期间的权益曲线，计算整体指标：

| 指标 | 说明 |
|------|------|
| 年化收益率 | 整个回测期的年化收益 |
| 年化夏普比率 | 整个回测期的夏普比率 |
| 最大回撤 | 整个回测期的最大回撤 |
| 总胜率 | 所有交易的胜率 |
| 总盈亏比 | 所有交易的盈亏比 |
| 总交易次数 | 所有交易次数 |
| **MAR** | 年化收益 / 最大回撤 |

### 3.3 附加诊断指标

| 指标 | 说明 |
|------|------|
| 换手率 | 每季度池子变化比例 |
| 交易成本占比 | 交易成本 / 净收益 |
| 平均持仓数量 | 每季度/整体 |
| 平均持仓周期 | 每季度/整体 |
| 资金利用率 | 平均持仓比例 |

---

## 四、技术实现

### 4.1 目录结构

```
experiment/etf/quarterly_rotation/
├── EXPERIMENT_PLAN.md          # 本文档
├── configs/                    # 8个季度的评分配置文件
│   ├── 2024Q1_adx_score.json
│   ├── 2024Q2_adx_score.json
│   ├── ...
│   └── 2025Q4_adx_score.json
├── pools/                      # 8个季度生成的池子
│   ├── 2024Q1_adx_pool.csv
│   ├── 2024Q2_adx_pool.csv
│   ├── ...
│   └── 2025Q4_adx_pool.csv
├── results/
│   ├── rotation/               # 轮动组单次连续回测结果
│   │   ├── equity_curve.csv
│   │   ├── trades.csv
│   │   ├── quarterly_metrics.csv
│   │   └── overall_metrics.json
│   ├── static/                 # 固定组单次连续回测结果
│   │   ├── equity_curve.csv
│   │   ├── trades.csv
│   │   ├── quarterly_metrics.csv
│   │   └── overall_metrics.json
│   └── comparison/             # 对比分析结果
│       ├── quarterly_comparison.csv
│       ├── overall_comparison.csv
│       ├── pool_changes.csv    # 池子变化记录
│       ├── metadata.json       # 实验元数据
│       └── ANALYSIS_REPORT.md
├── scripts/
│   ├── generate_configs.py     # 生成8个季度的配置文件
│   ├── generate_pools.py       # 运行ETF筛选生成池子
│   ├── run_backtests.py        # 运行所有回测
│   └── analyze_results.py      # 汇总分析结果
└── run_all.sh                  # 一键运行脚本
```

### 4.2 技术方案：轮动表 + 交易记录筛选

**设计思路**：不修改 backtest_runner 核心代码，而是在实验层面实现动态池子逻辑。

**核心思想**：
1. 收集所有曾出现在任一季度池子中的 ETF（全量标的集合）
2. 对全量标的进行完整的 2024-01-01 到 2025-11-30 回测
3. 在结果分析阶段，根据"轮动表"筛选每只 ETF 在有效季度内的交易记录

**轮动表格式**（`pool_rotation_schedule.json`）：
```json
{
  "2024Q1": {
    "start": "2024-01-01",
    "end": "2024-03-31",
    "pool_file": "pools/2024Q1_adx_pool.csv",
    "etfs": ["159660.SZ", "513500.SH", ...]
  },
  "2024Q2": {
    "start": "2024-04-01",
    "end": "2024-06-30",
    "pool_file": "pools/2024Q2_adx_pool.csv",
    "etfs": ["159660.SZ", "510300.SH", ...]
  },
  ...
}
```

**分析逻辑**：
- 轮动组：对于每只 ETF，只统计它"在池子中"的季度的交易
- 固定组：对于每只 ETF，只统计它"在固定池子中"的全部季度的交易

**优点**：
1. 零代码改动到核心 backtest_runner
2. 所有逻辑集中在实验脚本中，易于验证和调试
3. 可以灵活调整筛选逻辑（如强制清仓 vs 自然出场）

### 4.3 开发任务分解

#### Phase 1：配置生成（generate_configs.py）
- 基于`pool_2022_2023/single_adx_score.json`模板
- 为8个季度生成配置文件
- 修改`time_range`和`output_path`

#### Phase 3：池子生成（generate_pools.py）
- 调用`etf_selector`模块
- 依次生成8个季度的ETF池子
- 记录每个池子的标的变化情况（新增/移除）
- 输出池子重叠度统计

#### Phase 4：回测执行（run_backtests.py）
- 轮动组：使用动态池子进行单次连续回测
- 固定组：使用固定池子进行单次连续回测
- 输出两条完整权益曲线 + 交易明细

#### Phase 5：结果分析（analyze_results.py）
- 读取所有回测结果
- 计算方案A（分季度统计）
- 计算方案B（整体统计）
- 计算附加诊断指标
- 生成对比报告

---

## 五、预期结果

### 5.1 假设验证

| 假设 | 预期结果 |
|------|----------|
| H1: 轮动组夏普 > 固定组夏普 | 季度更新使池子始终保持"新鲜"，筛选效果更好 |
| H2: 轮动组稳定性更好 | 各季度表现的标准差更小 |
| H3: 轮动成本可接受 | 季度换手带来的交易成本不会抵消收益提升 |

### 5.2 风险因素

1. **季度换手成本**：每季度可能有5-15只标的更换，产生额外交易成本
2. **数据窥探偏差**：2024-2025是牛市，可能高估轮动效果
3. **池子重叠度**：如果季度间池子重叠度高，轮动效果可能不明显

### 5.3 结论适用范围

本实验结论仅能说明"在类似 2024-2025 市场环境下，季度轮动是否优于固定池子"，不直接外推到熊市或震荡市。

---

## 六、执行计划

| 步骤 | 任务 | 输出 | 执行者 |
|------|------|------|--------|
| 1 | 修改 backtest_runner 支持动态池子 | 代码修改 | 主开发 |
| 2 | 单元测试验证动态池子功能 | 测试报告 | Task agent |
| 3 | 生成8个季度配置文件 | `configs/*.json` | 主开发 |
| 4 | 生成8个季度ETF池子 | `pools/*.csv` | Task agent |
| 5 | 统计池子变化情况 | `pool_changes.csv` | Task agent |
| 6 | 运行轮动组回测 | `results/rotation/` | Task agent |
| 7 | 运行固定组回测 | `results/static/` | Task agent |
| 8 | 汇总分析结果 | `results/comparison/` | Task agent |

---

## 七、异常处理策略

**原则**：不做妥协式异常处理，有异常直接抛出

1. **配置文件错误**：直接抛出 `ValueError`，附带错误信息
2. **池子生成失败**：直接抛出异常，不使用空池子或上一季度池子替代
3. **回测失败**：直接抛出异常，不跳过失败标的
4. **数据缺失**：直接抛出 `FileNotFoundError` 或 `DataError`

---

## 八、方案评审结论（开发 & 趋势跟踪视角）

### 8.1 整体评价

- 实验动机清晰，核心对比（季度轮动池 vs 固定池）合理，技术落地路径也比较可执行。
- 为避免实现时偏离交易含义、或引入额外偏差，建议在以下关键点上补充默认约束，并在脚本实现中硬编码/配置化。

### 8.2 关键待明确点（已确认）

1. **池子含义 & 换仓规则** ✅ 已确认
   - 池子定义的是**可交易标的的候选集合（entry universe）**
   - 新池子之外的标的：**不再开新仓**，但已有持仓按 `kama_cross` 策略信号自然出场
   - 新进入池子的标的：从新季度起可以根据信号开仓

2. **回测方式** ✅ 已确认
   - 轮动组和固定组各进行**一次从 2024-01-01 到 2025-11-30 的连续回测**
   - 轮动组在每个季度边界更新"可新开仓池子"，固定组池子保持不变
   - 每组仅生成一条完整权益曲线和交易明细

3. **数据与参数冻结** ✅ 已确认
   - `kama_cross` 使用 `POOL_COMPARISON_PLAN.md` 的固定参数
   - 不对不同季度单独调参或做参数搜索

4. **资金管理** ✅ 已确认
   - 采用方案A：每只ETF独立10000资金

5. **异常处理** ✅ 已确认
   - 不做妥协式异常处理，有异常直接抛出

### 8.3 评估指标与结果解释的补充建议

1. **关于 H3（轮动成本）**
   - 每季度、整体的**换手率**
   - **交易成本 / 净收益** 比例

2. **趋势跟踪视角下的附加诊断指标**
   - **MAR（年化收益 / 最大回撤）**
   - 按季度拆分的**回撤分布**
   - **资金利用率**

3. **样本区间与市场环境偏差**
   - 本实验结论仅适用于"2024-2025 市场环境"
   - 中长期应增加其他区间的补充实验

### 8.4 工程实现与可复现性建议

1. **结果可复现**
   - `run_all.sh` 输出 git commit、核心配置到 `metadata.json`
   - 如果目标结果目录已存在，要求明确选择覆盖或报错

2. **日志与调试信息**
   - 输出每季度的 ETF 数量、筛选阈值到日志
   - 对异常情况直接抛出异常

---

## 九、v1版本问题与v2重新设计（2025-12-08）

### 9.1 v1版本存在的严重问题

经过代码审查，v1版本存在两个根本性缺陷：

| 问题 | 代码位置 | 问题描述 | 严重程度 |
|------|----------|----------|----------|
| **前视偏差** | `run_backtests.py:157-185` | 轮动组使用119只ETF并集进行一次性回测，未来季度才入选的标的被允许在早期交易 | **致命** |
| **指标计算错误** | `analyze_results.py:48-200` | 分析只做ETF横截面汇总，不是按时间切片计算组合收益 | **严重** |

**v1实际对比的是**："119只ETF的更大固定池" vs "20只ETF的固定小池"
**而非**："季度动态轮动" vs "固定池"

### 9.2 v2设计方案：分季度独立回测

**核心思路**：每个季度独立运行回测，严格限制可交易标的，然后拼接权益曲线计算组合指标。

#### 9.2.1 回测执行流程

```
┌─────────────────────────────────────────────────────────────────┐
│                       轮动组回测 (8次)                            │
├─────────────────────────────────────────────────────────────────┤
│ 2024Q1: pool_2024Q1.csv (20只) → 2024-01-01~2024-03-31         │
│ 2024Q2: pool_2024Q2.csv (20只) → 2024-04-01~2024-06-30         │
│ 2024Q3: pool_2024Q3.csv (20只) → 2024-07-01~2024-09-30         │
│ 2024Q4: pool_2024Q4.csv (20只) → 2024-10-01~2024-12-31         │
│ 2025Q1: pool_2025Q1.csv (20只) → 2025-01-01~2025-03-31         │
│ 2025Q2: pool_2025Q2.csv (20只) → 2025-04-01~2025-06-30         │
│ 2025Q3: pool_2025Q3.csv (20只) → 2025-07-01~2025-09-30         │
│ 2025Q4: pool_2025Q4.csv (20只) → 2025-10-01~2025-11-30         │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                       固定组回测 (1次)                            │
├─────────────────────────────────────────────────────────────────┤
│ static_pool.csv (20只) → 2024-01-01~2025-11-30 (完整时间段)      │
└─────────────────────────────────────────────────────────────────┘
```

#### 9.2.2 组合净值计算方法

**等权组合假设**：每季度池子内20只ETF各占5%权重

**季度内组合收益计算**：
```python
# 对于季度Q内的每只ETF，读取其该季度的总收益率
quarterly_returns = []
for etf in pool_Q:
    etf_return = read_backtest_result(etf, Q)  # 该ETF在Q季度的收益率
    quarterly_returns.append(etf_return)

# 等权组合收益 = 所有ETF收益的平均值
portfolio_return_Q = mean(quarterly_returns)
```

**组合净值拼接**：
```python
nav = 1.0  # 初始净值
for Q in [2024Q1, 2024Q2, ..., 2025Q4]:
    portfolio_return_Q = calculate_quarterly_portfolio_return(Q)
    nav = nav * (1 + portfolio_return_Q / 100)  # 累积净值
```

#### 9.2.3 指标计算

**整体指标**（从拼接后的组合净值序列计算）：
- 总收益率 = (最终NAV / 1.0 - 1) × 100%
- 年化收益率 = 总收益率 / 回测年数
- 最大回撤 = 从组合净值序列计算
- 夏普比率 = 年化收益 / 年化波动率

**分季度指标**：
- 每季度的组合收益率（等权平均）
- 每季度的组合夏普比率
- 每季度的组合最大回撤

### 9.3 v2目录结构

```
experiment/etf/quarterly_rotation/
├── EXPERIMENT_PLAN.md              # 本文档
├── EXPERIMENT_RESULTS.md           # v1结果（已废弃）
├── EXPERIMENT_RESULTS_V2.md        # v2结果（新）
├── configs/                        # 配置文件（复用）
├── pools/                          # 季度池子（复用）
├── pool_rotation_schedule.json     # 轮动表（复用）
├── pool_changes.json               # 池子变化（复用）
├── scripts/
│   ├── generate_configs.py         # 复用
│   ├── generate_pools.py           # 复用
│   ├── run_backtests.py            # v1（废弃）
│   ├── run_backtests_v2.py         # v2：分季度独立回测
│   ├── analyze_results.py          # v1（废弃）
│   └── analyze_results_v2.py       # v2：拼接净值+组合指标
└── results/
    ├── rotation_v2/                # 轮动组v2结果
    │   ├── 2024Q1/                 # 2024Q1季度回测
    │   │   ├── {symbol}/           # 各ETF结果
    │   │   └── summary/
    │   ├── 2024Q2/
    │   ├── ...
    │   └── 2025Q4/
    ├── static/                     # 固定组结果（复用）
    └── comparison_v2/              # v2对比结果
        ├── rotation_portfolio_nav.csv    # 轮动组合净值序列
        ├── static_portfolio_nav.csv      # 固定组合净值序列
        ├── quarterly_comparison.csv      # 分季度对比
        ├── overall_comparison.json       # 整体对比
        └── ANALYSIS_REPORT_V2.md         # v2分析报告
```

### 9.4 v2关键设计决策

| 决策点 | v1做法 | v2做法 | 理由 |
|--------|--------|--------|------|
| 回测粒度 | 全量ETF一次性回测 | 分季度独立回测 | 避免前视偏差 |
| 可交易标的 | 119只并集 | 每季度仅该季度池子的20只 | 真实模拟轮动 |
| 指标计算 | ETF横截面均值 | 等权组合净值 | 反映组合真实表现 |
| 结果格式 | 每只ETF的整段夏普 | 每季度组合收益+拼接净值 | 时间维度可对比 |

### 9.5 v2验证要点

实验完成后需验证：
1. **无前视偏差**：每季度回测只使用该季度池子的ETF
2. **组合收益计算正确**：等权平均、净值拼接逻辑无误
3. **指标可解释**：夏普、回撤等指标计算方法明确
4. **结论可信**：轮动组vs固定组的对比基于相同方法论

---

## 十、开发记录

### 2025-12-07 方案确认

- [x] KAMA策略参数：使用 `POOL_COMPARISON_PLAN.md` 的 4.1 节配置
- [x] 池子换仓规则：entry universe 模式，不强制清仓
- [x] 资金管理：方案A，每只ETF独立资金
- [x] 异常处理：不做妥协，直接抛出
- [ ] backtest_runner 动态池子支持：待开发
- [ ] 单元测试验证：待执行

---

*文档创建时间：2025-12-07*
*最后更新：2025-12-07*
