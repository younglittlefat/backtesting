# MACDç­–ç•¥æ­¢æŸè¶…å‚ç½‘æ ¼æœç´¢å®éªŒéœ€æ±‚æ–‡æ¡£

**å®éªŒæ—¥æœŸ**: 2025-11-09
**å®éªŒç›®æ ‡**: é€šè¿‡ç½‘æ ¼æœç´¢ä¼˜åŒ–MACDç­–ç•¥çš„æ­¢æŸä¿æŠ¤å‚æ•°ï¼Œæå‡é£é™©è°ƒæ•´åæ”¶ç›Šï¼ˆå¤æ™®æ¯”ç‡ï¼‰
**å®éªŒç±»å‹**: è¶…å‚æ•°ä¼˜åŒ–å®éªŒ

## 1. èƒŒæ™¯ä¸åŠ¨æœº

### 1.1 ä¸šåŠ¡èƒŒæ™¯

MACDç­–ç•¥ï¼ˆ`strategies/macd_cross.py`ï¼‰å·²ç»å®ç°äº†ä¸‰ç§æ­¢æŸæ–¹å¼ï¼š
1. **è¿ç»­æ­¢æŸä¿æŠ¤ï¼ˆLoss Protectionï¼‰**: è¿ç»­Næ¬¡äºæŸåæš‚åœäº¤æ˜“
2. **è·Ÿè¸ªæ­¢æŸï¼ˆTrailing Stopï¼‰**: ä»·æ ¼å›æ’¤è¾¾åˆ°é˜ˆå€¼æ—¶æ­¢æŸ
3. **ç»„åˆæ­¢æŸï¼ˆCombinedï¼‰**: åŒæ—¶å¯ç”¨ä¸Šè¿°ä¸¤ç§æ­¢æŸ

æ ¹æ®SMAç­–ç•¥çš„æ­¢æŸå®éªŒï¼ˆ`requirement_docs/20251109_native_stop_loss_implementation.md`ï¼‰ï¼Œè¿ç»­æ­¢æŸä¿æŠ¤è¡¨ç°æœ€ä¼˜ï¼š
- å¤æ™®æ¯”ç‡æå‡ **+75%** (0.61 â†’ 1.07)
- æœ€å¤§å›æ’¤é™ä½ **-34%** (-21% â†’ -14%)
- èƒœç‡æå‡ **+27%** (48% â†’ 61%)

ä½†è¯¥å®éªŒä»…æµ‹è¯•äº†**å›ºå®šå‚æ•°**ï¼Œæœªè¿›è¡Œç³»ç»Ÿæ€§çš„å‚æ•°æœç´¢ã€‚MACDç­–ç•¥éœ€è¦é€šè¿‡ç½‘æ ¼æœç´¢æ‰¾åˆ°æœ€ä¼˜æ­¢æŸå‚æ•°ç»„åˆã€‚

### 1.2 å®éªŒå¿…è¦æ€§

**é—®é¢˜**ï¼šå½“å‰MACDç­–ç•¥ä½¿ç”¨é»˜è®¤æ­¢æŸå‚æ•°ï¼Œæœªç»ä¼˜åŒ–
- è¿ç»­æ­¢æŸä¿æŠ¤ï¼š`max_consecutive_losses=3, pause_bars=10`
- è·Ÿè¸ªæ­¢æŸï¼š`trailing_stop_pct=0.05` (5%)

**ç›®æ ‡**ï¼šé€šè¿‡ç½‘æ ¼æœç´¢å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š
1. å“ªç§æ­¢æŸæ–¹å¼å¯¹MACDç­–ç•¥æ•ˆæœæœ€å¥½ï¼Ÿ
2. å„æ­¢æŸæ–¹å¼çš„æœ€ä¼˜å‚æ•°æ˜¯ä»€ä¹ˆï¼Ÿ
3. ä¸åŒå‚æ•°ç»„åˆå¯¹å¤æ™®æ¯”ç‡çš„å½±å“å¦‚ä½•ï¼Ÿ
4. æ˜¯å¦å­˜åœ¨å‚æ•°æ•æ„Ÿæ€§é—®é¢˜ï¼Ÿ

## 2. å®éªŒè®¾è®¡

### 2.1 æµ‹è¯•é…ç½®

| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|-----|------|
| **åŸºç¡€ç­–ç•¥** | `macd_cross` | MACDé‡‘å‰æ­»å‰ç­–ç•¥ |
| **æµ‹è¯•æ ‡çš„æ± ** | `results/trend_etf_pool.csv` | 20åªè¶‹åŠ¿å‹ä¸­å›½ETF |
| **æ•°æ®ç›®å½•** | `data/chinese_etf/daily` | æ—¥çº¿çº§åˆ«æ•°æ® |
| **æµ‹è¯•å‘¨æœŸ** | 2023-11è‡³2025-11 | çº¦2å¹´å†å²æ•°æ® |
| **åŸºå‡†å‘½ä»¤** | `./run_backtest.sh --stock-list results/trend_etf_pool.csv --strategy macd_cross --optimize --data-dir data/chinese_etf/daily` | å¯ç”¨å‚æ•°ä¼˜åŒ– |

### 2.2 ç½‘æ ¼æœç´¢æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šè¿ç»­æ­¢æŸä¿æŠ¤ï¼ˆLoss Protectionï¼‰â­ ä¼˜å…ˆçº§æœ€é«˜

**å¯ç”¨å‚æ•°**: `--enable-macd-loss-protection`

**æœç´¢ç©ºé—´**:
```python
grid_loss_protection = {
    'max_consecutive_losses': [2, 3, 4, 5],      # è¿ç»­äºæŸæ¬¡æ•°é˜ˆå€¼
    'pause_bars': [5, 10, 15, 20],               # æš‚åœäº¤æ˜“Kçº¿æ•°
}
```

**æ€»è®¡**: 4 Ã— 4 = **16ç§å‚æ•°ç»„åˆ**

**é¢„æœŸè€—æ—¶**: ~2-3å°æ—¶ï¼ˆ20åªæ ‡çš„ Ã— 16ç»„åˆ Ã— ä¼˜åŒ–ï¼‰

#### æ–¹æ¡ˆ2ï¼šè·Ÿè¸ªæ­¢æŸï¼ˆTrailing Stopï¼‰

**å¯ç”¨å‚æ•°**: `--enable-macd-trailing-stop`

**æœç´¢ç©ºé—´**:
```python
grid_trailing_stop = {
    'trailing_stop_pct': [0.03, 0.05, 0.07, 0.10],  # è·Ÿè¸ªæ­¢æŸç™¾åˆ†æ¯”ï¼š3%, 5%, 7%, 10%
}
```

**æ€»è®¡**: **4ç§å‚æ•°ç»„åˆ**

**é¢„æœŸè€—æ—¶**: ~30-45åˆ†é’Ÿ

#### æ–¹æ¡ˆ3ï¼šç»„åˆæ­¢æŸï¼ˆCombinedï¼‰

**å¯ç”¨å‚æ•°**: `--enable-macd-loss-protection --enable-macd-trailing-stop`

**æœç´¢ç©ºé—´**:
```python
grid_combined = {
    'max_consecutive_losses': [2, 3, 4],         # è¿ç»­äºæŸæ¬¡æ•°
    'pause_bars': [5, 10, 15],                   # æš‚åœKçº¿æ•°
    'trailing_stop_pct': [0.03, 0.05, 0.07],     # è·Ÿè¸ªæ­¢æŸç™¾åˆ†æ¯”
}
```

**æ€»è®¡**: 3 Ã— 3 Ã— 3 = **27ç§å‚æ•°ç»„åˆ**

**é¢„æœŸè€—æ—¶**: ~3-4å°æ—¶

#### æ–¹æ¡ˆ4ï¼šBaselineï¼ˆæ— æ­¢æŸï¼‰

**ç”¨é€”**: ä½œä¸ºå¯¹ç…§ç»„ï¼Œè¯„ä¼°æ­¢æŸä¿æŠ¤çš„ä»·å€¼

**å‚æ•°**: ä½¿ç”¨MACDé»˜è®¤å‚æ•°ï¼Œä¸å¯ç”¨ä»»ä½•æ­¢æŸ

**æ€»è®¡**: **1ç§é…ç½®**

### 2.3 å®éªŒé˜¶æ®µå®‰æ’

**é˜¶æ®µ1**: Baseline + Loss Protectionï¼ˆ1 + 16 = 17æ¬¡å®éªŒï¼‰
- é¢„æœŸè€—æ—¶ï¼š~2-3å°æ—¶
- ç›®æ ‡ï¼šç¡®è®¤è¿ç»­æ­¢æŸä¿æŠ¤å¯¹MACDçš„æ•ˆæœ

**é˜¶æ®µ2**: Trailing Stopï¼ˆ4æ¬¡å®éªŒï¼‰
- é¢„æœŸè€—æ—¶ï¼š~30-45åˆ†é’Ÿ
- ç›®æ ‡ï¼šè¯„ä¼°è·Ÿè¸ªæ­¢æŸçš„æœ€ä¼˜å‚æ•°

**é˜¶æ®µ3**: Combinedï¼ˆ27æ¬¡å®éªŒï¼‰
- é¢„æœŸè€—æ—¶ï¼š~3-4å°æ—¶
- ç›®æ ‡ï¼šæ¢ç´¢ç»„åˆæ–¹æ¡ˆçš„æ½œåŠ›

**æ€»è®¡**: 48æ¬¡å®éªŒï¼Œé¢„æœŸæ€»è€—æ—¶ **6-8å°æ—¶**

## 3. è¯„ä¼°æŒ‡æ ‡

### 3.1 ä¸»è¦æŒ‡æ ‡ï¼ˆPrimary Metricsï¼‰

| æŒ‡æ ‡ | è¯´æ˜ | ç›®æ ‡ |
|------|------|------|
| **å¤æ™®æ¯”ç‡ï¼ˆSharpe Ratioï¼‰** | é£é™©è°ƒæ•´åæ”¶ç›Š | æœ€å¤§åŒ–ï¼ˆä¸»è¦ä¼˜åŒ–ç›®æ ‡ï¼‰ |
| **å¹³å‡æ”¶ç›Šç‡ï¼ˆAvg Returnï¼‰** | å¹³å‡å¹´åŒ–æ”¶ç›Š | ä¿æŒæˆ–æå‡ |
| **æœ€å¤§å›æ’¤ï¼ˆMax Drawdownï¼‰** | æœ€å¤§å›æ’¤ç™¾åˆ†æ¯” | æœ€å°åŒ– |
| **èƒœç‡ï¼ˆWin Rateï¼‰** | ç›ˆåˆ©äº¤æ˜“å æ¯” | æå‡ |

### 3.2 æ¬¡è¦æŒ‡æ ‡ï¼ˆSecondary Metricsï¼‰

| æŒ‡æ ‡ | è¯´æ˜ | ä½œç”¨ |
|------|------|------|
| æ”¶ç›Šæ ‡å‡†å·® | æ”¶ç›Šæ³¢åŠ¨æ€§ | è¯„ä¼°ç¨³å®šæ€§ |
| æœ€å·®æ ‡çš„æ”¶ç›Š | æœ€ä½æ”¶ç›Šç‡ | è¯„ä¼°ä¸‹è¡Œé£é™© |
| å¹³å‡äº¤æ˜“æ¬¡æ•° | äº¤æ˜“é¢‘ç‡ | è¯„ä¼°ç­–ç•¥æ´»è·ƒåº¦ |
| è§¦å‘æš‚åœæ¬¡æ•° | æ­¢æŸä¿æŠ¤æ¿€æ´»æ¬¡æ•° | ç†è§£æ­¢æŸå·¥ä½œæœºåˆ¶ |

### 3.3 å‚æ•°æ•æ„Ÿæ€§åˆ†æ

é€šè¿‡çƒ­åŠ›å›¾ï¼ˆHeatmapï¼‰å¯è§†åŒ–ï¼š
- `max_consecutive_losses` vs `pause_bars` å¯¹å¤æ™®æ¯”ç‡çš„å½±å“
- `trailing_stop_pct` å¯¹å„æŒ‡æ ‡çš„å½±å“
- è¯†åˆ«å‚æ•°ç¨³å®šåŒºé—´ï¼ˆå‚æ•°å˜åŒ–å¯¹ç»“æœå½±å“å°çš„åŒºåŸŸï¼‰

## 4. æŠ€æœ¯å®ç°

### 4.1 è„šæœ¬è®¾è®¡

**ä¸»è„šæœ¬**: `experiment/etf/macd_cross/grid_search_stop_loss/grid_search.py`

**æ ¸å¿ƒåŠŸèƒ½**:
1. å®šä¹‰ä¸‰ç§æ­¢æŸæ–¹æ¡ˆçš„å‚æ•°ç½‘æ ¼
2. éå†å‚æ•°ç»„åˆï¼Œè°ƒç”¨`backtest_runner.py`æ‰§è¡Œå›æµ‹
3. æ”¶é›†æ¯æ¬¡å›æµ‹çš„ç»Ÿè®¡ç»“æœ
4. æ±‡æ€»ç»“æœåˆ°CSVå’ŒMarkdownæŠ¥å‘Š
5. ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨ï¼ˆçƒ­åŠ›å›¾ã€å¯¹æ¯”å›¾ï¼‰

**è¾“å‡ºæ–‡ä»¶**:
- `results_baseline.csv` - Baselineç»“æœ
- `results_loss_protection.csv` - è¿ç»­æ­¢æŸä¿æŠ¤ç»“æœ
- `results_trailing_stop.csv` - è·Ÿè¸ªæ­¢æŸç»“æœ
- `results_combined.csv` - ç»„åˆæ­¢æŸç»“æœ
- `summary_statistics.csv` - æ±‡æ€»ç»Ÿè®¡
- `RESULTS.md` - è¯¦ç»†å®éªŒæŠ¥å‘Š

### 4.2 è°ƒç”¨æ–¹å¼

**æ–¹å¼1ï¼šé€šè¿‡backtest_runner.pyè°ƒç”¨**
```python
import subprocess

def run_single_experiment(stock_list, data_dir, stop_loss_config):
    """
    æ‰§è¡Œå•æ¬¡å›æµ‹å®éªŒ

    Args:
        stock_list: æ ‡çš„æ± CSVæ–‡ä»¶è·¯å¾„
        data_dir: æ•°æ®ç›®å½•
        stop_loss_config: æ­¢æŸé…ç½®å­—å…¸
            {
                'enable_loss_protection': bool,
                'max_consecutive_losses': int,
                'pause_bars': int,
                'enable_trailing_stop': bool,
                'trailing_stop_pct': float,
            }

    Returns:
        dict: å›æµ‹ç»Ÿè®¡ç»“æœ
    """
    cmd = [
        'python', 'backtest_runner.py',
        '--stock-list', stock_list,
        '--strategy', 'macd_cross',
        '--data-dir', data_dir,
        '--optimize',  # å¯ç”¨MACDå‚æ•°ä¼˜åŒ–
    ]

    # æ·»åŠ æ­¢æŸå‚æ•°
    if stop_loss_config.get('enable_loss_protection'):
        cmd.extend([
            '--enable-macd-loss-protection',
            '--macd-max-consecutive-losses', str(stop_loss_config['max_consecutive_losses']),
            '--macd-pause-bars', str(stop_loss_config['pause_bars']),
        ])

    if stop_loss_config.get('enable_trailing_stop'):
        cmd.extend([
            '--enable-macd-trailing-stop',
            '--macd-trailing-stop-pct', str(stop_loss_config['trailing_stop_pct']),
        ])

    # æ‰§è¡Œå‘½ä»¤å¹¶è§£æç»“æœ
    result = subprocess.run(cmd, capture_output=True, text=True)
    # ... è§£æè¾“å‡ºï¼Œæå–ç»Ÿè®¡æŒ‡æ ‡
    return stats
```

**æ–¹å¼2ï¼šé€šè¿‡Python APIç›´æ¥è°ƒç”¨**ï¼ˆæ¨èï¼Œæ›´å¿«ï¼‰
```python
from backtesting import Backtest
from strategies.macd_cross import MacdCross
import pandas as pd

def run_backtest_with_params(data, stop_loss_config):
    """
    ä½¿ç”¨æŒ‡å®šæ­¢æŸå‚æ•°è¿è¡Œå›æµ‹
    """
    bt = Backtest(
        data,
        MacdCross,
        cash=10000,
        commission=0.002
    )

    # æ„å»ºä¼˜åŒ–å‚æ•°å’Œå›ºå®šå‚æ•°
    optimize_params = {
        'fast_period': range(8, 21, 2),
        'slow_period': range(20, 41, 2),
        'signal_period': range(6, 15, 2),
        'enable_loss_protection': [stop_loss_config.get('enable_loss_protection', False)],
        'enable_trailing_stop': [stop_loss_config.get('enable_trailing_stop', False)],
        # ... å…¶ä»–å›ºå®šå‚æ•°
    }

    stats = bt.optimize(
        **optimize_params,
        maximize='Sharpe Ratio',
        constraint=lambda p: p.fast_period < p.slow_period
    )

    return stats
```

### 4.3 æ•°æ®ç»“æ„

**å•æ¬¡å®éªŒç»“æœ**:
```python
{
    'stock_code': '510300.SH',           # æ ‡çš„ä»£ç 
    'strategy': 'loss_protection',       # æ­¢æŸæ–¹æ¡ˆ
    'max_consecutive_losses': 3,         # è¿ç»­äºæŸé˜ˆå€¼
    'pause_bars': 10,                    # æš‚åœKçº¿æ•°
    'trailing_stop_pct': None,           # è·Ÿè¸ªæ­¢æŸæ¯”ä¾‹
    'return_pct': 53.91,                 # æ”¶ç›Šç‡
    'sharpe_ratio': 1.07,                # å¤æ™®æ¯”ç‡
    'max_drawdown_pct': -13.88,          # æœ€å¤§å›æ’¤
    'win_rate_pct': 61.42,               # èƒœç‡
    'num_trades': 6,                     # äº¤æ˜“æ¬¡æ•°
    'optimized_params': {                # ä¼˜åŒ–åçš„MACDå‚æ•°
        'fast_period': 12,
        'slow_period': 26,
        'signal_period': 9,
    }
}
```

## 5. éªŒæ”¶æ ‡å‡†

### 5.1 åŠŸèƒ½éªŒæ”¶

- [ ] è„šæœ¬èƒ½å¤Ÿæ­£ç¡®è°ƒç”¨`backtest_runner.py`æˆ–Python API
- [ ] å‚æ•°ç½‘æ ¼éå†å®Œæ•´ï¼Œæ— é—æ¼
- [ ] æ¯ä¸ªæ ‡çš„çš„å›æµ‹ç»“æœæ­£ç¡®ä¿å­˜
- [ ] CSVæ–‡ä»¶æ ¼å¼æ­£ç¡®ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ
- [ ] å®éªŒæŠ¥å‘Šï¼ˆRESULTS.mdï¼‰è‡ªåŠ¨ç”Ÿæˆ

### 5.2 ç»“æœéªŒæ”¶

- [ ] æ±‡æ€»ç»Ÿè®¡è¡¨æ¸…æ™°å±•ç¤ºå„æ–¹æ¡ˆçš„å¹³å‡è¡¨ç°
- [ ] è¯†åˆ«å‡ºå¤æ™®æ¯”ç‡æœ€é«˜çš„å‚æ•°ç»„åˆ
- [ ] ç”Ÿæˆå‚æ•°æ•æ„Ÿæ€§åˆ†æå›¾è¡¨ï¼ˆçƒ­åŠ›å›¾ï¼‰
- [ ] å¯¹æ¯”ä¸åŒæ­¢æŸæ–¹æ¡ˆçš„ä¼˜åŠ£
- [ ] æä¾›æ˜ç¡®çš„å‚æ•°æ¨è

### 5.3 æ–‡æ¡£éªŒæ”¶

- [ ] RESULTS.mdåŒ…å«å®éªŒç›®çš„ã€æ–¹æ³•ã€ç»“æœã€ç»“è®º
- [ ] åŒ…å«è¯¦ç»†çš„ç»Ÿè®¡è¡¨æ ¼å’Œå¯è§†åŒ–å›¾è¡¨
- [ ] è¯´æ˜æ¯ç§æ­¢æŸæ–¹æ¡ˆçš„é€‚ç”¨åœºæ™¯
- [ ] æä¾›æœ€ä¼˜å‚æ•°é…ç½®çš„ä½¿ç”¨ç¤ºä¾‹

## 6. é¢„æœŸæˆæœ

### 6.1 æ ¸å¿ƒäº§å‡º

1. **æœ€ä¼˜å‚æ•°é…ç½®**
   - è¿ç»­æ­¢æŸä¿æŠ¤çš„æœ€ä½³`(max_consecutive_losses, pause_bars)`ç»„åˆ
   - è·Ÿè¸ªæ­¢æŸçš„æœ€ä½³`trailing_stop_pct`å€¼
   - ç»„åˆæ­¢æŸçš„æœ€ä½³ä¸‰å‚æ•°é…ç½®

2. **æ€§èƒ½æå‡æŠ¥å‘Š**
   - ç›¸æ¯”Baselineï¼Œå¤æ™®æ¯”ç‡æå‡ç™¾åˆ†æ¯”
   - æœ€å¤§å›æ’¤é™ä½å¹…åº¦
   - èƒœç‡æ”¹å–„æƒ…å†µ

3. **å‚æ•°æ•æ„Ÿæ€§æ´å¯Ÿ**
   - å“ªäº›å‚æ•°å¯¹ç»“æœå½±å“æœ€å¤§ï¼Ÿ
   - å“ªäº›å‚æ•°åŒºé—´ç›¸å¯¹ç¨³å®šï¼Ÿ
   - æ˜¯å¦å­˜åœ¨è¿‡æ‹Ÿåˆé£é™©ï¼Ÿ

### 6.2 æ–‡æ¡£æ›´æ–°

å®éªŒå®Œæˆåï¼Œæ›´æ–°ä»¥ä¸‹æ–‡æ¡£ï¼š

1. **`requirement_docs/20251109_macd_strategy_implementation.md`**
   - æ·»åŠ å®éªŒéªŒè¯çš„æœ€ä¼˜æ­¢æŸå‚æ•°æ¨è
   - æ›´æ–°å‚æ•°è¡¨çš„"æ¨èå€¼"åˆ—

2. **`CLAUDE.md`**
   - æ·»åŠ MACDç­–ç•¥çš„æ­¢æŸä¼˜åŒ–æ¡ˆä¾‹
   - æä¾›å¿«é€Ÿå¯åŠ¨çš„æœ€ä¼˜å‚æ•°å‘½ä»¤

3. **`strategies/macd_cross.py`**
   - å¯é€‰ï¼šæ›´æ–°é»˜è®¤å‚æ•°ä¸ºå®éªŒéªŒè¯çš„æœ€ä¼˜å€¼

### 6.3 å¯è§†åŒ–ç¤ºä¾‹

**çƒ­åŠ›å›¾1**: è¿ç»­æ­¢æŸä¿æŠ¤å‚æ•°ç©ºé—´
```
        pause_bars
        5    10   15   20
max_    2  0.95 1.02 0.98 0.92
losses  3  1.01 1.07 1.05 0.99
        4  0.96 1.03 1.01 0.97
        5  0.89 0.95 0.93 0.90

é¢œè‰²ï¼šçº¢è‰²=é«˜å¤æ™®æ¯”ç‡ï¼Œè“è‰²=ä½å¤æ™®æ¯”ç‡
```

**å¯¹æ¯”å›¾**: å„æ–¹æ¡ˆå¤æ™®æ¯”ç‡åˆ†å¸ƒ
```
        Baseline  Loss Prot  Trailing  Combined
Sharpe    0.61      1.07       0.91      1.01
Drawdown -21.17%  -13.88%    -12.77%   -12.87%
```

## 7. é£é™©ä¸æ³¨æ„äº‹é¡¹

### 7.1 è®¡ç®—èµ„æº

- æ€»å®éªŒæ¬¡æ•°ï¼š48æ¬¡ Ã— 20æ ‡çš„ = 960æ¬¡å›æµ‹
- æ¯æ¬¡å›æµ‹å¯ç”¨`--optimize`ï¼Œéœ€è¦éå†MACDå‚æ•°ç©ºé—´
- é¢„è®¡æ€»è€—æ—¶ï¼š6-8å°æ—¶
- å»ºè®®ï¼šåˆ†é˜¶æ®µæ‰§è¡Œï¼Œå…ˆå®ŒæˆPhase 1éªŒè¯å¯è¡Œæ€§

### 7.2 è¿‡æ‹Ÿåˆé£é™©

- ç½‘æ ¼æœç´¢å¯èƒ½å¯¼è‡´å‚æ•°è¿‡æ‹Ÿåˆå†å²æ•°æ®
- ç¼“è§£æªæ–½ï¼š
  - å…³æ³¨å‚æ•°ç¨³å®šæ€§ï¼ˆæ•æ„Ÿæ€§åˆ†æï¼‰
  - ä¼˜å…ˆé€‰æ‹©å‚æ•°ä¸æ•æ„ŸåŒºåŸŸçš„é…ç½®
  - æœªæ¥åœ¨ä¸åŒå¸‚åœºç¯å¢ƒä¸­éªŒè¯

### 7.3 æ•°æ®è´¨é‡

- ç¡®ä¿`results/trend_etf_pool.csv`ä¸­çš„æ ‡çš„æ•°æ®å®Œæ•´
- æ•°æ®æ—¶é—´èŒƒå›´ï¼š2023-11è‡³2025-11
- æ£€æŸ¥æ˜¯å¦æœ‰åœç‰Œæˆ–å¼‚å¸¸æ•°æ®

## 8. åç»­æ‰©å±•

å®éªŒå®Œæˆåçš„å¯é€‰æ‰©å±•æ–¹å‘ï¼š

1. **å¤šå¸‚åœºéªŒè¯**
   - åœ¨ç¾è‚¡ETFæ± ä¸Šé‡å¤å®éªŒ
   - éªŒè¯å‚æ•°çš„è·¨å¸‚åœºé€šç”¨æ€§

2. **ç»„åˆè¿‡æ»¤å™¨**
   - åŒæ—¶å¯ç”¨ADXã€æˆäº¤é‡ç­‰è¿‡æ»¤å™¨
   - æµ‹è¯•æ­¢æŸ + è¿‡æ»¤å™¨çš„ç»„åˆæ•ˆæœ

3. **æ»šåŠ¨çª—å£å›æµ‹**
   - Walk-forwardåˆ†æ
   - è¯„ä¼°å‚æ•°çš„æ—¶é—´ç¨³å®šæ€§

4. **å®ç›˜éªŒè¯**
   - ä½¿ç”¨æœ€ä¼˜å‚æ•°è¿›è¡Œæ¨¡æ‹Ÿç›˜æµ‹è¯•
   - æ”¶é›†å®é™…äº¤æ˜“çš„è¡¨ç°æ•°æ®

## 9. å‚è€ƒèµ„æ–™

- **MACDç­–ç•¥æ–‡æ¡£**: `requirement_docs/20251109_macd_strategy_implementation.md`
- **æ­¢æŸå®éªŒå‚è€ƒ**: `requirement_docs/20251109_native_stop_loss_implementation.md`
- **SMAæ­¢æŸå®éªŒä»£ç **: `experiment/etf/sma_cross/stop_loss_comparison/compare_stop_loss.py`
- **ç­–ç•¥å®ç°ä»£ç **: `strategies/macd_cross.py`
- **å›æµ‹æ¡†æ¶å…¥å£**: `backtest_runner.py`

## 10. æ—¶é—´è¡¨

| ä»»åŠ¡ | é¢„è®¡è€—æ—¶ | è´Ÿè´£äºº | çŠ¶æ€ |
|------|----------|--------|------|
| éœ€æ±‚æ–‡æ¡£ç¼–å†™ | 1å°æ—¶ | Claude Code | âœ… å·²å®Œæˆ |
| è„šæœ¬å¼€å‘ | 2-3å°æ—¶ | å¾…å®š | ğŸ”² å¾…å¼€å§‹ |
| Phase 1: Baseline + Loss Protection | 2-3å°æ—¶ | å¾…å®š | ğŸ”² å¾…å¼€å§‹ |
| Phase 2: Trailing Stop | 30-45åˆ†é’Ÿ | å¾…å®š | ğŸ”² å¾…å¼€å§‹ |
| Phase 3: Combined | 3-4å°æ—¶ | å¾…å®š | ğŸ”² å¾…å¼€å§‹ |
| ç»“æœåˆ†æä¸æŠ¥å‘Š | 2å°æ—¶ | å¾…å®š | ğŸ”² å¾…å¼€å§‹ |
| æ–‡æ¡£æ›´æ–° | 1å°æ—¶ | å¾…å®š | ğŸ”² å¾…å¼€å§‹ |
| **æ€»è®¡** | **11-15å°æ—¶** | | |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**åˆ›å»ºæ—¥æœŸ**: 2025-11-09
**æœ€åæ›´æ–°**: 2025-11-10
**æ–‡æ¡£çŠ¶æ€**: âœ… å®éªŒå…¨éƒ¨å®Œæˆï¼ˆæ‰€æœ‰4ä¸ªé˜¶æ®µï¼‰

---

## 11. å®éªŒç»“æœ âœ… å®Œæˆ

### 11.1 Phase 1: Baselineç»“æœ âœ…

**æ‰§è¡Œæ—¶é—´**: 2025-11-09
**æµ‹è¯•æ ‡çš„**: 20åªä¸­å›½ETF
**æµ‹è¯•å‘¨æœŸ**: 2023-11è‡³2025-11ï¼ˆçº¦2å¹´ï¼‰

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| å¹³å‡å¤æ™®æ¯”ç‡ | 0.73 |
| å¹³å‡æ”¶ç›Šç‡ | 75.84% |
| å¹³å‡æœ€å¤§å›æ’¤ | -20.12% |
| å¹³å‡èƒœç‡ | 48.88% |
| æˆåŠŸç‡ | 100% (20/20) |

**æœ€ä½³æ ‡çš„**: 588870.SHï¼ˆå¤æ™®1.31ï¼Œæ”¶ç›Š195.93%ï¼‰
**æœ€å·®æ ‡çš„**: 588170.SHï¼ˆå¤æ™®-0.11ï¼Œæ”¶ç›Š-7.39%ï¼‰

### 11.2 Phase 2: Loss Protectionç»“æœ âœ…

**æ‰§è¡Œæ—¶é—´**: 2025-11-09
**å‚æ•°ç»„åˆ**: 16ç§ï¼ˆmax_consecutive_losses Ã— pause_barsï¼‰
**æ€»æµ‹è¯•æ¬¡æ•°**: 320æ¬¡ï¼ˆ16ç»„åˆ Ã— 20æ ‡çš„ï¼‰
**æˆåŠŸç‡**: 100% (320/320)

#### æœ€ä½³å‚æ•°ç»„åˆ

**æ¨èé…ç½®**: `max_consecutive_losses=3, pause_bars=20`

| æŒ‡æ ‡ | Baseline | Loss Protection | æ”¹å–„å¹…åº¦ |
|------|----------|----------------|----------|
| å¤æ™®æ¯”ç‡ | 0.73 | **0.85** | **+17.0%** |
| å¹³å‡æ”¶ç›Šç‡ | 75.84% | **83.07%** | **+9.5%** |
| æœ€å¤§å›æ’¤ | -20.12% | **-18.32%** | **-8.9%** |
| èƒœç‡ | 48.88% | 47.81% | -2.2% |

#### Top 3 å‚æ•°ç»„åˆï¼ˆæŒ‰å¤æ™®æ¯”ç‡æ’åºï¼‰

| æ’å | max_losses | pause_bars | å¤æ™®æ¯”ç‡ | æ”¶ç›Šç‡ | æœ€å¤§å›æ’¤ | èƒœç‡ |
|------|-----------|-----------|---------|--------|---------|------|
| 1 â­ | 3 | 20 | 0.85 | 83.07% | -18.32% | 47.81% |
| 2 | 2 | 20 | 0.82 | 82.12% | -18.71% | 50.00% |
| 3 | 3 | 15 | 0.79 | 79.32% | -19.21% | 46.83% |

#### å‚æ•°æ•æ„Ÿæ€§åˆ†æ

**æŒ‰ max_consecutive_losses åˆ†ç»„**:
- max_losses=2: å¹³å‡å¤æ™®0.78ï¼ˆæ ‡å‡†å·®0.0231ï¼‰
- max_losses=3: å¹³å‡å¤æ™®0.78ï¼ˆæ ‡å‡†å·®0.0251ï¼‰â­ æ¨è
- max_losses=4: å¹³å‡å¤æ™®0.73ï¼ˆæ ‡å‡†å·®0.0289ï¼‰
- max_losses=5: å¹³å‡å¤æ™®0.71ï¼ˆæ ‡å‡†å·®0.0312ï¼‰

**æŒ‰ pause_bars åˆ†ç»„**:
- pause_bars=5: å¹³å‡å¤æ™®0.73ï¼ˆæ ‡å‡†å·®0.0298ï¼‰
- pause_bars=10: å¹³å‡å¤æ™®0.75ï¼ˆæ ‡å‡†å·®0.0281ï¼‰
- pause_bars=15: å¹³å‡å¤æ™®0.77ï¼ˆæ ‡å‡†å·®0.0267ï¼‰
- pause_bars=20: å¹³å‡å¤æ™®0.79ï¼ˆæ ‡å‡†å·®0.0243ï¼‰â­ æ¨è

**å…³é”®å‘ç°**:
1. **pause_bars å½±å“æ›´å¤§**: è¾ƒé•¿æš‚åœæœŸï¼ˆ15-20ï¼‰èƒ½æ›´å¥½è¯†åˆ«å¸‚åœºçŠ¶æ€è½¬æ¢
2. **max_consecutive_losses=2æˆ–3æœ€ä¼˜**: è¿‡åº¦ä¿æŠ¤ï¼ˆ4-5ï¼‰ä¼šé”™å¤±äº¤æ˜“æœºä¼š
3. **å‚æ•°ç¨³å®šæ€§å¥½**: Top 3é…ç½®å¤æ™®å·®å¼‚å°äº0.06ï¼Œå®¹é”™æ€§å¼º
4. **å›æ’¤æ§åˆ¶ä¼˜ç§€**: æœ€ä¼˜é…ç½®å°†æœ€å¤§å›æ’¤ä»-20.1%é™è‡³-18.3%

#### ç»“è®º

**Loss Protectionæ­¢æŸä¿æŠ¤éªŒè¯æˆåŠŸ**ï¼Œæ¨èä½¿ç”¨ä»¥ä¸‹é…ç½®ï¼š

```bash
./run_backtest.sh \
  --stock-list results/trend_etf_pool.csv \
  --strategy macd_cross \
  --enable-macd-loss-protection \
  --macd-max-consecutive-losses 3 \
  --macd-pause-bars 20 \
  --data-dir data/chinese_etf/daily \
  --optimize
```

**æ ¸å¿ƒä»·å€¼**:
- å¤æ™®æ¯”ç‡æå‡17%ï¼Œé£é™©è°ƒæ•´åæ”¶ç›Šæ˜¾è‘—æ”¹å–„
- æœ€å¤§å›æ’¤é™ä½8.9%ï¼Œä¸‹è¡Œé£é™©æœ‰æ•ˆæ§åˆ¶
- èƒœç‡ç•¥é™2.2%å¯æ¥å—ï¼Œæ•´ä½“é£é™©æ”¶ç›Šæ¯”ä¼˜åŒ–æˆåŠŸ

**ä¸‹ä¸€æ­¥**: ç»§ç»­Phase 3&4ï¼ˆTrailing Stop + Combinedï¼‰ä»¥è·å¾—å®Œæ•´å¯¹æ¯”åˆ†æã€‚

### 11.3 Phase 3: Trailing Stopç»“æœ âœ…

**æ‰§è¡Œæ—¶é—´**: 2025-11-09
**å‚æ•°ç»„åˆ**: 4ç§ï¼ˆtrailing_stop_pctï¼‰
**æ€»æµ‹è¯•æ¬¡æ•°**: 80æ¬¡ï¼ˆ4ç»„åˆ Ã— 20æ ‡çš„ï¼‰
**æˆåŠŸç‡**: 100% (80/80)

#### æœ€ä½³å‚æ•°

**æ¨èé…ç½®**: `trailing_stop_pct=0.07` (7%)

| æŒ‡æ ‡ | Baseline | Trailing Stop | æ”¹å–„å¹…åº¦ |
|------|----------|--------------|----------|
| å¤æ™®æ¯”ç‡ | 0.73 | **0.83** | **+13.7%** |
| å¹³å‡æ”¶ç›Šç‡ | 75.84% | 73.08% | -3.6% |
| æœ€å¤§å›æ’¤ | -20.12% | **-17.80%** | **+11.5%** |
| èƒœç‡ | 48.88% | 51.07% | +4.5% |

#### å‚æ•°æ•æ„Ÿæ€§

| trailing_stop_pct | å¤æ™®æ¯”ç‡ | æ”¶ç›Šç‡ | æœ€å¤§å›æ’¤ | ç‰¹ç‚¹ |
|------------------|---------|--------|---------|-----|
| 3% | 0.72 | 62.51% | -16.64% | æ­¢æŸè¿‡ç´§ï¼Œå‰Šå‡æ”¶ç›Š |
| 5% | 0.79 | 68.99% | -17.36% | å¹³è¡¡è¾ƒå¥½ |
| **7%** â­ | **0.83** | **73.08%** | **-17.80%** | **æœ€ä¼˜å¹³è¡¡ç‚¹** |
| 10% | 0.81 | 77.90% | -18.40% | æ­¢æŸè¿‡å®½ï¼Œå›æ’¤å¢åŠ  |

**å…³é”®å‘ç°**:
- 7%æ­¢æŸæä¾›æœ€ä½³é£é™©æ”¶ç›Šå¹³è¡¡
- ç›¸æ¯”Loss Protection (0.85)ï¼ŒTrailing Stop (0.83)ç•¥é€Šä¸€ç­¹
- ä»·æ ¼å›æ’¤ä¿æŠ¤ä¸å¦‚è¿ç»­äºæŸä¿æŠ¤æœ‰æ•ˆ

### 11.4 Phase 4: Combinedç»“æœ âœ…

**æ‰§è¡Œæ—¶é—´**: 2025-11-09
**å‚æ•°ç»„åˆ**: 27ç§ï¼ˆmax_consecutive_losses Ã— pause_bars Ã— trailing_stop_pctï¼‰
**æ€»æµ‹è¯•æ¬¡æ•°**: 540æ¬¡ï¼ˆ27ç»„åˆ Ã— 20æ ‡çš„ï¼‰
**æˆåŠŸç‡**: 100% (540/540)

#### æœ€ä½³å‚æ•°ç»„åˆï¼ˆååŒæ•ˆåº”éªŒè¯ï¼‰

**æ¨èé…ç½®**: `max_consecutive_losses=2, pause_bars=5, trailing_stop_pct=0.03`

| æŒ‡æ ‡ | Baseline | Combined | æ”¹å–„å¹…åº¦ |
|------|----------|---------|----------|
| å¤æ™®æ¯”ç‡ | 0.73 | **0.94** | **+28.8%** ğŸ¯ |
| å¹³å‡æ”¶ç›Šç‡ | 75.84% | 68.73% | -9.4% |
| æœ€å¤§å›æ’¤ | -20.12% | **-15.82%** | **+21.4%** |
| èƒœç‡ | 48.88% | 50.64% | +3.6% |

#### Top 5 å‚æ•°ç»„åˆ

| æ’å | max_losses | pause_bars | trailing_stop_pct | å¤æ™®æ¯”ç‡ | æ”¶ç›Šç‡ | æœ€å¤§å›æ’¤ |
|------|-----------|-----------|------------------|---------|--------|---------|
| 1 â­ | 2 | 5 | 3% | **0.94** | 68.73% | -15.82% |
| 2 | 2 | 15 | 3% | 0.89 | 66.40% | -16.37% |
| 3 | 2 | 10 | 3% | 0.88 | 64.64% | -16.09% |
| 4 | 3 | 5 | 3% | 0.87 | 67.52% | -16.21% |
| 5 | 2 | 20 | 3% | 0.87 | 67.71% | -16.48% |

**ååŒæ•ˆåº”åˆ†æ**:
- Loss Protectionå•ç‹¬: å¤æ™®0.85
- Trailing Stopå•ç‹¬: å¤æ™®0.83
- **Combinedç»„åˆ: å¤æ™®0.94** âœ… **ååŒæ•ˆåº”æ˜¾è‘—ï¼**

**å…³é”®å‘ç°**:
1. **åŒå±‚é˜²æŠ¤æœºåˆ¶äº’è¡¥å¢å¼º**: Combinedæ˜¾è‘—ä¼˜äºä»»ä¸€å•ç‹¬æ–¹æ¡ˆ
2. **å‚æ•°ç»„åˆä¼˜åŒ–**: Combinedæœ€ä¼˜å‚æ•°(2,5,3%)ä¸åŒäºLoss Protectionæœ€ä¼˜(3,20)
3. **æ›´æ¿€è¿›çš„è¿ç»­æ­¢æŸ** + **æ›´ç´§å¯†çš„è·Ÿè¸ªæ­¢æŸ** = æœ€ä½³é£é™©æ§åˆ¶

### 11.5 å››æ–¹æ¡ˆå…¨é¢å¯¹æ¯”

| ç­–ç•¥ | å¤æ™®æ¯”ç‡ | ç›¸æ¯”Baseline | æ”¶ç›Šç‡ | æœ€å¤§å›æ’¤ | èƒœç‡ | æ¨èåœºæ™¯ |
|------|----------|------------|--------|---------|------|---------|
| **Combined** â­ | **0.94** | **+28.8%** | 68.73% | **-15.82%** | 50.64% | é£é™©åŒæ¶å‹ |
| Loss Protection | 0.85 | +16.3% | 83.07% | -18.32% | 47.81% | æ”¶ç›Šä¼˜å…ˆå‹ |
| Trailing Stop | 0.83 | +13.7% | 73.08% | -17.80% | 51.07% | ç®€å•å®ç°å‹ |
| Baseline | 0.73 | - | 75.84% | -20.12% | 48.88% | æ¿€è¿›äº¤æ˜“å‹ |

### 11.6 æœ€ç»ˆç»“è®ºä¸æ¨è

#### ğŸ† ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®

**æœ€ä¼˜æ–¹æ¡ˆ**: Combinedï¼ˆç»„åˆæ­¢æŸï¼‰

```bash
./run_backtest.sh \
  --stock-list results/trend_etf_pool.csv \
  --strategy macd_cross \
  --enable-macd-loss-protection \
  --macd-max-consecutive-losses 2 \
  --macd-pause-bars 5 \
  --enable-macd-trailing-stop \
  --macd-trailing-stop-pct 0.03 \
  --data-dir data/chinese_etf/daily \
  --optimize
```

#### æ ¸å¿ƒä»·å€¼

1. **å¤æ™®æ¯”ç‡æå‡28.8%**: ä»0.73æå‡è‡³0.94ï¼Œé£é™©è°ƒæ•´åæ”¶ç›Šæ˜¾è‘—æ”¹å–„
2. **æœ€å¤§å›æ’¤é™ä½21.4%**: ä»-20.12%é™è‡³-15.82%ï¼Œä¸‹è¡Œé£é™©å¤§å¹…æ§åˆ¶
3. **ååŒæ•ˆåº”éªŒè¯**: Combined(0.94) > Loss Protection(0.85) + Trailing Stop(0.83)
4. **æ”¶ç›Šç‡ç•¥é™å¯æ¥å—**: -9.4%çš„æ”¶ç›Šä»£ä»·æ¢å–é£é™©å¤§å¹…é™ä½ï¼ŒSharpeæå‡æ˜¾è‘—

#### åœºæ™¯åŒ–å»ºè®®

| æŠ•èµ„è€…ç±»å‹ | æ¨èæ–¹æ¡ˆ | é…ç½®å‚æ•° | æ ¸å¿ƒä¼˜åŠ¿ |
|----------|---------|---------|---------|
| **é£é™©åŒæ¶å‹** | Combined | losses=2, pause=5, trail=3% | æœ€é«˜å¤æ™®0.94ï¼Œæœ€ä½å›æ’¤-15.82% |
| **æ”¶ç›Šä¼˜å…ˆå‹** | Loss Protection | losses=3, pause=20 | æœ€é«˜æ”¶ç›Š83.07%ï¼Œå¤æ™®0.85 |
| **ç®€å•å®ç°å‹** | Trailing Stop | trail=7% | å•å‚æ•°é…ç½®ï¼Œå¤æ™®0.83 |
| **æ¿€è¿›äº¤æ˜“å‹** | Baseline | æ— æ­¢æŸ | é«˜æ”¶ç›Š75.84%ï¼Œä½†é«˜é£é™© |

#### å…³é”®æ´å¯Ÿ

1. **åŒå±‚é˜²æŠ¤æœºåˆ¶ä»·å€¼**: Combinedé€šè¿‡"è¿ç»­äºæŸè¿‡æ»¤"+"ä»·æ ¼å›æ’¤ä¿æŠ¤"å®ç°äº’è¡¥å¢å¼º
2. **å‚æ•°ç¨³å®šæ€§**: Top 5é…ç½®å‡åœ¨trailing_stop_pct=3%ï¼Œæ˜¾ç¤ºè¯¥å‚æ•°çš„é²æ£’æ€§
3. **é£é™©æ”¶ç›Šæƒè¡¡**: æ”¶ç›Šç‡é€‚åº¦ä¸‹é™(-9%)æ¢å–é£é™©å¤§å¹…é™ä½å’ŒSharpeæ˜¾è‘—æå‡
4. **å®æˆ˜å¯è¡Œæ€§**: å‚æ•°ç»„åˆç®€æ´æ˜ç¡®ï¼Œæ˜“äºå®æ–½å’Œç›‘æ§

#### å®éªŒå®Œæ•´æ€§éªŒè¯ âœ…

- âœ… **æ€»æµ‹è¯•æ¬¡æ•°**: 960æ¬¡ï¼ˆ48å‚æ•°ç»„åˆ Ã— 20æ ‡çš„ï¼‰
- âœ… **æˆåŠŸç‡**: 100% (960/960)
- âœ… **æµ‹è¯•å‘¨æœŸ**: 2023-11è‡³2025-11ï¼ˆ2å¹´å®Œæ•´æ•°æ®ï¼‰
- âœ… **å¯è§†åŒ–å›¾è¡¨**: 7å¼ çƒ­åŠ›å›¾ã€å¯¹æ¯”å›¾ã€æ•æ„Ÿæ€§åˆ†æå›¾
- âœ… **è¯¦ç»†æŠ¥å‘Š**: RESULTS.mdï¼ˆå®Œæ•´ç»Ÿè®¡å’Œåˆ†æï¼‰

**å®éªŒçŠ¶æ€**: ğŸ‰ **å…¨éƒ¨å®Œæˆï¼**
