# P0-3 Trend State Mode Fix - å›æµ‹éªŒè¯ç»“æœ

## ä¿®å¤æ—¥æœŸ
2025-12-18

## ä¿®å¤å†…å®¹

### é—®é¢˜æè¿°
åŸæœ‰çš„è¶‹åŠ¿çŠ¶æ€å®šä¹‰åŸºäº"äº¤å‰äº‹ä»¶"ï¼ˆevent-basedï¼‰ï¼š
- Trend ON: å‘ç”Ÿä¹°å…¥äº¤å‰å
- Trend OFF: å‘ç”Ÿå–å‡ºäº¤å‰å
- **å±€é™æ€§**: æ— æ³•æ•æ‰å·²åœ¨è¶‹åŠ¿ä¸­ä½†è¿‘æœŸæ²¡æœ‰äº¤å‰äº‹ä»¶çš„æ ‡çš„

### è§£å†³æ–¹æ¡ˆ
æ–°å¢`trend_state_mode`é…ç½®é€‰é¡¹ï¼Œæ”¯æŒä¸¤ç§æ¨¡å¼ï¼š
1. **eventæ¨¡å¼**ï¼ˆé»˜è®¤ï¼‰: åŸºäºäº¤å‰äº‹ä»¶ï¼Œå‘åå…¼å®¹
2. **conditionæ¨¡å¼**ï¼ˆæ–°å¢ï¼‰: åŸºäºå½“å‰çŠ¶æ€ï¼ˆClose > KAMAï¼‰ï¼Œå®æ—¶åˆ¤æ–­

**ç†è®ºä¼˜åŠ¿**:
- conditionæ¨¡å¼åº”è¯¥èƒ½æ•æ‰æ›´å¤šå¤„äºè¶‹åŠ¿ä¸­çš„æ ‡çš„
- é¢„æœŸæå‡å¹³å‡æŒä»“æ•°å’Œæ”¶ç›Š

### å®ç°ç»†èŠ‚
- **é…ç½®æ–‡ä»¶**: åœ¨`KAMAStrategyConfig`ä¸­æ·»åŠ `trend_state_mode`å­—æ®µ
- **ä»£ç ä½ç½®**: `/mnt/d/git/backtesting/etf_trend_following_v2/src/portfolio_backtest_runner.py`
- **å‡½æ•°**: `_build_trend_state_condition()`ï¼ˆæ–°å¢ï¼‰ã€`_precompute_signals()`ï¼ˆä¿®æ”¹ï¼‰

## å›æµ‹éªŒè¯

### æµ‹è¯•é…ç½®
- **æ ‡çš„æ± **: 50åªETFé™æ€æ± ï¼ˆtrend_etf_pool_2021_2023_50.csvï¼‰
- **ç­–ç•¥**: KAMA Cross + Cluster3é™åˆ¶
- **å›æµ‹æœŸ**: 2024-01-01 ~ 2025-11-30ï¼ˆ23ä¸ªæœˆï¼‰
- **åˆå§‹èµ„é‡‘**: 1,000,000å…ƒ

### å¯¹æ¯”å®éªŒè®¾è®¡
| å®éªŒç»„ | trend_state_mode | é…ç½®æ–‡ä»¶ |
|-------|------------------|----------|
| åŸºå‡†ç»„ï¼ˆEventï¼‰ | event | v2_bull_50etf_cluster3.json |
| å®éªŒç»„ï¼ˆConditionï¼‰ | condition | v2_bull_50etf_cluster3_condition.json |

## å®éªŒç»“æœ

### ç»©æ•ˆæŒ‡æ ‡å¯¹æ¯”

| æŒ‡æ ‡ | Eventæ¨¡å¼ | Conditionæ¨¡å¼ | å·®å¼‚ |
|------|-----------|---------------|------|
| **å¹´åŒ–æ”¶ç›Šç‡** | 23.77% | 23.77% | **0.00%** |
| **å¤æ™®æ¯”ç‡** | 0.77 | 0.77 | **0.00** |
| **æœ€å¤§å›æ’¤** | -20.58% | -20.58% | **0.00%** |
| **æ€»æ”¶ç›Š** | 47.72% | 47.72% | **0.00%** |
| **èƒœç‡** | 48.3% | 48.3% | **0.0pp** |
| **äº¤æ˜“æ¬¡æ•°** | 642 | 642 | **0** |
| **å¹³å‡æŒä»“æ•°** | 4.89 | 4.89 | **0.00** |
| **Sortinoæ¯”ç‡** | 1.43 | 1.43 | **0.00** |
| **Calmaræ¯”ç‡** | 1.15 | 1.15 | **0.00** |
| **æ³¢åŠ¨ç‡** | 26.89% | 26.89% | **0.00%** |

### è¯¦ç»†ç»Ÿè®¡æ•°æ®

```json
Eventæ¨¡å¼:
{
  "total_return": 0.4772,
  "annualized_return": 0.2377,
  "volatility": 0.2689,
  "sharpe_ratio": 0.7725,
  "sortino_ratio": 1.4252,
  "calmar_ratio": 1.1549,
  "max_drawdown": -0.2058,
  "equity_final": 1476072.57,
  "num_trades": 642,
  "win_rate": 0.4829,
  "avg_positions": 4.8853
}

Conditionæ¨¡å¼:
{
  "total_return": 0.4772,
  "annualized_return": 0.2377,
  "volatility": 0.2689,
  "sharpe_ratio": 0.7725,
  "sortino_ratio": 1.4252,
  "calmar_ratio": 1.1549,
  "max_drawdown": -0.2058,
  "equity_final": 1476072.57,
  "num_trades": 642,
  "win_rate": 0.4829,
  "avg_positions": 4.8853
}
```

## å…³é”®å‘ç°

### ğŸ” ç»“æœå®Œå…¨ç›¸åŒ
**æ‰€æœ‰ç»©æ•ˆæŒ‡æ ‡åœ¨å°æ•°ç‚¹å4ä½å†…å®Œå…¨ä¸€è‡´**ï¼ŒåŒ…æ‹¬ï¼š
- æ”¶ç›ŠæŒ‡æ ‡ï¼ˆæ€»æ”¶ç›Šã€å¹´åŒ–æ”¶ç›Šï¼‰
- é£é™©æŒ‡æ ‡ï¼ˆå¤æ™®ã€æœ€å¤§å›æ’¤ã€æ³¢åŠ¨ç‡ï¼‰
- äº¤æ˜“æŒ‡æ ‡ï¼ˆäº¤æ˜“æ¬¡æ•°ã€èƒœç‡ã€å¹³å‡æŒä»“ï¼‰

### ğŸ“Š å¾®è§‚å·®å¼‚åˆ†æ
è™½ç„¶æœ€ç»ˆç»©æ•ˆç›¸åŒï¼Œä½†äº¤æ˜“æ˜ç»†å­˜åœ¨å¾®å°å·®å¼‚ï¼š
- **äº¤æ˜“é¡ºåº**: éƒ¨åˆ†äº¤æ˜“æ—¥çš„ä¹°å–é¡ºåºç•¥æœ‰ä¸åŒ
- **æŒä»“æ–‡ä»¶**: `positions.csv`æ–‡ä»¶ä¸å®Œå…¨ç›¸åŒï¼ˆ`pos_c.equals(pos_e) = False`ï¼‰
- **äº¤æ˜“æ–‡ä»¶**: `trades.csv`æ–‡ä»¶ä¸å®Œå…¨ç›¸åŒï¼ˆé¦–ä¸ªå·®å¼‚å‡ºç°åœ¨ç¬¬9è¡Œï¼‰

**ç¤ºä¾‹å·®å¼‚**ï¼ˆ2024-01-03å–å‡ºé¡ºåºï¼‰:
```
Conditionæ¨¡å¼: 159622.SZ â†’ 159506.SZ
Eventæ¨¡å¼:     159506.SZ â†’ 159622.SZ
```

### ğŸ¤” ä¸ºä½•ç»“æœç›¸åŒï¼Ÿ

#### ç†è®ºæµ‹è¯•ï¼šä¸¤ç§æ–¹æ³•ç¡®å®ä¸åŒ
ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•ï¼Œä¸¤ç§æ–¹æ³•åœ¨30%çš„äº¤æ˜“æ—¥äº§ç”Ÿä¸åŒçš„è¶‹åŠ¿çŠ¶æ€ï¼š
```python
# æ¨¡æ‹Ÿ20å¤©æ•°æ®
Event-based trend state:     [0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,1,1,1,1,1]
Condition-based trend state: [0,0,0,1,1,1,1,1,0,0,0,0,0,1,1,1,1,1,1,1]
Difference: 6/20 days (30%)
```

#### å®è·µç»“æœï¼šå¯¹æœ€ç»ˆç»©æ•ˆæ— å½±å“
å¯èƒ½çš„åŸå› ï¼š
1. **Portfolioå±‚é¢å¹³æ»‘**: TopNé€‰æ‹©ã€Clusteré™åˆ¶ã€æƒ¯æ€§åŠ åˆ†ç­‰æœºåˆ¶å·²ç»å……åˆ†å¹³æ»‘äº†åº•å±‚ä¿¡å·å·®å¼‚
2. **KAMAè‡ªé€‚åº”ç‰¹æ€§**: KAMAæœ¬èº«çš„è‡ªé€‚åº”ç®—æ³•å·²ç»éšå«äº†condition-basedçš„è¶‹åŠ¿åˆ¤æ–­
3. **ä¹°å…¥ä¿¡å·ä¸»å¯¼**: ä¹°å…¥å†³ç­–ï¼ˆ`signal_buy`ï¼‰å·²ç»æ£€æŸ¥äº†Close > KAMAæ¡ä»¶ï¼Œå–å‡ºä¾§çš„å·®å¼‚è¢«åç»­æœºåˆ¶å¸æ”¶
4. **æ ·æœ¬æœŸç‰¹æ€§**: 2024-2025å¹´çš„å¸‚åœºç¯å¢ƒä¸‹ï¼Œä¸¤ç§æ–¹æ³•æ°å¥½äº§ç”Ÿäº†ç›¸ä¼¼çš„ç»„åˆæŒä»“

## ç»“è®ºä¸å»ºè®®

### âœ… å®ç°éªŒè¯
- **ä»£ç å®ç°**: âœ… æ­£ç¡®ï¼Œæ—¥å¿—ç¡®è®¤`trend_state_mode`è¢«æ­£ç¡®åº”ç”¨
- **é…ç½®åŠ è½½**: âœ… æ­£ç¡®ï¼Œä¸¤ç»„å®éªŒä½¿ç”¨äº†ä¸åŒçš„æ¨¡å¼
- **å‘åå…¼å®¹**: âœ… å®Œæ•´ï¼Œé»˜è®¤eventæ¨¡å¼ä¿æŒåŸæœ‰è¡Œä¸º

### ğŸ“Š P0-3ä¿®å¤æ•ˆæœè¯„ä¼°
**ç»“è®º**: **ä¿®å¤æœªå¸¦æ¥é¢„æœŸçš„ç»©æ•ˆæå‡**

| é¢„æœŸ | å®é™… | è¯„ä¼° |
|------|------|------|
| æå‡å¹³å‡æŒä»“æ•° | 4.89 â†’ 4.89 (0%) | âŒ æœªå®ç° |
| æå‡æ€»æ”¶ç›Š | 47.72% â†’ 47.72% (0%) | âŒ æœªå®ç° |
| æå‡å¤æ™®æ¯”ç‡ | 0.77 â†’ 0.77 (0%) | âŒ æœªå®ç° |

### ğŸ¯ æ¨èé…ç½®
**å»ºè®®ç»§ç»­ä½¿ç”¨é»˜è®¤çš„`event`æ¨¡å¼**ï¼Œç†ç”±ï¼š
1. **æ€§èƒ½ç­‰æ•ˆ**: conditionæ¨¡å¼æœªå¸¦æ¥é¢å¤–æ”¶ç›Š
2. **è®¡ç®—ç®€æ´**: eventæ¨¡å¼é€»è¾‘æ›´ç®€å•ï¼Œè®¡ç®—å¼€é”€æ›´å°
3. **å‘åå…¼å®¹**: ä¸å†å²å›æµ‹ç»“æœä¿æŒä¸€è‡´

### ğŸ’¡ åç»­ä¼˜åŒ–æ–¹å‘
P0-3ä¿®å¤è™½æœªæå‡ç»©æ•ˆï¼Œä½†æ­ç¤ºäº†å…³é”®æ´å¯Ÿï¼š
1. **Portfolioå±‚æœºåˆ¶æœ‰æ•ˆ**: TopN+Buffer+Clusterå·²å……åˆ†ä¼˜åŒ–æŒä»“é€‰æ‹©
2. **ä¼˜åŒ–ç©ºé—´**: åº”å…³æ³¨ä¸Šå±‚ç»„åˆç®¡ç†é€»è¾‘ï¼ˆè¯„åˆ†æƒé‡ã€Clusteré™åˆ¶ç­‰ï¼‰ï¼Œè€Œéåº•å±‚ä¿¡å·ç”Ÿæˆ
3. **å¸‚åœºé€‚åº”æ€§**: å¯åœ¨ä¸åŒå¸‚åœºç¯å¢ƒï¼ˆç†Šå¸‚ã€éœ‡è¡å¸‚ï¼‰æµ‹è¯•conditionæ¨¡å¼æ˜¯å¦æœ‰å·®å¼‚

## æŠ€æœ¯ç»†èŠ‚

### ä¿®æ”¹æ–‡ä»¶æ¸…å•
1. `etf_trend_following_v2/src/config_loader.py`
   - æ–°å¢`trend_state_mode`å­—æ®µåˆ°`KAMAStrategyConfig`

2. `etf_trend_following_v2/src/portfolio_backtest_runner.py`
   - æ–°å¢`_build_trend_state_condition()`å‡½æ•°
   - ä¿®æ”¹`_precompute_signals()`æ–¹æ³•æ”¯æŒmodeé€‰æ‹©

3. `experiment/etf/v2_vs_v1_comparison/configs/tuning/v2_bull_50etf_cluster3_condition.json`
   - æ–°å¢é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ `"trend_state_mode": "condition"`

### æµ‹è¯•è„šæœ¬
- `experiment/etf/v2_vs_v1_comparison/scripts/run_v2_static_50etf_p03_event.py`
- `experiment/etf/v2_vs_v1_comparison/scripts/run_v2_static_50etf_p03_condition.py`

### è¾“å‡ºç›®å½•
- `results/v2_50etf_cluster3_p03_event/` - Eventæ¨¡å¼ç»“æœ
- `results/v2_50etf_cluster3_p03_condition/` - Conditionæ¨¡å¼ç»“æœ

## é™„å½•ï¼šé…ç½®å·®å¼‚

```json
// Eventæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
{
  "strategies": [
    {
      "type": "kama",
      // trend_state_modeæœªæŒ‡å®šï¼Œé»˜è®¤ä¸º"event"
      "kama_period": 20,
      ...
    }
  ]
}

// Conditionæ¨¡å¼ï¼ˆæ–°å¢ï¼‰
{
  "strategies": [
    {
      "type": "kama",
      "trend_state_mode": "condition",  // å”¯ä¸€å·®å¼‚
      "kama_period": 20,
      ...
    }
  ]
}
```

## ç›¸å…³æ–‡æ¡£
- P0-3éœ€æ±‚æ–‡æ¡£: `requirement_docs/P03_trend_state_mode_fix.md`ï¼ˆå¾…åˆ›å»ºï¼‰
- å•å…ƒæµ‹è¯•è„šæœ¬: `etf_trend_following_v2/test_trend_state_mode.py`
- V2è°ƒä¼˜å®éªŒ: `experiment/etf/v2_vs_v1_comparison/V2_TUNING_EXPERIMENT_DESIGN.md`

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-12-18
**å®éªŒæ‰§è¡Œäºº**: Claude Code
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸
