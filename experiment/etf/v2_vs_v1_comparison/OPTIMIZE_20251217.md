# V2框架优化建议

**文档日期**: 2025-12-17
**更新日期**: 2025-12-20（添加P0-2/P0-3实验验证结果）

---

## 问题

V2很难比V1强很多的本质原因，不在于TopN/聚类这些组合层"想法不对"，而在于三件事叠加：

1. V1的聚合口径偏"不可实现"（等价于同时满仓20只）；
2. V2长期低仓位（牛市基准平均杠杆≈0.43，50ETF+cluster3也≈0.51）；
3. V2换手极高且持有期极短（年化换手~80–90x、平均持有~8–10天），导致趋势跟踪最关键的"吃到少数大趋势"被排名轮动/频繁出入场稀释。

下面按优先级给出后续优化建议（偏"能落地、能验证"）。

---

## P0（先做，不然结论会被口径/bug污染）

- **P0-1**: 把对比口径拉到同一"可实现"约束：给V1也加上max_positions/topN/资金约束/成本/执行时点，否则"V1更强"大概率是口径红利，不是策略红利。

- **P0-2**: ~~修正动态池流动性阈值单位一致性~~
  - ✅ **已实现**: 添加`liquidity_unit`配置字段（"raw"/"tushare"）
  - ⚠️ **实验结论**: 技术修复正确，但效果**严重恶化**（年化收益-15.86%）
  - 📝 **原因**: 修复前的"bug"意外让低流动性但趋势好的ETF进入池子，阈值需要重新标定
  - 📄 **详见**: [P0_FIXES_EXPERIMENT_SUMMARY.md](./P0_FIXES_EXPERIMENT_SUMMARY.md)

- **P0-3**: ~~修正"趋势状态"定义~~
  - ✅ **已实现**: 添加`trend_state_mode`配置字段（"event"/"condition"）
  - ⚪ **实验结论**: 修复**无效果**，所有指标完全一致
  - 📝 **原因**: V2组合层管理已充分平滑底层信号差异
  - 📄 **详见**: [P0_FIXES_EXPERIMENT_SUMMARY.md](./P0_FIXES_EXPERIMENT_SUMMARY.md)

---

## P1（对提升收益最直接：提高有效仓位 + 降低无效换手）

- 从"排名驱动卖出"转为"趋势/止损驱动卖出"：把排名更多用于"买入/加仓/补位"，卖出优先用trend_off/ATR/时间止损；否则你会在大趋势里因为排名回落而过早下车，持有期自然被压到个位数天。

- 显式做"成本感知的换仓门槛"：仅当新标的相对当前持仓的分数优势 >（预估交易成本 + 一定安全垫）才允许替换；或把inertia_bonus从5%提高并改为"与成本/滑点挂钩"的动态惩罚。

- 降低再平衡频率/引入"仅在必要时换仓"：当前rebalance_frequency=5在A股ETF上很容易把系统推成"快节奏轮动"，与趋势跟踪的长持有逻辑冲突；优先测试10/20日、或"只有当跌出更宽的缓冲带且持续N次才换"。

- 解决低仓位问题（否则牛市很难打赢）：现在normalize_positions()在总权重<上限时会直接留现金，导致长期半仓。两条路二选一：
  - 组合层做"目标组合波动/目标总仓位"的二次缩放（在不超过max_total_exposure前提下尽量用满仓位）；或
  - 把现金分配到"现金代理"（如货币/短债ETF）作为基准持仓，让系统在"无趋势权益仓位"时仍有可比收益。

---

## P2（提升信号质量：减少噪声交易、延长持有期、提高尾部捕捉）

- 增强趋势Gatekeeper，不要只靠KAMA交叉裸信号：优先启用你已经实现但实验中关闭的过滤（ER/斜率确认/ADX），目标是把平均持有期从~10天推到"数周~数月"。

- 把"静态50ETF成功经验"产品化：动态池不是非做不可；更现实的路线是"宽基候选池（100–300只高流动性）+ 趋势质量预筛（ADX/一致性/效率）→ 再做TopN+聚类"。这比"全市场+仅流动性"更接近CTA里常用的"可交易宇宙"概念，也更符合你实验里静态池明显更优的结论。

---

## P3（结构性改进：稳健性与工程化）

- 聚类与分散约束做稳定化：在A股ETF高相关环境下，聚类切割阈值/窗口会显著影响"同涨同跌"风险；优先做参数稳定性测试（窗口60/120、阈值0.5/0.6、每簇上限2/3/4）。

- 把换手、仓位、卖出原因做成一等公民指标：每次回测输出平均杠杆/空仓天数/换手分解（rank_out vs trend_off vs stop）/最大单簇暴露，否则很难定位"收益打不过V1"到底是"仓位不足"还是"过度轮动"。

---

## 建议的验证顺序（强烈按这个做，能最快找到增益来源）

1. 先跑齐：50ETF+cluster3在熊市(2022–2023)与全周期（你文档里标了待执行），再谈"V2能否更稳健胜出"。

2. 做三组A/B"归因"回测（每组只改一个旋钮）：
   - A/B1：保持TopN不变，关闭排名卖出（仅趋势/止损卖出）看持有期、换手、CAGR变化；
   - A/B2：保持信号不变，把总仓位用满/引入现金代理看牛市CAGR能否补齐；
   - A/B3：修正动态池阈值单位后重跑，看动态池是否仍"必败"（⚠️ **已验证，结果更差，需重新标定阈值**）

---

## P0修复实验验证总结（2025-12-20）

### 已实现的开关配置

**liquidity_unit（P0-2）**
```json
{
  "universe": {
    "liquidity_unit": "raw"  // 默认，或 "tushare"
  }
}
```

**trend_state_mode（P0-3）**
```json
{
  "strategies": [
    {
      "type": "kama",
      "trend_state_mode": "event"  // 默认，或 "condition"
    }
  ]
}
```

### 实验结论

| 修复项 | 技术实现 | 效果验证 | 推荐状态 |
|--------|----------|----------|----------|
| **P0-2** | ✅ 正确 | ❌ 严重恶化 | 需重新标定阈值 |
| **P0-3** | ✅ 正确 | ⚪ 无效果 | 保持默认配置 |

### 关键洞察

1. **P0-2揭示深层问题**：动态池的流动性阈值需要**实验标定**，而非简单的单位修复。当前500万/50万可能过于严格。

2. **P0-3证明V2健壮性**：组合层管理足够强大，能吸收底层信号变化。优化方向应聚焦P1（仓位管理、换手控制）。

### 详细报告

- [P0修复实验完整总结](./P0_FIXES_EXPERIMENT_SUMMARY.md)
- [P0-2详细分析](./OPTIMIZE_20251217_P02_FIX_ANALYSIS.md)
- [P0-3详细分析](./P03_TREND_STATE_MODE_FIX_RESULTS.md)

---

**最后更新**: 2025-12-20
